<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>my soul your beats</title>
  <icon>https://www.gravatar.com/avatar/1e310ed28c529de1852f3d888b397760</icon>
  <subtitle>mzeht</subtitle>
  <link href="/atom.xml" rel="self"/>
  
  <link href="http://mzeht.com/"/>
  <updated>2019-04-30T22:18:27.077Z</updated>
  <id>http://mzeht.com/</id>
  
  <author>
    <name>mzeht</name>
    <email>mzeht@outlook.com</email>
  </author>
  
  <generator uri="http://hexo.io/">Hexo</generator>
  
  <entry>
    <title>测试文章</title>
    <link href="http://mzeht.com/2019/05/01/%E6%B5%8B%E8%AF%95%E6%96%87%E7%AB%A0/"/>
    <id>http://mzeht.com/2019/05/01/测试文章/</id>
    <published>2019-04-30T21:57:23.000Z</published>
    <updated>2019-04-30T22:18:27.077Z</updated>
    
    <content type="html"><![CDATA[<p><img src="/uploads/15304601545484.jpg" alt="15304601545484"></p><p><img src="/uploads/a7691515_s.jpg" alt="a7691515_s"></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;&lt;img src=&quot;/uploads/15304601545484.jpg&quot; alt=&quot;15304601545484&quot;&gt;&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;/uploads/a7691515_s.jpg&quot; alt=&quot;a7691515_s&quot;&gt;&lt;/p&gt;

      
    
    </summary>
    
      <category term="技术" scheme="http://mzeht.com/categories/%E6%8A%80%E6%9C%AF/"/>
    
    
  </entry>
  
  <entry>
    <title>springboot</title>
    <link href="http://mzeht.com/2017/11/01/2017-11-07/"/>
    <id>http://mzeht.com/2017/11/01/2017-11-07/</id>
    <published>2017-11-01T04:55:49.000Z</published>
    <updated>2019-04-30T20:33:51.256Z</updated>
    
    <summary type="html">
    
    </summary>
    
      <category term="后端开发" scheme="http://mzeht.com/categories/bg/"/>
    
      <category term="java" scheme="http://mzeht.com/categories/bg/java/"/>
    
    
      <category term="springboot" scheme="http://mzeht.com/tags/springboot/"/>
    
  </entry>
  
  <entry>
    <title>r2*r2组合自定义异常处理</title>
    <link href="http://mzeht.com/2017/06/01/r2-r2%E7%BB%84%E5%90%88%E8%87%AA%E5%AE%9A%E4%B9%89%E5%BC%82%E5%B8%B8%E5%A4%84%E7%90%86/"/>
    <id>http://mzeht.com/2017/06/01/r2-r2组合自定义异常处理/</id>
    <published>2017-06-01T04:55:49.000Z</published>
    <updated>2019-05-12T19:50:02.363Z</updated>
    
    <content type="html"><![CDATA[<h2 id="处理前"><a href="#处理前" class="headerlink" title="处理前"></a>处理前</h2><p>使用r2+r2组合 以下代码很常见</p><p>只有返回的数据能解析成即有格式时 会走<code>onNext</code> 我们往往还要进一步判断<br>常见的是判断成功／失败的标志字段</p><p>对于<code>onError</code> 我们一般都是弹出提示</p><p>如果服务端返还格式不规范也不会走<code>onNext</code></p><p>异常处理我们显得很无力</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">ApiManager.getApi().XXXXXXX(ObjectHelper.toMap(quickDeliverDTO))</span><br><span class="line">                .compose(<span class="keyword">this</span>.bindToLifecycle())</span><br><span class="line">                .subscribeOn(Schedulers.io())</span><br><span class="line">                .observeOn(AndroidSchedulers.mainThread())</span><br><span class="line">                .subscribe(<span class="keyword">new</span> Observer&lt;ApiResult&lt;String&gt;&gt;() &#123;</span><br><span class="line">                    <span class="meta">@Override</span></span><br><span class="line">                    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onComplete</span><span class="params">()</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    <span class="meta">@Override</span></span><br><span class="line">                    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onError</span><span class="params">(Throwable e)</span> </span>&#123;</span><br><span class="line">                        </span><br><span class="line"></span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    <span class="meta">@Override</span></span><br><span class="line">                    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onSubscribe</span><span class="params">(@NonNull Disposable d)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    <span class="meta">@Override</span></span><br><span class="line">                    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onNext</span><span class="params">(ApiResult&lt;String&gt; stringApiResult)</span> </span>&#123;</span><br><span class="line">                       </span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;);</span><br></pre></td></tr></table></figure><h2 id="我们希望可以。。。"><a href="#我们希望可以。。。" class="headerlink" title="我们希望可以。。。"></a>我们希望可以。。。</h2><p>1.自定义错误处理<br>2.成功／失败标志不要手动判断 成功走单独回调<br>3.失败时 默认方法提示错误，不用每次手写弹窗<br>4.没有网络连接时，不发起请求，走失败回调<br>5.保留原有回调 应对特殊情况</p><h2 id="自定义Converter-捕获异常"><a href="#自定义Converter-捕获异常" class="headerlink" title="自定义Converter 捕获异常"></a>自定义Converter 捕获异常</h2><p>CustomGsonResponseBodyConverter<br><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">CustomGsonResponseBodyConverter</span>&lt;<span class="title">T</span>&gt; <span class="keyword">implements</span> <span class="title">Converter</span>&lt;<span class="title">ResponseBody</span>, <span class="title">T</span>&gt; &#123;</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Gson gson;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> TypeAdapter&lt;T&gt; adapter;</span><br><span class="line"></span><br><span class="line">    CustomGsonResponseBodyConverter(Gson gson, TypeAdapter&lt;T&gt; adapter) &#123;</span><br><span class="line">        <span class="keyword">this</span>.gson = gson;</span><br><span class="line">        <span class="keyword">this</span>.adapter = adapter;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> T convert(ResponseBody value) <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        String response = value.string();</span><br><span class="line">        HttpStatus httpStatus = gson.fromJson(response, HttpStatus.<span class="keyword">class</span>);</span><br><span class="line">        <span class="keyword">if</span> (!httpStatus.isSuccess()) &#123;</span><br><span class="line">            value.close();</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> ApiException(httpStatus.getCode(), httpStatus.getMessage());</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        MediaType contentType = value.contentType();</span><br><span class="line">        Charset charset = contentType != <span class="literal">null</span> ? contentType.charset(UTF_8) : UTF_8;</span><br><span class="line">        InputStream inputStream = <span class="keyword">new</span> ByteArrayInputStream(response.getBytes());</span><br><span class="line">        Reader reader = <span class="keyword">new</span> InputStreamReader(inputStream, charset);</span><br><span class="line">        JsonReader jsonReader = gson.newJsonReader(reader);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> adapter.read(jsonReader);</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            value.close();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>CustomGsonRequestBodyConverter</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">CustomGsonRequestBodyConverter</span>&lt;<span class="title">T</span>&gt; <span class="keyword">implements</span> <span class="title">Converter</span>&lt;<span class="title">T</span>, <span class="title">RequestBody</span>&gt; </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> MediaType MEDIA_TYPE = MediaType.parse(<span class="string">"application/json; charset=UTF-8"</span>);</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Charset UTF_8 = Charset.forName(<span class="string">"UTF-8"</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Gson gson;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> TypeAdapter&lt;T&gt; adapter;</span><br><span class="line"></span><br><span class="line">    CustomGsonRequestBodyConverter(Gson gson, TypeAdapter&lt;T&gt; adapter) &#123;</span><br><span class="line">        <span class="keyword">this</span>.gson = gson;</span><br><span class="line">        <span class="keyword">this</span>.adapter = adapter;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> RequestBody <span class="title">convert</span><span class="params">(T value)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        Buffer buffer = <span class="keyword">new</span> Buffer();</span><br><span class="line">        Writer writer = <span class="keyword">new</span> OutputStreamWriter(buffer.outputStream(), UTF_8);</span><br><span class="line">        JsonWriter jsonWriter = gson.newJsonWriter(writer);</span><br><span class="line">        adapter.write(jsonWriter, value);</span><br><span class="line">        jsonWriter.close();</span><br><span class="line">        <span class="keyword">return</span> RequestBody.create(MEDIA_TYPE, buffer.readByteString());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>CustomGsonResponseBodyConverter</p><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">CustomGsonResponseBodyConverter</span>&lt;<span class="title">T</span>&gt; <span class="keyword">implements</span> <span class="title">Converter</span>&lt;<span class="title">ResponseBody</span>, <span class="title">T</span>&gt; &#123;</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Gson gson;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> TypeAdapter&lt;T&gt; adapter;</span><br><span class="line"></span><br><span class="line">    CustomGsonResponseBodyConverter(Gson gson, TypeAdapter&lt;T&gt; adapter) &#123;</span><br><span class="line">        <span class="keyword">this</span>.gson = gson;</span><br><span class="line">        <span class="keyword">this</span>.adapter = adapter;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> T convert(ResponseBody value) <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        String response = value.string();</span><br><span class="line">        HttpStatus httpStatus = gson.fromJson(response, HttpStatus.<span class="keyword">class</span>);</span><br><span class="line">        <span class="keyword">if</span> (!httpStatus.isSuccess()) &#123;</span><br><span class="line">            value.close();</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> ApiException(httpStatus.getCode(), httpStatus.getMessage());</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        MediaType contentType = value.contentType();</span><br><span class="line">        Charset charset = contentType != <span class="literal">null</span> ? contentType.charset(UTF_8) : UTF_8;</span><br><span class="line">        InputStream inputStream = <span class="keyword">new</span> ByteArrayInputStream(response.getBytes());</span><br><span class="line">        Reader reader = <span class="keyword">new</span> InputStreamReader(inputStream, charset);</span><br><span class="line">        JsonReader jsonReader = gson.newJsonReader(reader);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> adapter.read(jsonReader);</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            value.close();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="其他相关类"><a href="#其他相关类" class="headerlink" title="其他相关类"></a>其他相关类</h3><p><code>HttpStatus.java</code><br>对应接口异常时的返回，不关心返回数据的解析，只解析code，message</p><p>如</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HttpStatus</span> </span>&#123;</span><br><span class="line">    <span class="meta">@SerializedName</span>(<span class="string">"resultCode"</span>)</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> mCode;</span><br><span class="line">    <span class="meta">@SerializedName</span>(<span class="string">"resultMsg"</span>)</span><br><span class="line">    <span class="keyword">private</span> String mMessage;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getCode</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> mCode;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getMessage</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> mMessage;</span><br><span class="line">    &#125;</span><br><span class="line">   </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>ApiException.java</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ApiException</span>  <span class="keyword">extends</span> <span class="title">RuntimeException</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> mErrorCode;</span><br><span class="line">    <span class="keyword">private</span> String errorMessage;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getErrorMessage</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> errorMessage;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setErrorMessage</span><span class="params">(String errorMessage)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.errorMessage = errorMessage;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getErrorCode</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> mErrorCode;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setErrorCode</span><span class="params">(<span class="keyword">int</span> errorCode)</span> </span>&#123;</span><br><span class="line">        mErrorCode = errorCode;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ApiException</span><span class="params">(<span class="keyword">int</span> errorCode, String errorMessage)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(errorMessage);</span><br><span class="line">        <span class="keyword">this</span>.mErrorCode = errorCode;</span><br><span class="line">        <span class="keyword">this</span>.errorMessage = errorMessage;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="自定义-Observer"><a href="#自定义-Observer" class="headerlink" title="自定义 Observer"></a>自定义 Observer</h2><p>实现常用处理 免去复写</p><p>DisposableObserver 实现</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">BaseDisposableObserver</span>&lt;<span class="title">T</span>&gt; <span class="keyword">extends</span> <span class="title">DisposableObserver</span>&lt;<span class="title">ApiResult</span>&lt;<span class="title">T</span>&gt;&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">int</span> RESPONSE_CODE_OK = <span class="number">1</span>;       <span class="comment">//自定义的业务逻辑，成功</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">int</span> RESPONSE_CODE_FAILED = <span class="number">2</span>;  <span class="comment">//返回数据失败,严重的错误</span></span><br><span class="line">    <span class="keyword">private</span> Context mContext;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Gson gson = <span class="keyword">new</span> Gson();</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> errorCode;</span><br><span class="line">    <span class="keyword">private</span> String errorMsg = <span class="string">"未知的错误！"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">BaseDisposableObserver</span><span class="params">(Context context)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.mContext = context;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onStart</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (!NetworkUtils.isConnected()) &#123;</span><br><span class="line">            errorCode = RESPONSE_CODE_FAILED;</span><br><span class="line">            errorMsg = <span class="string">"没有网络，请检查网络连接"</span>;</span><br><span class="line">            onFailure(errorCode,errorMsg);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title">onSuccess</span><span class="params">(T t)</span></span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onNext</span><span class="params">(@NonNull ApiResult&lt;T&gt; response)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (response.getResultCode() == RESPONSE_CODE_OK) &#123;</span><br><span class="line">            onSuccess(response.getObject());</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            onFailure(response.getResultCode(), response.getResultMsg());</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onError</span><span class="params">(@NonNull Throwable t)</span> </span>&#123;</span><br><span class="line">        L.d(t.getMessage());</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (t <span class="keyword">instanceof</span> HttpException) &#123;</span><br><span class="line">            HttpException httpException = (HttpException) t;</span><br><span class="line">            errorCode = httpException.code();</span><br><span class="line">            errorMsg = httpException.getMessage();</span><br><span class="line">            getErrorMsg(httpException);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (t <span class="keyword">instanceof</span> ApiException) &#123;</span><br><span class="line">            ApiException exception = (ApiException) t;</span><br><span class="line">            errorCode = exception.getErrorCode();</span><br><span class="line">            errorMsg = exception.getErrorMessage();</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (t <span class="keyword">instanceof</span> SocketTimeoutException) &#123;  <span class="comment">//VPN open</span></span><br><span class="line">            errorCode = RESPONSE_CODE_FAILED;</span><br><span class="line">            errorMsg = <span class="string">"服务器响应超时"</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (t <span class="keyword">instanceof</span> ConnectException) &#123;</span><br><span class="line">            errorCode = RESPONSE_CODE_FAILED;</span><br><span class="line">            errorMsg = <span class="string">"网络连接异常，请检查网络"</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (t <span class="keyword">instanceof</span> RuntimeException) &#123;</span><br><span class="line">            errorCode = RESPONSE_CODE_FAILED;</span><br><span class="line">            errorMsg = <span class="string">"运行时错误"</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (t <span class="keyword">instanceof</span> UnknownHostException) &#123;</span><br><span class="line">            errorCode = RESPONSE_CODE_FAILED;</span><br><span class="line">            errorMsg = <span class="string">"无法解析主机，请检查网络连接"</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (t <span class="keyword">instanceof</span> UnknownServiceException) &#123;</span><br><span class="line">            errorCode = RESPONSE_CODE_FAILED;</span><br><span class="line">            errorMsg = <span class="string">"未知的服务器错误"</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (t <span class="keyword">instanceof</span> IOException) &#123;  <span class="comment">//飞行模式等</span></span><br><span class="line">            errorCode = RESPONSE_CODE_FAILED;</span><br><span class="line">            errorMsg = <span class="string">"没有网络，请检查网络连接"</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        onFailure(errorCode, errorMsg);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@CallSuper</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onFailure</span><span class="params">(<span class="keyword">int</span> code, String message)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">switch</span> (code) &#123;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">case</span> <span class="number">4</span>:</span><br><span class="line">                <span class="comment">//退回到登录页面</span></span><br><span class="line">                Intent intent = <span class="keyword">new</span> Intent();</span><br><span class="line">                intent.setClass(mContext, LoginActivity.class);</span><br><span class="line">                mContext.startActivity(intent);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        Toast.makeText(mContext, message + <span class="string">"   code="</span> + code, Toast.LENGTH_SHORT).show();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">getErrorMsg</span><span class="params">(HttpException httpException)</span> </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onComplete</span><span class="params">()</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Observer 实现也类似</p><figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">public abstract <span class="class"><span class="keyword">class</span> <span class="title">BaseObserver</span> &lt;T&gt; <span class="title">implements</span> <span class="title">Observer</span>&lt;ApiResult&lt;T&gt;&gt; &#123;</span></span><br><span class="line"></span><br><span class="line">.....</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="代码使用"><a href="#代码使用" class="headerlink" title="代码使用"></a>代码使用</h2><figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">ApiManager</span><span class="selector-class">.getSmartApi</span>()<span class="selector-class">.login</span>(mNameEdit.getText().toString(), mPassEdit.getText().toString())</span><br><span class="line">               <span class="selector-class">.compose</span>(this.bindToLifecycle())</span><br><span class="line">               <span class="selector-class">.subscribeOn</span>(Schedulers.io())</span><br><span class="line">               <span class="selector-class">.observeOn</span>(AndroidSchedulers.mainThread())</span><br><span class="line">               <span class="selector-class">.subscribe</span>(new BaseDisposableObserver&lt;String&gt;(getActivity()) &#123;</span><br><span class="line">                   <span class="variable">@Override</span></span><br><span class="line">                   public void onSuccess(String s) &#123;</span><br><span class="line">                       <span class="selector-tag">startActivity</span>(new Intent(getActivity(),MainActivity.class));</span><br><span class="line">                       <span class="selector-tag">BasePreference</span><span class="selector-class">.getInstance</span>()<span class="selector-class">.saveToken</span>(s);</span><br><span class="line">                   &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">               &#125;) ;</span><br></pre></td></tr></table></figure><p>1.没网络时 不请求直接<code>onFailure</code></p><p>2.数据解析成功且标志位置成功时 <code>onSuccess</code></p><p>3.其他走<code>onFailure</code> </p><p><code>onFailure</code>默认弹出提示框提示错误代码 错误信息<br>token失效时返回登录页面</p><p>最重要的是默认<code>onFailure</code>处理都不用另写了！</p><p>当然也可以子类实现 不用默认处理 Observer的默认回调都在</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;处理前&quot;&gt;&lt;a href=&quot;#处理前&quot; class=&quot;headerlink&quot; title=&quot;处理前&quot;&gt;&lt;/a&gt;处理前&lt;/h2&gt;&lt;p&gt;使用r2+r2组合 以下代码很常见&lt;/p&gt;
&lt;p&gt;只有返回的数据能解析成即有格式时 会走&lt;code&gt;onNext&lt;/code&gt; 我们
      
    
    </summary>
    
      <category term="技术" scheme="http://mzeht.com/categories/%E6%8A%80%E6%9C%AF/"/>
    
    
  </entry>
  
  <entry>
    <title>retrofit2 使用拦截器添加header，打印日志</title>
    <link href="http://mzeht.com/2017/06/01/retrofit2-%E4%BD%BF%E7%94%A8%E6%8B%A6%E6%88%AA%E5%99%A8%E6%B7%BB%E5%8A%A0header%EF%BC%8C%E6%89%93%E5%8D%B0%E6%97%A5%E5%BF%97/"/>
    <id>http://mzeht.com/2017/06/01/retrofit2-使用拦截器添加header，打印日志/</id>
    <published>2017-06-01T04:47:47.000Z</published>
    <updated>2019-04-30T20:33:51.264Z</updated>
    
    <content type="html"><![CDATA[<p>开发中可能遇到有的接口需要header传递一些信息，几个还好，可以用@header注解手动添加</p><p>如果每个接口都需要，一个个写header就很傻了，可以使用retrofit2的拦截器做到</p><h2 id="常用配置"><a href="#常用配置" class="headerlink" title="常用配置"></a>常用配置</h2><figure class="highlight armasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">OkHttpClient.Builder</span> <span class="keyword">builder </span>= new OkHttpClient.<span class="keyword">Builder();</span></span><br><span class="line"><span class="keyword"></span></span><br><span class="line"><span class="keyword"></span></span><br><span class="line"><span class="keyword"> </span>       <span class="keyword">builder.connectTimeout(5, </span>TimeUnit.SECONDS)</span><br><span class="line">                .writeTimeout(<span class="number">5</span>, TimeUnit.SECONDS)</span><br><span class="line">                .readTimeout(<span class="number">5</span>,TimeUnit.SECONDS)</span><br><span class="line">                .<span class="keyword">addNetworkInterceptor(new </span>StethoInterceptor())</span><br><span class="line">        .<span class="keyword">addInterceptor(new </span>Interceptor() &#123;</span><br><span class="line">            <span class="comment">@Override</span></span><br><span class="line">            public Response intercept(Chain chain) throws IOException &#123;</span><br><span class="line">                L.d(<span class="string">"Interceptor"</span>)<span class="comment">;</span></span><br><span class="line"></span><br><span class="line">                // Request customization: <span class="keyword">add </span>request headers</span><br><span class="line">                <span class="keyword">String </span>Nonce = <span class="keyword">String.valueOf(System.currentTimeMillis());</span></span><br><span class="line"><span class="keyword"> </span>               <span class="keyword">String </span>CheckSum = EncryptUtils.encryptSHA1ToString(<span class="string">"DA3B979ABB5A4FC0B65382BC1A344A84"</span>+Nonce)<span class="comment">;</span></span><br><span class="line">                Request.<span class="keyword">Builder </span>requestBuilder = chain.request().newBuilder()</span><br><span class="line">                        .<span class="keyword">addHeader("AppKey", </span><span class="string">"10000001"</span>)</span><br><span class="line">                        .<span class="keyword">addHeader("Nonce", </span>Nonce)</span><br><span class="line">                        .<span class="keyword">addHeader("CheckSum", </span>CheckSum)</span><br><span class="line">                        .<span class="keyword">addHeader("x-session-token", </span><span class="keyword">BasePreference.getInstance().getToken())</span></span><br><span class="line"><span class="keyword"> </span>                       .<span class="keyword">addHeader("AppSecret", </span><span class="string">"XXXXXXXXXXXXXXXXXXXXXXXXXXXXX"</span>)<span class="comment">;</span></span><br><span class="line"></span><br><span class="line">                Request request = requestBuilder.<span class="keyword">build();</span></span><br><span class="line"><span class="keyword"> </span>               return chain.proceed(request)<span class="comment">;</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;)<span class="comment">;</span></span><br><span class="line">        <span class="meta">if</span> (<span class="keyword">BuildConfig.DEBUG) </span>&#123;</span><br><span class="line">            // Log信息拦截器</span><br><span class="line">            HttpLoggingInterceptor loggingInterceptor = new HttpLoggingInterceptor()<span class="comment">;</span></span><br><span class="line">            loggingInterceptor.setLevel(HttpLoggingInterceptor.Level.<span class="keyword">BODY);</span></span><br><span class="line"><span class="keyword"> </span>           //设置 Debug Log 模式</span><br><span class="line">            <span class="keyword">builder.addInterceptor(loggingInterceptor);</span></span><br><span class="line"><span class="keyword"> </span>       &#125;</span><br><span class="line"></span><br><span class="line">        OkHttpClient client = <span class="keyword">builder.build();</span></span><br><span class="line"><span class="keyword"></span></span><br><span class="line"><span class="keyword"> </span>       Retrofit retrofit_baimi = new Retrofit.<span class="keyword">Builder()</span></span><br><span class="line"><span class="keyword"> </span>               .<span class="keyword">baseUrl(BASE_URL+"/")</span></span><br><span class="line"><span class="keyword"> </span>               .client(client)</span><br><span class="line">                .<span class="keyword">addConverterFactory(CustomGsonConverterFactory.create())</span></span><br><span class="line"><span class="keyword"> </span>               .<span class="keyword">addCallAdapterFactory(RxJava2CallAdapterFactory.create())</span></span><br><span class="line"><span class="keyword"> </span>               .<span class="keyword">build();</span></span><br><span class="line"><span class="keyword"> </span>       mSmartApi = retrofit_baimi.create(SmartApi.class)<span class="comment">;</span></span><br></pre></td></tr></table></figure><p>OkHttpClient 采用build模式 链式设置</p><figure class="highlight lisp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">addInterceptor(<span class="name">new</span> Interceptor() &#123;</span><br><span class="line">            @Override</span><br><span class="line">            public Response intercept(<span class="name">Chain</span> chain) throws IOException &#123;</span><br><span class="line">                L.d(<span class="string">"Interceptor"</span>)<span class="comment">;</span></span><br><span class="line"></span><br><span class="line">                // Request customization: add request headers</span><br><span class="line">                String Nonce = String.valueOf(<span class="name">System</span>.currentTimeMillis())<span class="comment">;</span></span><br><span class="line">                String CheckSum = EncryptUtils.encryptSHA1ToString(<span class="string">"DA3B979ABB5A4FC0B65382BC1A344A84"</span>+Nonce)<span class="comment">;</span></span><br><span class="line">                Request.Builder requestBuilder = chain.request().newBuilder()</span><br><span class="line">                        .addHeader(<span class="string">"AppKey"</span>, <span class="string">"10000001"</span>)</span><br><span class="line">                        .addHeader(<span class="string">"Nonce"</span>, Nonce)</span><br><span class="line">                        .addHeader(<span class="string">"CheckSum"</span>, CheckSum)</span><br><span class="line">                        .addHeader(<span class="string">"x-session-token"</span>, BasePreference.getInstance().getToken())</span><br><span class="line">                        .addHeader(<span class="string">"AppSecret"</span>, <span class="string">"XXXXXXXXXXXXXXXXXXXXXXXXXXXXX"</span>)<span class="comment">;</span></span><br><span class="line"></span><br><span class="line">                Request request = requestBuilder.build()<span class="comment">;</span></span><br><span class="line">                return chain.proceed(<span class="name">request</span>)<span class="comment">;</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;)<span class="comment">;</span></span><br></pre></td></tr></table></figure><p>拦截请求 加入我们的header</p><figure class="highlight gauss"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (BuildConfig.DEBUG) &#123;</span><br><span class="line">            <span class="comment">// Log信息拦截器</span></span><br><span class="line">            HttpLoggingInterceptor loggingInterceptor = <span class="keyword">new</span> <span class="built_in">HttpLoggingInterceptor</span>();</span><br><span class="line">            loggingInterceptor.setLevel(HttpLoggingInterceptor.Level.BODY);</span><br><span class="line">            <span class="comment">//设置 Debug Log 模式</span></span><br><span class="line">            builder.addInterceptor(loggingInterceptor);</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure><p>如果是开发配置下 拦截body级别日志 打印信息方便调试</p><p><code>注意</code> 日志拦截器建议最后添加 才能拦截到添加header之后的日志</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;开发中可能遇到有的接口需要header传递一些信息，几个还好，可以用@header注解手动添加&lt;/p&gt;
&lt;p&gt;如果每个接口都需要，一个个写header就很傻了，可以使用retrofit2的拦截器做到&lt;/p&gt;
&lt;h2 id=&quot;常用配置&quot;&gt;&lt;a href=&quot;#常用配置&quot; cla
      
    
    </summary>
    
      <category term="技术" scheme="http://mzeht.com/categories/%E6%8A%80%E6%9C%AF/"/>
    
    
  </entry>
  
  <entry>
    <title>android 模块化统一管理依赖库版本号</title>
    <link href="http://mzeht.com/2017/06/01/android-%E6%A8%A1%E5%9D%97%E5%8C%96%E7%BB%9F%E4%B8%80%E7%AE%A1%E7%90%86%E4%BE%9D%E8%B5%96%E5%BA%93%E7%89%88%E6%9C%AC%E5%8F%B7/"/>
    <id>http://mzeht.com/2017/06/01/android-模块化统一管理依赖库版本号/</id>
    <published>2017-06-01T04:39:20.000Z</published>
    <updated>2019-04-30T20:33:51.262Z</updated>
    
    <content type="html"><![CDATA[<p>在android项目开发中 不断提炼出公用模块，方便以后的开发引入，很是方便，但是编译过程中不可避免遇到版本冲突的情况，<br>最常见的是sdk版本 v4 v7库版本，这种情况下 可以利用gradle配置统一管理</p><p>在项目根目录下新建 <code>common_config.gradle</code></p><h2 id="配置统一的版本号"><a href="#配置统一的版本号" class="headerlink" title="配置统一的版本号"></a>配置统一的版本号</h2><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 所有Module 的共享变量，这里修改了，全部地方都能修改</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">project<span class="selector-class">.ext</span> &#123;</span><br><span class="line">    <span class="comment">//1.关于SDK version</span></span><br><span class="line">    compileSdkVersion = <span class="number">25</span></span><br><span class="line">    buildToolsVersion = <span class="string">'25.0.3'</span></span><br><span class="line"></span><br><span class="line">    minSdkVersion = <span class="number">16</span></span><br><span class="line">    targetSdkVersion = <span class="number">25</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//2.关于Debug和Realease 的不同配置</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//3.指定Java version</span></span><br><span class="line">    sourceCompatibility = JavaVersion.VERSION_1_8</span><br><span class="line">    targetCompatibility = JavaVersion.VERSION_1_8</span><br><span class="line"></span><br><span class="line">    <span class="comment">//4.support Lib Version ,最好全部使用同一个版本号</span></span><br><span class="line">    supportLibraryVersion = <span class="string">'25.3.1'</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//5.</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="引入"><a href="#引入" class="headerlink" title="引入"></a>引入</h2><p>在project中引入上述文件</p><figure class="highlight plain"><figcaption><span>Top-level build file where you can add configuration options common to all sub-projects/modules.</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">buildscript &#123;</span><br><span class="line">    repositories &#123;</span><br><span class="line">        jcenter()</span><br><span class="line">    &#125;</span><br><span class="line">    dependencies &#123;</span><br><span class="line">        classpath &apos;com.android.tools.build:gradle:2.3.2&apos;</span><br><span class="line">//        classpath &apos;com.neenbedankt.gradle.plugins:android-apt:1.8&apos;</span><br><span class="line">        // NOTE: Do not place your application dependencies here; they belong</span><br><span class="line">        // in the individual module build.gradle files</span><br><span class="line">        classpath &apos;org.greenrobot:greendao-gradle-plugin:3.2.1&apos;</span><br><span class="line">        classpath &apos;com.jakewharton:butterknife-gradle-plugin:8.4.0&apos;</span><br><span class="line">        //lambda</span><br><span class="line">        classpath &apos;me.tatarka:gradle-retrolambda:3.6.0&apos;</span><br><span class="line">        //lombok</span><br><span class="line">        classpath &apos;me.tatarka.retrolambda.projectlombok:lombok.ast:0.2.3.a2&apos;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    configurations.classpath.exclude group: &apos;com.android.tools.external.lombok&apos;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line"> * 工程中所有的module 都将能使用common_config 中的配置</span><br><span class="line"> */</span><br><span class="line">subprojects &#123;</span><br><span class="line">    apply from: &quot;$&#123;project.rootDir&#125;/common_config.gradle&quot;</span><br><span class="line">    dependencies &#123;</span><br><span class="line">//        testCompile &apos;junit:junit:4.12&apos;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">allprojects &#123;</span><br><span class="line">    repositories &#123;</span><br><span class="line">        jcenter()</span><br><span class="line">        maven &#123; url &quot;https://jitpack.io&quot; &#125;</span><br><span class="line">       </span><br><span class="line">        mavenCentral()</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">task clean(type: Delete) &#123;</span><br><span class="line">    delete rootProject.buildDir</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="使用"><a href="#使用" class="headerlink" title="使用"></a>使用</h2><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">compileSdkVersion project<span class="selector-class">.ext</span><span class="selector-class">.compileSdkVersion</span></span><br><span class="line">   buildToolsVersion project<span class="selector-class">.ext</span><span class="selector-class">.buildToolsVersion</span></span><br><span class="line">   </span><br><span class="line">   </span><br><span class="line">   minSdkVersion project<span class="selector-class">.ext</span><span class="selector-class">.minSdkVersion</span></span><br><span class="line">       targetSdkVersion project<span class="selector-class">.ext</span><span class="selector-class">.targetSdkVersion</span></span><br><span class="line">       </span><br><span class="line">       </span><br><span class="line">       compile <span class="string">"com.android.support:appcompat-v7:$project.ext.supportLibraryVersion"</span></span><br><span class="line">   compile <span class="string">"com.android.support:design:$project.ext.supportLibraryVersion"</span></span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;在android项目开发中 不断提炼出公用模块，方便以后的开发引入，很是方便，但是编译过程中不可避免遇到版本冲突的情况，&lt;br&gt;最常见的是sdk版本 v4 v7库版本，这种情况下 可以利用gradle配置统一管理&lt;/p&gt;
&lt;p&gt;在项目根目录下新建 &lt;code&gt;common_
      
    
    </summary>
    
      <category term="技术" scheme="http://mzeht.com/categories/%E6%8A%80%E6%9C%AF/"/>
    
    
  </entry>
  
  <entry>
    <title>升级到rxjava2+retrofit2</title>
    <link href="http://mzeht.com/2017/06/01/%E5%8D%87%E7%BA%A7%E5%88%B0rxjava2-retrofit2/"/>
    <id>http://mzeht.com/2017/06/01/升级到rxjava2-retrofit2/</id>
    <published>2017-06-01T04:22:18.000Z</published>
    <updated>2019-04-30T20:33:51.265Z</updated>
    
    <content type="html"><![CDATA[<p>之前项目使用rxjava1和retorfit2，抽空在新项目升级到韧性java2</p><h2 id="依赖文件"><a href="#依赖文件" class="headerlink" title="依赖文件"></a>依赖文件</h2><figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">    </span><br><span class="line">    <span class="keyword">compile</span> <span class="string">'com.squareup.okhttp3:okhttp:3.4.2'</span></span><br><span class="line">    <span class="keyword">compile</span> <span class="string">'com.google.code.gson:gson:2.7'</span></span><br><span class="line">    <span class="keyword">compile</span> <span class="string">'io.reactivex.rxjava2:rxjava:2.0.7'</span></span><br><span class="line">    <span class="keyword">compile</span> <span class="string">'io.reactivex.rxjava2:rxandroid:2.0.1'</span></span><br><span class="line">    <span class="keyword">compile</span> <span class="string">'com.squareup.retrofit2:retrofit:2.3.0'</span></span><br><span class="line">    <span class="keyword">compile</span> <span class="string">'com.squareup.retrofit2:converter-gson:2.2.0'</span></span><br><span class="line"><span class="comment">//    compile 'com.squareup.retrofit2:adapter-rxjava:2.1.0'</span></span><br><span class="line"><span class="comment">//    compile 'com.jakewharton.retrofit:retrofit2-rxjava2-adapter:1.0.0'</span></span><br><span class="line">    <span class="keyword">compile</span> <span class="string">'com.squareup.retrofit2:adapter-rxjava2:2.2.0'</span></span><br><span class="line">    <span class="keyword">compile</span> <span class="string">'com.squareup.retrofit2:retrofit-converters:2.1.0'</span></span><br><span class="line">    <span class="keyword">compile</span> <span class="string">'com.squareup.okhttp3:logging-interceptor:3.4.2'</span></span><br><span class="line"><span class="comment">//    compile 'com.trello:rxlifecycle:1.0'</span></span><br><span class="line">    <span class="keyword">compile</span> <span class="string">'com.trello.rxlifecycle2:rxlifecycle:2.1.0'</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//    compile 'com.trello:rxlifecycle-android:1.0'</span></span><br><span class="line">    <span class="keyword">compile</span> <span class="string">'com.trello.rxlifecycle2:rxlifecycle-android:2.1.0'</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//    compile 'com.trello:rxlifecycle-components:1.0'</span></span><br><span class="line">    <span class="keyword">compile</span> <span class="string">'com.trello.rxlifecycle2:rxlifecycle-components:2.1.0'</span></span><br></pre></td></tr></table></figure><p>1.<code>rxlifecycle</code> 也升级到<code>rxlifecycle2</code> 一个rxjava生命周期管理库</p><p>2.retrofit2 支持rxjava2之前</p><p>采用</p><figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">compile</span> <span class="string">'com.jakewharton.retrofit:retrofit2-rxjava2-adapter:1.0.0'</span></span><br></pre></td></tr></table></figure><p>之后</p><figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">compile</span> <span class="string">'com.squareup.retrofit2:adapter-rxjava2:2.2.0'</span></span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;之前项目使用rxjava1和retorfit2，抽空在新项目升级到韧性java2&lt;/p&gt;
&lt;h2 id=&quot;依赖文件&quot;&gt;&lt;a href=&quot;#依赖文件&quot; class=&quot;headerlink&quot; title=&quot;依赖文件&quot;&gt;&lt;/a&gt;依赖文件&lt;/h2&gt;&lt;figure class=&quot;hi
      
    
    </summary>
    
      <category term="移动开发" scheme="http://mzeht.com/categories/app/"/>
    
      <category term="Android" scheme="http://mzeht.com/categories/app/Android/"/>
    
    
  </entry>
  
  <entry>
    <title>Gitflow 工作流</title>
    <link href="http://mzeht.com/2017/05/28/Gitflow-%E5%B7%A5%E4%BD%9C%E6%B5%81/"/>
    <id>http://mzeht.com/2017/05/28/Gitflow-工作流/</id>
    <published>2017-05-28T08:14:36.000Z</published>
    <updated>2019-04-30T20:33:51.259Z</updated>
    
    <content type="html"><![CDATA[<p>##简介</p><p><img src="http://nvie.com/img/git-model@2x.png" alt><br>[slide]</p><ol><li><code>feature</code>（多个、玫红）。主要是自己玩了，差不多的时候要合并回develop去。从不与master交互。</li><li><code>develop</code>（1个、黄色）。主要是和feature以及release交互。</li><li><code>release</code>（同一时间1个、绿色）。总是基于develop，最后又合并回develop。当然对应的tag跑到master这边去了。生命周期很短，只是为了发布</li><li><code>hotfix</code>（同一时间1个、红色）。总是基于master，并最后合并到master和develop。生命周期较短，用了修复bug或小粒度修改发布。</li><li><code>master</code>（1个蓝色）。没有什么东西，仅是一些关联的tag，因从不在master上开发。</li></ol><p>[slide]</p><ol><li><code>master</code>和<code>develop</code>都具有象征意义。master分支上的代码总是稳定的（stable build），随时可以发布出去。develop上的代码总是从feature上合并过来的，可以进行Nightly Builds，但不直接在develop上进行开发。当develop上的feature足够多以至于可以进行新版本的发布时，可以创建release分支</li><li><code>release</code>分支基于develop，进行很简单的修改后就被合并到master，并打上tag，表示可以发布了。紧接着release将被合并到develop；此时develop可能往前跑了一段，出现合并冲突，需要手工解决冲突后再次合并。这步完成后就删除release分支。</li><li>当从已发布版本中发现bug要修复时，就应用到<code>hotfix</code>分支了。hotfix基于master分支，完成bug修复或紧急修改后，要merge回master，打上一个新的tag，并merge回develop，删除hotfix分支。</li><li>由此可见release和hotfix的生命周期都较短，master/develop虽然总是存在但却不常使用。</li></ol><p>[slide]</p><h2 id="分支详解"><a href="#分支详解" class="headerlink" title="分支详解"></a>分支详解</h2><h3 id="主分支-（Historical-Branches）"><a href="#主分支-（Historical-Branches）" class="headerlink" title="主分支 （Historical Branches）"></a>主分支 （Historical Branches）</h3><p><img src="http://upload-images.jianshu.io/upload_images/54009-70ef16000c0832b0.jpg" alt></p><ol><li>主分支是所有开发活动的核心分支。所有的开发活动产生的输出物最终都会反映到主分支的代码中。主分支分为master分支和development分支。</li></ol><p>[slide]</p><h4 id="master-分支"><a href="#master-分支" class="headerlink" title="master 分支"></a>master 分支</h4><p>master分支上存放的应该是随时可供在生产环境中部署的代码（Production Ready state）。当开发活动告一段落，产生了一份新的可供部署的代码时，master分支上的代码会被更新。同时，每一次更新，最好添加对应的版本号标签（TAG）。<br>[slide]</p><h4 id="develop分支"><a href="#develop分支" class="headerlink" title="develop分支"></a>develop分支</h4><p>develop分支是保存当前最新开发成果的分支。通常这个分支上的代码也是可进行每日夜间发布的代码（Nightly build）。因此这个分支有时也可以被称作整合分支（integration branch）。</p><p>[slide]</p><h2 id="辅助分支"><a href="#辅助分支" class="headerlink" title="辅助分支"></a>辅助分支</h2><p><img src="http://upload-images.jianshu.io/upload_images/54009-7265a72025bddb1a.jpg?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt></p><ol><li>用于开发新功能时所使用的feature分支；</li><li>用于辅助版本发布的release分支；</li><li>用于修正生产代码中的缺陷的hotfix分支。</li></ol><p>[slide]</p><h3 id="feature-分支"><a href="#feature-分支" class="headerlink" title="feature 分支"></a>feature 分支</h3><p>使用规范：</p><ol><li>可以从develop分支发起feature分支</li><li>代码必须合并回develop分支</li><li>feature分支（有时也可以被叫做“topic分支”）通常是在开发一项新的软件功能的时候使用，这个分支上的代码变更最终合并回develop分支或者干脆被抛弃掉（例如实验性且效果不好的代码变更）</li></ol><p>[slide]</p><h3 id="release分支"><a href="#release分支" class="headerlink" title="release分支"></a>release分支</h3><p><img src="http://upload-images.jianshu.io/upload_images/54009-be502bd4658d9d79.jpg?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt></p><ol><li>可以从develop分支派生</li><li>必须合并回develop分支和master分支</li><li>分支命名惯例：release-*</li></ol>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;##简介&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;http://nvie.com/img/git-model@2x.png&quot; alt&gt;&lt;br&gt;[slide]&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;&lt;code&gt;feature&lt;/code&gt;（多个、玫红）。主要是自己玩了，差不多的时候要合并回de
      
    
    </summary>
    
      <category term="文档" scheme="http://mzeht.com/categories/documents/"/>
    
    
  </entry>
  
  <entry>
    <title>jenkins项目打包发布配置(srpingboot-jar,war,apk)</title>
    <link href="http://mzeht.com/2017/05/28/jenkins%E5%90%8E%E5%8F%B0%E9%A1%B9%E7%9B%AE%E6%89%93%E5%8C%85%E5%8F%91%E5%B8%83%E9%85%8D%E7%BD%AE-srpingboot-jar-war/"/>
    <id>http://mzeht.com/2017/05/28/jenkins后台项目打包发布配置-srpingboot-jar-war/</id>
    <published>2017-05-28T08:03:37.000Z</published>
    <updated>2019-04-30T20:33:51.263Z</updated>
    
    <content type="html"><![CDATA[<h2 id="两种不同打包"><a href="#两种不同打包" class="headerlink" title="两种不同打包"></a>两种不同打包</h2><p>jar类 springboot项目</p><ol><li>springboot框架</li><li>生成jar包</li><li>内置tomcat</li><li>运行环境 java</li></ol><p>war类 springmvc项目</p><ol><li>springmvc</li><li>生成war包</li><li>需要外部tomcat</li></ol><h2 id="jar类配置"><a href="#jar类配置" class="headerlink" title="jar类配置"></a>jar类配置</h2><ol><li>配置代码分支来源</li><li>打包</li><li>传输</li><li>启动</li></ol><h3 id="配置代码"><a href="#配置代码" class="headerlink" title="配置代码"></a>配置代码</h3><h3 id="打包"><a href="#打包" class="headerlink" title="打包"></a>打包</h3><p><img src="http://7xqtsx.com1.z0.glb.clouddn.com/17-5-28/33852371.jpg" alt></p><h3 id="传输"><a href="#传输" class="headerlink" title="传输"></a>传输</h3><p><img src="http://7xqtsx.com1.z0.glb.clouddn.com/17-5-28/21535521.jpg" alt></p><h3 id="邮件"><a href="#邮件" class="headerlink" title="邮件"></a>邮件</h3><h3 id="脚本"><a href="#脚本" class="headerlink" title="脚本"></a>脚本</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/sh</span></span><br><span class="line"><span class="comment">#defined</span></span><br><span class="line">ID=`ps -ef|grep <span class="string">"official-web-0.0.1-SNAPSHOT"</span> | grep <span class="string">"java"</span>| awk <span class="string">'&#123;print $2&#125;'</span>`</span><br><span class="line"><span class="built_in">echo</span> <span class="variable">$ID</span></span><br><span class="line"><span class="built_in">kill</span> -9 <span class="variable">$ID</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"kill <span class="variable">$ID</span> finish"</span></span><br><span class="line">nohup java -jar official-web-0.0.1-SNAPSHOT.jar &amp;</span><br><span class="line">....</span><br></pre></td></tr></table></figure><p>[slide]</p><h2 id="war类配置"><a href="#war类配置" class="headerlink" title="war类配置"></a>war类配置</h2><ol><li>配置代码分支来源</li><li>打包</li><li>传输</li><li>启动</li></ol><p>[slide]</p><h3 id="配置代码-1"><a href="#配置代码-1" class="headerlink" title="配置代码"></a>配置代码</h3><h3 id="打包-1"><a href="#打包-1" class="headerlink" title="打包"></a>打包</h3><h3 id="传输-1"><a href="#传输-1" class="headerlink" title="传输"></a>传输</h3><h3 id="脚本-1"><a href="#脚本-1" class="headerlink" title="脚本"></a>脚本</h3><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># !bin/sh</span></span><br><span class="line"><span class="comment"># jenkins传输war包位置</span></span><br><span class="line">jenkins_dir=<span class="string">"/root/jenkinsproject"</span></span><br><span class="line"><span class="comment"># war_name="appservice.war"</span></span><br><span class="line"><span class="comment">#项目名称</span></span><br><span class="line">project_name=<span class="string">"appservice"</span></span><br><span class="line"><span class="comment">#tomcat路径</span></span><br><span class="line">tomcat_dir=<span class="string">"/usr/tomcat/apache-tomcat-7.0.42"</span></span><br><span class="line"><span class="comment"># 当前脚本名称,查找进称号需要排除</span></span><br><span class="line">shell_name=<span class="string">"appservice-deploy.sh"</span></span><br><span class="line">pid=`ps -ef | grep <span class="variable">$tomcat_dir</span> | grep -v <span class="variable">$shell_name</span> | grep -v grep | awk <span class="string">'&#123;print $2&#125;'</span>`</span><br><span class="line">echo <span class="string">"old pid:"</span>.<span class="variable">$pid</span></span><br><span class="line"><span class="keyword">if</span> test <span class="string">"$pid"</span></span><br><span class="line">then</span><br><span class="line">  echo <span class="string">"kill old pid: $pid ing"</span></span><br><span class="line">  kill -<span class="number">9</span> <span class="variable">$pid</span></span><br><span class="line">  <span class="comment"># 睡眠5s</span></span><br><span class="line">  sleep <span class="number">20</span>s</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">        echo <span class="string">"not find old pid"</span></span><br><span class="line">fi</span><br><span class="line"><span class="comment">#删除旧的war包和生成文件夹</span></span><br><span class="line">rm -rf <span class="variable">$tomcat_dir</span><span class="regexp">/webapps/</span><span class="variable">$project_name</span>*</span><br><span class="line"><span class="comment"># 拷贝新的war包</span></span><br><span class="line">cp <span class="variable">$jenkins_dir</span><span class="regexp">/$project_name.war  $tomcat_dir/</span>webapps</span><br><span class="line"><span class="comment">#启动tomcat</span></span><br><span class="line">sh <span class="variable">$tomcat_dir</span><span class="regexp">/bin/</span>startup.sh</span><br><span class="line">sleep <span class="number">10</span>s</span><br><span class="line"><span class="comment"># 检查启动</span></span><br><span class="line">newpid=`ps -ef | grep <span class="variable">$tomcat_dir</span> | grep -v <span class="variable">$shell_name</span> | grep -v grep | awk <span class="string">'&#123;print $2&#125;'</span>`</span><br><span class="line"><span class="keyword">if</span> test <span class="string">"$newpid"</span></span><br><span class="line">then</span><br><span class="line">        echo <span class="string">"new pid:"</span>.<span class="variable">$newpid</span></span><br><span class="line"><span class="comment">#    刷新nginx</span></span><br><span class="line">    <span class="regexp">/usr/</span>local<span class="regexp">/nginx/</span>sbin<span class="regexp">/nginx -c /u</span>sr<span class="regexp">/local/</span>nginx<span class="regexp">/conf/</span>nginx.conf -s reload</span><br><span class="line">        <span class="keyword">exit</span></span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">        echo <span class="string">"not find new pid"</span></span><br><span class="line">        <span class="keyword">exit</span> <span class="number">1</span></span><br><span class="line">fi</span><br><span class="line">....</span><br></pre></td></tr></table></figure><p>[slide]</p><h2 id="apk类配置"><a href="#apk类配置" class="headerlink" title="apk类配置"></a>apk类配置</h2><ol><li>配置代码分支来源</li><li>打包</li><li>传输</li></ol><p>[slide]</p><h3 id="配置代码-2"><a href="#配置代码-2" class="headerlink" title="配置代码"></a>配置代码</h3><h3 id="打包-2"><a href="#打包-2" class="headerlink" title="打包"></a>打包</h3><p><img src="http://7xqtsx.com1.z0.glb.clouddn.com/17-5-28/67349864.jpg" alt></p><h3 id="传输-2"><a href="#传输-2" class="headerlink" title="传输"></a>传输</h3><h3 id="脚本-2"><a href="#脚本-2" class="headerlink" title="脚本"></a>脚本</h3><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"></span><br><span class="line">applicationVariants.all &#123; variant -&gt;</span><br><span class="line">    if (variant.buildType.name.equals('release')) &#123;</span><br><span class="line">        variant.outputs.each &#123; output -&gt;</span><br><span class="line">            def outputFile = output.outputFile</span><br><span class="line">            if (outputFile != null &amp;&amp; outputFile.name.endsWith('.apk')) &#123;</span><br><span class="line">                def fileName = "baimimobile_v$&#123;defaultConfig.versionName&#125;_$&#123;buildTime()&#125;.apk"</span><br><span class="line">                output.outputFile = new File(outputFile.parent, fileName)</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="演示"><a href="#演示" class="headerlink" title="演示"></a>演示</h3><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">BUILD SUCCESSFUL</span><br><span class="line"></span><br><span class="line">Total <span class="string">time:</span> <span class="number">1</span> mins <span class="number">27.55</span> secs</span><br><span class="line">Build step <span class="string">'Invoke Gradle script'</span> changed build result to SUCCESS</span><br><span class="line">Root directory to find files to <span class="string">upload :</span> <span class="regexp">/Users/</span>wpmac<span class="regexp">/.jenkins/</span>workspace/baimi-mobile-android</span><br><span class="line">found remote <span class="string">files :</span> [app<span class="regexp">/build/</span>outputs<span class="regexp">/apk/</span>baimimobile_v1<span class="number">.1</span><span class="number">.6</span>_2017<span class="number">-05</span><span class="number">-18</span>_1126228.apk]</span><br><span class="line">Deploying archive app<span class="regexp">/build/</span>outputs<span class="regexp">/apk/</span>baimimobile_v1<span class="number">.1</span><span class="number">.6</span>_2017<span class="number">-05</span><span class="number">-18</span>_1126228.apk to fir.im (description=<span class="string">"ecf02a33f60e3ad65c2bc0cae240c7f1"</span>, groups=<span class="string">""</span>)</span><br><span class="line">You can use ENV var $FIR_DOWNLOAD_URL <span class="keyword">in</span> other plugins.</span><br><span class="line">Deployment to fir.im Done.</span><br><span class="line"> Your app <span class="keyword">short</span> <span class="string">url:</span> <span class="string">http:</span><span class="comment">//fir.im/baimimobile</span></span><br><span class="line"><span class="string">Finished:</span> SUCCESS</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;两种不同打包&quot;&gt;&lt;a href=&quot;#两种不同打包&quot; class=&quot;headerlink&quot; title=&quot;两种不同打包&quot;&gt;&lt;/a&gt;两种不同打包&lt;/h2&gt;&lt;p&gt;jar类 springboot项目&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;springboot框架&lt;/li&gt;
&lt;li&gt;生
      
    
    </summary>
    
      <category term="后端开发" scheme="http://mzeht.com/categories/bg/"/>
    
      <category term="java" scheme="http://mzeht.com/categories/bg/java/"/>
    
    
  </entry>
  
  <entry>
    <title>greendao 数据库升级</title>
    <link href="http://mzeht.com/2017/05/28/greendao-%E6%95%B0%E6%8D%AE%E5%BA%93%E5%8D%87%E7%BA%A7/"/>
    <id>http://mzeht.com/2017/05/28/greendao-数据库升级/</id>
    <published>2017-05-28T07:47:26.000Z</published>
    <updated>2019-04-30T20:33:51.263Z</updated>
    
    <content type="html"><![CDATA[<p>创建一个数据库帮助类</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyOpenHelper</span> <span class="keyword">extends</span> <span class="title">DaoMaster</span>.<span class="title">OpenHelper</span></span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">MyOpenHelper</span><span class="params">(Context context, String name)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(context, name);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">MyOpenHelper</span><span class="params">(Context context, String name, SQLiteDatabase.CursorFactory factory)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(context, name, factory);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onUpgrade</span><span class="params">(Database db, <span class="keyword">int</span> oldVersion, <span class="keyword">int</span> newVersion)</span> </span>&#123;</span><br><span class="line">        L.d(<span class="string">"db version update from "</span> + oldVersion + <span class="string">" to "</span> + newVersion);</span><br><span class="line">        <span class="keyword">switch</span> (oldVersion)&#123;</span><br><span class="line">            <span class="keyword">case</span> <span class="number">1</span>:</span><br><span class="line">                CollectAdditionDao.createTable(db,<span class="keyword">true</span>);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>修改greenDao的版本号，在内层的gradle中的buildTypes节点下添加</p><figure class="highlight 1c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">greendao &#123;</span><br><span class="line">       <span class="comment">// schemaVersion 1</span></span><br><span class="line">       schemaVersion <span class="number">2</span><span class="comment">//@add 增值服务表</span></span><br><span class="line">       targetGenDir 'src/main/java'</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure><p>更新方式</p><p>1.删除再新建</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 删除原表重新再建立一个表</span></span><br><span class="line"><span class="comment">     * @param db</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">dropAndCreate</span><span class="params">(Database db)</span></span>&#123;</span><br><span class="line">        DaoMaster.dropAllTables(db, <span class="literal">true</span>);</span><br><span class="line">        DaoMaster.createAllTables(db, <span class="literal">false</span>);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>2.备份数据库，建立新数据库，然后将备份导入</p><figure class="highlight processing"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 备份还原</span></span><br><span class="line"><span class="comment">     * @param db</span></span><br><span class="line"><span class="comment">     * @param daoClasses</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> migrate(Database db, Class&lt;? extends AbstractDao&lt;?, ?&gt;&gt;... daoClasses) &#123;</span><br><span class="line">        generateTempTables(db, daoClasses);</span><br><span class="line">        DaoMaster.dropAllTables(db, <span class="keyword">true</span>);</span><br><span class="line">        DaoMaster.createAllTables(db, <span class="keyword">false</span>);</span><br><span class="line">        restoreData(db, daoClasses);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 数据库备份</span></span><br><span class="line"><span class="comment">     * @param db</span></span><br><span class="line"><span class="comment">     * @param daoClasses</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> generateTempTables(Database db, Class&lt;? extends AbstractDao&lt;?, ?&gt;&gt;... daoClasses) &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="built_in">int</span> i = <span class="number">0</span>; i &lt; daoClasses.length; i++) &#123;</span><br><span class="line">            DaoConfig daoConfig = <span class="keyword">new</span> DaoConfig(db, daoClasses[i]);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">String</span> divider = <span class="string">""</span>;</span><br><span class="line">            <span class="keyword">String</span> tableName = daoConfig.tablename;</span><br><span class="line">            <span class="keyword">String</span> tempTableName = daoConfig.tablename.<span class="built_in">concat</span>(<span class="string">"_TEMP"</span>);</span><br><span class="line">            ArrayList&lt;<span class="keyword">String</span>&gt; properties = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line"></span><br><span class="line">            StringBuilder createTableStringBuilder = <span class="keyword">new</span> StringBuilder();</span><br><span class="line"></span><br><span class="line">            createTableStringBuilder.<span class="built_in">append</span>(<span class="string">"CREATE TABLE "</span>).<span class="built_in">append</span>(tempTableName).<span class="built_in">append</span>(<span class="string">" ("</span>);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">for</span> (<span class="built_in">int</span> j = <span class="number">0</span>; j &lt; daoConfig.properties.length; j++) &#123;</span><br><span class="line">                <span class="keyword">String</span> columnName = daoConfig.properties[j].columnName;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (getColumns(db, tableName).contains(columnName)) &#123;</span><br><span class="line">                    properties.<span class="built_in">add</span>(columnName);</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">String</span> type = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        type = getTypeByClass(daoConfig.properties[j].type);</span><br><span class="line">                    &#125; <span class="keyword">catch</span> (Exception exception) &#123;</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    createTableStringBuilder.<span class="built_in">append</span>(divider).<span class="built_in">append</span>(columnName).<span class="built_in">append</span>(<span class="string">" "</span>).<span class="built_in">append</span>(type);</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">if</span> (daoConfig.properties[j].primaryKey) &#123;</span><br><span class="line">                        createTableStringBuilder.<span class="built_in">append</span>(<span class="string">" PRIMARY KEY"</span>);</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    divider = <span class="string">","</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            createTableStringBuilder.<span class="built_in">append</span>(<span class="string">");"</span>);</span><br><span class="line"></span><br><span class="line">            db.execSQL(createTableStringBuilder.toString());</span><br><span class="line"></span><br><span class="line">            StringBuilder insertTableStringBuilder = <span class="keyword">new</span> StringBuilder();</span><br><span class="line"></span><br><span class="line">            insertTableStringBuilder.<span class="built_in">append</span>(<span class="string">"INSERT INTO "</span>).<span class="built_in">append</span>(tempTableName).<span class="built_in">append</span>(<span class="string">" ("</span>);</span><br><span class="line">            insertTableStringBuilder.<span class="built_in">append</span>(TextUtils.<span class="built_in">join</span>(<span class="string">","</span>, properties));</span><br><span class="line">            insertTableStringBuilder.<span class="built_in">append</span>(<span class="string">") SELECT "</span>);</span><br><span class="line">            insertTableStringBuilder.<span class="built_in">append</span>(TextUtils.<span class="built_in">join</span>(<span class="string">","</span>, properties));</span><br><span class="line">            insertTableStringBuilder.<span class="built_in">append</span>(<span class="string">" FROM "</span>).<span class="built_in">append</span>(tableName).<span class="built_in">append</span>(<span class="string">";"</span>);</span><br><span class="line"></span><br><span class="line">            db.execSQL(insertTableStringBuilder.toString());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 数据库恢复</span></span><br><span class="line"><span class="comment">     * @param db</span></span><br><span class="line"><span class="comment">     * @param daoClasses</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> restoreData(Database db, Class&lt;? extends AbstractDao&lt;?, ?&gt;&gt;... daoClasses) &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="built_in">int</span> i = <span class="number">0</span>; i &lt; daoClasses.length; i++) &#123;</span><br><span class="line">            DaoConfig daoConfig = <span class="keyword">new</span> DaoConfig(db, daoClasses[i]);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">String</span> tableName = daoConfig.tablename;</span><br><span class="line">            <span class="keyword">String</span> tempTableName = daoConfig.tablename.<span class="built_in">concat</span>(<span class="string">"_TEMP"</span>);</span><br><span class="line">            ArrayList&lt;<span class="keyword">String</span>&gt; properties = <span class="keyword">new</span> ArrayList();</span><br><span class="line"></span><br><span class="line">            <span class="keyword">for</span> (<span class="built_in">int</span> j = <span class="number">0</span>; j &lt; daoConfig.properties.length; j++) &#123;</span><br><span class="line">                <span class="keyword">String</span> columnName = daoConfig.properties[j].columnName;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (getColumns(db, tempTableName).contains(columnName)) &#123;</span><br><span class="line">                    properties.<span class="built_in">add</span>(columnName);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            StringBuilder insertTableStringBuilder = <span class="keyword">new</span> StringBuilder();</span><br><span class="line"></span><br><span class="line">            insertTableStringBuilder.<span class="built_in">append</span>(<span class="string">"INSERT INTO "</span>).<span class="built_in">append</span>(tableName).<span class="built_in">append</span>(<span class="string">" ("</span>);</span><br><span class="line">            insertTableStringBuilder.<span class="built_in">append</span>(TextUtils.<span class="built_in">join</span>(<span class="string">","</span>, properties));</span><br><span class="line">            insertTableStringBuilder.<span class="built_in">append</span>(<span class="string">") SELECT "</span>);</span><br><span class="line">            insertTableStringBuilder.<span class="built_in">append</span>(TextUtils.<span class="built_in">join</span>(<span class="string">","</span>, properties));</span><br><span class="line">            insertTableStringBuilder.<span class="built_in">append</span>(<span class="string">" FROM "</span>).<span class="built_in">append</span>(tempTableName).<span class="built_in">append</span>(<span class="string">";"</span>);</span><br><span class="line"></span><br><span class="line">            StringBuilder dropTableStringBuilder = <span class="keyword">new</span> StringBuilder();</span><br><span class="line"></span><br><span class="line">            dropTableStringBuilder.<span class="built_in">append</span>(<span class="string">"DROP TABLE "</span>).<span class="built_in">append</span>(tempTableName);</span><br><span class="line"></span><br><span class="line">            db.execSQL(insertTableStringBuilder.toString());</span><br><span class="line">            db.execSQL(dropTableStringBuilder.toString());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">String</span> getTypeByClass(Class&lt;?&gt; type) <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="keyword">if</span> (type.equals(<span class="keyword">String</span>.class)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="string">"TEXT"</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (type.equals(Long.class) || type.equals(Integer.class) || type.equals(<span class="keyword">long</span>.class)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="string">"INTEGER"</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (type.equals(Boolean.class)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="string">"BOOLEAN"</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        Exception exception =</span><br><span class="line">                <span class="keyword">new</span> Exception(CONVERSION_CLASS_NOT_FOUND_EXCEPTION.<span class="built_in">concat</span>(<span class="string">" - Class: "</span>).<span class="built_in">concat</span>(type.toString()));</span><br><span class="line">        <span class="keyword">throw</span> exception;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> List&lt;<span class="keyword">String</span>&gt; getColumns(Database db, <span class="keyword">String</span> tableName) &#123;</span><br><span class="line">        List&lt;<span class="keyword">String</span>&gt; columns = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">        Cursor <span class="built_in">cursor</span> = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="built_in">cursor</span> = db.rawQuery(<span class="string">"SELECT * FROM "</span> + tableName + <span class="string">" limit 1"</span>, <span class="keyword">null</span>);</span><br><span class="line">            <span class="keyword">if</span> (<span class="built_in">cursor</span> != <span class="keyword">null</span>) &#123;</span><br><span class="line">                columns = <span class="keyword">new</span> ArrayList&lt;&gt;(Arrays.asList(<span class="built_in">cursor</span>.getColumnNames()));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            Log.v(tableName, e.getMessage(), e);</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (<span class="built_in">cursor</span> != <span class="keyword">null</span>) <span class="built_in">cursor</span>.close();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> columns;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>3.对比表差异，向原表中直接插入column</p><figure class="highlight processing"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 对比差异，在原表中直接添加column,赞不做删除操作</span></span><br><span class="line"><span class="comment">     * @param db</span></span><br><span class="line"><span class="comment">     * @param daoClasses</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> contrastDiff(Database db,ArrayList&lt;<span class="keyword">String</span>&gt;properties, Class&lt;? extends AbstractDao&lt;?, ?&gt;&gt;... daoClasses)&#123;</span><br><span class="line">     <span class="keyword">for</span>(<span class="built_in">int</span> i=<span class="number">0</span>;i&lt;daoClasses.length;i++)&#123;</span><br><span class="line">         DaoConfig daoConfig = <span class="keyword">new</span> DaoConfig(db, daoClasses[i]);</span><br><span class="line">         <span class="keyword">String</span> tableName=daoConfig.tablename;</span><br><span class="line">         <span class="keyword">if</span>(properties!=<span class="keyword">null</span>&amp;&amp;properties.<span class="built_in">size</span>()&gt;<span class="number">0</span>)&#123;</span><br><span class="line">             ArrayList&lt;<span class="keyword">String</span>&gt;tem=<span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">             StringBuilder sqlBuilder=<span class="keyword">new</span> StringBuilder();</span><br><span class="line">             <span class="keyword">for</span>(<span class="built_in">int</span> j=<span class="number">0</span>;j&lt;properties.<span class="built_in">size</span>();j++)&#123;</span><br><span class="line">                 <span class="keyword">if</span>(getColumns(db,tableName).contains(properties.<span class="built_in">get</span>(j)))&#123;</span><br><span class="line">                     <span class="keyword">continue</span>;</span><br><span class="line">                 &#125;</span><br><span class="line">                 tem.<span class="built_in">add</span>(properties.<span class="built_in">get</span>(j));</span><br><span class="line">             &#125;</span><br><span class="line">             sqlBuilder.<span class="built_in">append</span>(<span class="string">"INSERT INTO "</span>).<span class="built_in">append</span>(tableName).<span class="built_in">append</span>(<span class="string">" ("</span>);</span><br><span class="line">             sqlBuilder.<span class="built_in">append</span>(TextUtils.<span class="built_in">join</span>(<span class="string">","</span>, tem));</span><br><span class="line">             sqlBuilder.<span class="built_in">append</span>(<span class="string">") SELECT "</span>);</span><br><span class="line">             sqlBuilder.<span class="built_in">append</span>(TextUtils.<span class="built_in">join</span>(<span class="string">","</span>, tem));</span><br><span class="line">             sqlBuilder.<span class="built_in">append</span>(<span class="string">" FROM "</span>).<span class="built_in">append</span>(tableName).<span class="built_in">append</span>(<span class="string">";"</span>);</span><br><span class="line">             db.execSQL(sqlBuilder.toString());</span><br><span class="line">         &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>完整的数据库升级帮助类</p><figure class="highlight processing"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * description: greenDao升级帮助</span></span><br><span class="line"><span class="comment"> * author: bear .</span></span><br><span class="line"><span class="comment"> * Created date:  2017/5/17.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> class MigrationHelper &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">String</span> CONVERSION_CLASS_NOT_FOUND_EXCEPTION =</span><br><span class="line">            <span class="string">"MIGRATION HELPER - CLASS DOESN'T MATCH WITH THE CURRENT PARAMETERS"</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> MigrationHelper instance;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> MigrationHelper getInstance() &#123;</span><br><span class="line">        <span class="keyword">if</span> (instance == <span class="keyword">null</span>) &#123;</span><br><span class="line">            instance = <span class="keyword">new</span> MigrationHelper();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> instance;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 备份还原</span></span><br><span class="line"><span class="comment">     * @param db</span></span><br><span class="line"><span class="comment">     * @param daoClasses</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> migrate(Database db, Class&lt;? extends AbstractDao&lt;?, ?&gt;&gt;... daoClasses) &#123;</span><br><span class="line">        generateTempTables(db, daoClasses);</span><br><span class="line">        DaoMaster.dropAllTables(db, <span class="keyword">true</span>);</span><br><span class="line">        DaoMaster.createAllTables(db, <span class="keyword">false</span>);</span><br><span class="line">        restoreData(db, daoClasses);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 对比差异，在原表中直接添加column,赞不做删除操作</span></span><br><span class="line"><span class="comment">     * @param db</span></span><br><span class="line"><span class="comment">     * @param daoClasses</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> contrastDiff(Database db,ArrayList&lt;<span class="keyword">String</span>&gt;properties, Class&lt;? extends AbstractDao&lt;?, ?&gt;&gt;... daoClasses)&#123;</span><br><span class="line">     <span class="keyword">for</span>(<span class="built_in">int</span> i=<span class="number">0</span>;i&lt;daoClasses.length;i++)&#123;</span><br><span class="line">         DaoConfig daoConfig = <span class="keyword">new</span> DaoConfig(db, daoClasses[i]);</span><br><span class="line">         <span class="keyword">String</span> tableName=daoConfig.tablename;</span><br><span class="line">         <span class="keyword">if</span>(properties!=<span class="keyword">null</span>&amp;&amp;properties.<span class="built_in">size</span>()&gt;<span class="number">0</span>)&#123;</span><br><span class="line">             ArrayList&lt;<span class="keyword">String</span>&gt;tem=<span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">             StringBuilder sqlBuilder=<span class="keyword">new</span> StringBuilder();</span><br><span class="line">             <span class="keyword">for</span>(<span class="built_in">int</span> j=<span class="number">0</span>;j&lt;properties.<span class="built_in">size</span>();j++)&#123;</span><br><span class="line">                 <span class="keyword">if</span>(getColumns(db,tableName).contains(properties.<span class="built_in">get</span>(j)))&#123;</span><br><span class="line">                     <span class="keyword">continue</span>;</span><br><span class="line">                 &#125;</span><br><span class="line">                 tem.<span class="built_in">add</span>(properties.<span class="built_in">get</span>(j));</span><br><span class="line">             &#125;</span><br><span class="line">             sqlBuilder.<span class="built_in">append</span>(<span class="string">"INSERT INTO "</span>).<span class="built_in">append</span>(tableName).<span class="built_in">append</span>(<span class="string">" ("</span>);</span><br><span class="line">             sqlBuilder.<span class="built_in">append</span>(TextUtils.<span class="built_in">join</span>(<span class="string">","</span>, tem));</span><br><span class="line">             sqlBuilder.<span class="built_in">append</span>(<span class="string">") SELECT "</span>);</span><br><span class="line">             sqlBuilder.<span class="built_in">append</span>(TextUtils.<span class="built_in">join</span>(<span class="string">","</span>, tem));</span><br><span class="line">             sqlBuilder.<span class="built_in">append</span>(<span class="string">" FROM "</span>).<span class="built_in">append</span>(tableName).<span class="built_in">append</span>(<span class="string">";"</span>);</span><br><span class="line">             db.execSQL(sqlBuilder.toString());</span><br><span class="line">         &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 删除原表重新再建立一个表</span></span><br><span class="line"><span class="comment">     * @param db</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> dropAndCreate(Database db)&#123;</span><br><span class="line">        DaoMaster.dropAllTables(db, <span class="keyword">true</span>);</span><br><span class="line">        DaoMaster.createAllTables(db, <span class="keyword">false</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 数据库备份</span></span><br><span class="line"><span class="comment">     * @param db</span></span><br><span class="line"><span class="comment">     * @param daoClasses</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> generateTempTables(Database db, Class&lt;? extends AbstractDao&lt;?, ?&gt;&gt;... daoClasses) &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="built_in">int</span> i = <span class="number">0</span>; i &lt; daoClasses.length; i++) &#123;</span><br><span class="line">            DaoConfig daoConfig = <span class="keyword">new</span> DaoConfig(db, daoClasses[i]);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">String</span> divider = <span class="string">""</span>;</span><br><span class="line">            <span class="keyword">String</span> tableName = daoConfig.tablename;</span><br><span class="line">            <span class="keyword">String</span> tempTableName = daoConfig.tablename.<span class="built_in">concat</span>(<span class="string">"_TEMP"</span>);</span><br><span class="line">            ArrayList&lt;<span class="keyword">String</span>&gt; properties = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line"></span><br><span class="line">            StringBuilder createTableStringBuilder = <span class="keyword">new</span> StringBuilder();</span><br><span class="line"></span><br><span class="line">            createTableStringBuilder.<span class="built_in">append</span>(<span class="string">"CREATE TABLE "</span>).<span class="built_in">append</span>(tempTableName).<span class="built_in">append</span>(<span class="string">" ("</span>);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">for</span> (<span class="built_in">int</span> j = <span class="number">0</span>; j &lt; daoConfig.properties.length; j++) &#123;</span><br><span class="line">                <span class="keyword">String</span> columnName = daoConfig.properties[j].columnName;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (getColumns(db, tableName).contains(columnName)) &#123;</span><br><span class="line">                    properties.<span class="built_in">add</span>(columnName);</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">String</span> type = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        type = getTypeByClass(daoConfig.properties[j].type);</span><br><span class="line">                    &#125; <span class="keyword">catch</span> (Exception exception) &#123;</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    createTableStringBuilder.<span class="built_in">append</span>(divider).<span class="built_in">append</span>(columnName).<span class="built_in">append</span>(<span class="string">" "</span>).<span class="built_in">append</span>(type);</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">if</span> (daoConfig.properties[j].primaryKey) &#123;</span><br><span class="line">                        createTableStringBuilder.<span class="built_in">append</span>(<span class="string">" PRIMARY KEY"</span>);</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    divider = <span class="string">","</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            createTableStringBuilder.<span class="built_in">append</span>(<span class="string">");"</span>);</span><br><span class="line"></span><br><span class="line">            db.execSQL(createTableStringBuilder.toString());</span><br><span class="line"></span><br><span class="line">            StringBuilder insertTableStringBuilder = <span class="keyword">new</span> StringBuilder();</span><br><span class="line"></span><br><span class="line">            insertTableStringBuilder.<span class="built_in">append</span>(<span class="string">"INSERT INTO "</span>).<span class="built_in">append</span>(tempTableName).<span class="built_in">append</span>(<span class="string">" ("</span>);</span><br><span class="line">            insertTableStringBuilder.<span class="built_in">append</span>(TextUtils.<span class="built_in">join</span>(<span class="string">","</span>, properties));</span><br><span class="line">            insertTableStringBuilder.<span class="built_in">append</span>(<span class="string">") SELECT "</span>);</span><br><span class="line">            insertTableStringBuilder.<span class="built_in">append</span>(TextUtils.<span class="built_in">join</span>(<span class="string">","</span>, properties));</span><br><span class="line">            insertTableStringBuilder.<span class="built_in">append</span>(<span class="string">" FROM "</span>).<span class="built_in">append</span>(tableName).<span class="built_in">append</span>(<span class="string">";"</span>);</span><br><span class="line"></span><br><span class="line">            db.execSQL(insertTableStringBuilder.toString());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 数据库恢复</span></span><br><span class="line"><span class="comment">     * @param db</span></span><br><span class="line"><span class="comment">     * @param daoClasses</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> restoreData(Database db, Class&lt;? extends AbstractDao&lt;?, ?&gt;&gt;... daoClasses) &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="built_in">int</span> i = <span class="number">0</span>; i &lt; daoClasses.length; i++) &#123;</span><br><span class="line">            DaoConfig daoConfig = <span class="keyword">new</span> DaoConfig(db, daoClasses[i]);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">String</span> tableName = daoConfig.tablename;</span><br><span class="line">            <span class="keyword">String</span> tempTableName = daoConfig.tablename.<span class="built_in">concat</span>(<span class="string">"_TEMP"</span>);</span><br><span class="line">            ArrayList&lt;<span class="keyword">String</span>&gt; properties = <span class="keyword">new</span> ArrayList();</span><br><span class="line"></span><br><span class="line">            <span class="keyword">for</span> (<span class="built_in">int</span> j = <span class="number">0</span>; j &lt; daoConfig.properties.length; j++) &#123;</span><br><span class="line">                <span class="keyword">String</span> columnName = daoConfig.properties[j].columnName;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (getColumns(db, tempTableName).contains(columnName)) &#123;</span><br><span class="line">                    properties.<span class="built_in">add</span>(columnName);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            StringBuilder insertTableStringBuilder = <span class="keyword">new</span> StringBuilder();</span><br><span class="line"></span><br><span class="line">            insertTableStringBuilder.<span class="built_in">append</span>(<span class="string">"INSERT INTO "</span>).<span class="built_in">append</span>(tableName).<span class="built_in">append</span>(<span class="string">" ("</span>);</span><br><span class="line">            insertTableStringBuilder.<span class="built_in">append</span>(TextUtils.<span class="built_in">join</span>(<span class="string">","</span>, properties));</span><br><span class="line">            insertTableStringBuilder.<span class="built_in">append</span>(<span class="string">") SELECT "</span>);</span><br><span class="line">            insertTableStringBuilder.<span class="built_in">append</span>(TextUtils.<span class="built_in">join</span>(<span class="string">","</span>, properties));</span><br><span class="line">            insertTableStringBuilder.<span class="built_in">append</span>(<span class="string">" FROM "</span>).<span class="built_in">append</span>(tempTableName).<span class="built_in">append</span>(<span class="string">";"</span>);</span><br><span class="line"></span><br><span class="line">            StringBuilder dropTableStringBuilder = <span class="keyword">new</span> StringBuilder();</span><br><span class="line"></span><br><span class="line">            dropTableStringBuilder.<span class="built_in">append</span>(<span class="string">"DROP TABLE "</span>).<span class="built_in">append</span>(tempTableName);</span><br><span class="line"></span><br><span class="line">            db.execSQL(insertTableStringBuilder.toString());</span><br><span class="line">            db.execSQL(dropTableStringBuilder.toString());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">String</span> getTypeByClass(Class&lt;?&gt; type) <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="keyword">if</span> (type.equals(<span class="keyword">String</span>.class)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="string">"TEXT"</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (type.equals(Long.class) || type.equals(Integer.class) || type.equals(<span class="keyword">long</span>.class)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="string">"INTEGER"</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (type.equals(Boolean.class)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="string">"BOOLEAN"</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        Exception exception =</span><br><span class="line">                <span class="keyword">new</span> Exception(CONVERSION_CLASS_NOT_FOUND_EXCEPTION.<span class="built_in">concat</span>(<span class="string">" - Class: "</span>).<span class="built_in">concat</span>(type.toString()));</span><br><span class="line">        <span class="keyword">throw</span> exception;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> List&lt;<span class="keyword">String</span>&gt; getColumns(Database db, <span class="keyword">String</span> tableName) &#123;</span><br><span class="line">        List&lt;<span class="keyword">String</span>&gt; columns = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">        Cursor <span class="built_in">cursor</span> = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="built_in">cursor</span> = db.rawQuery(<span class="string">"SELECT * FROM "</span> + tableName + <span class="string">" limit 1"</span>, <span class="keyword">null</span>);</span><br><span class="line">            <span class="keyword">if</span> (<span class="built_in">cursor</span> != <span class="keyword">null</span>) &#123;</span><br><span class="line">                columns = <span class="keyword">new</span> ArrayList&lt;&gt;(Arrays.asList(<span class="built_in">cursor</span>.getColumnNames()));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            Log.v(tableName, e.getMessage(), e);</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (<span class="built_in">cursor</span> != <span class="keyword">null</span>) <span class="built_in">cursor</span>.close();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> columns;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;创建一个数据库帮助类&lt;/p&gt;
&lt;figure class=&quot;highlight java&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/spa
      
    
    </summary>
    
      <category term="移动开发" scheme="http://mzeht.com/categories/app/"/>
    
      <category term="Android" scheme="http://mzeht.com/categories/app/Android/"/>
    
    
  </entry>
  
  <entry>
    <title>仿京东三级地址选择器</title>
    <link href="http://mzeht.com/2017/05/28/%E4%BB%BF%E4%BA%AC%E4%B8%9C%E4%B8%89%E7%BA%A7%E5%9C%B0%E5%9D%80%E9%80%89%E6%8B%A9%E5%99%A8/"/>
    <id>http://mzeht.com/2017/05/28/仿京东三级地址选择器/</id>
    <published>2017-05-28T07:16:56.000Z</published>
    <updated>2019-04-30T20:33:51.265Z</updated>
    
    <content type="html"><![CDATA[<h2 id="效果图"><a href="#效果图" class="headerlink" title="效果图"></a>效果图</h2><p><img src="http://7xqtsx.com1.z0.glb.clouddn.com/17-5-28/96157233.jpg" alt></p><h2 id="实现"><a href="#实现" class="headerlink" title="实现"></a>实现</h2><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">@<span class="keyword">BindView</span>(<span class="keyword">R</span>.<span class="keyword">id</span>.<span class="keyword">recive_address_txt</span>)</span><br><span class="line">    TextView mReciveAddressTxt;</span><br></pre></td></tr></table></figure><p>根据tab的深度和前一项选择的id，获取下一级菜单项<br>下一级的数据都是由上一级参数网络请求而来</p><figure class="highlight aspectj"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">mReciveAddressTxt.setOnClickListener(<span class="keyword">new</span> View.OnClickListener() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="function"><span class="keyword">void</span> <span class="title">onClick</span><span class="params">(View v)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">                Selector selector = <span class="keyword">new</span> Selector(getActivity(), <span class="number">3</span>);</span><br><span class="line"></span><br><span class="line">                selector.setDataProvider(<span class="keyword">new</span> DataProvider() &#123;</span><br><span class="line">                    <span class="meta">@Override</span></span><br><span class="line">                    <span class="keyword">public</span> <span class="function"><span class="keyword">void</span> <span class="title">provideData</span><span class="params">(<span class="keyword">int</span> currentDeep, <span class="keyword">int</span> preId, DataReceiver receiver)</span> </span>&#123;</span><br><span class="line">                        <span class="comment">//根据tab的深度和前一项选择的id，获取下一级菜单项</span></span><br><span class="line">                        Log.i(TAG, <span class="string">"provideData: currentDeep &gt;&gt;&gt; "</span> + currentDeep + <span class="string">" preId &gt;&gt;&gt; "</span> + preId);</span><br><span class="line"><span class="comment">//                        ApiManager.getBaimiApi().getCity()</span></span><br><span class="line"></span><br><span class="line">                        <span class="keyword">switch</span> (currentDeep) &#123;</span><br><span class="line">                            <span class="keyword">case</span> <span class="number">0</span>:</span><br><span class="line">                                <span class="keyword">if</span> (proviceList.size() &gt; 0) &#123;</span><br><span class="line">                                    receiver.send(getDatas(proviceList));</span><br><span class="line">                                    <span class="keyword">return</span>;</span><br><span class="line">                                &#125;</span><br><span class="line">                                ApiManager.getBaimiApi().getProvince().subscribeOn(Schedulers.io())</span><br><span class="line">                                        .observeOn(AndroidSchedulers.mainThread())</span><br><span class="line">                                        .subscribe(<span class="keyword">new</span> Subscriber&lt;ApiResult&lt;List&lt;String&gt;&gt;&gt;() &#123;</span><br><span class="line">                                            <span class="meta">@Override</span></span><br><span class="line">                                            <span class="keyword">public</span> <span class="function"><span class="keyword">void</span> <span class="title">onCompleted</span><span class="params">()</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">                                            &#125;</span><br><span class="line"></span><br><span class="line">                                            <span class="meta">@Override</span></span><br><span class="line">                                            <span class="keyword">public</span> <span class="function"><span class="keyword">void</span> <span class="title">onError</span><span class="params">(Throwable e)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">                                            &#125;</span><br><span class="line"></span><br><span class="line">                                            <span class="meta">@Override</span></span><br><span class="line">                                            <span class="keyword">public</span> <span class="function"><span class="keyword">void</span> <span class="title">onNext</span><span class="params">(ApiResult&lt;List&lt;String&gt;&gt; listApiResult)</span> </span>&#123;</span><br><span class="line">                                                <span class="keyword">if</span> (listApiResult.getContent().size() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                                                    proviceList = listApiResult.getContent();</span><br><span class="line">                                                    receiver.send(getDatas(proviceList));</span><br><span class="line">                                                &#125;</span><br><span class="line">                                            &#125;</span><br><span class="line">                                        &#125;);</span><br><span class="line">                                <span class="keyword">break</span>;</span><br><span class="line">                            <span class="keyword">case</span> <span class="number">1</span>:</span><br><span class="line"></span><br><span class="line">                                ApiManager.getBaimiApi().getCity(proviceList.<span class="keyword">get</span>(preId))</span><br><span class="line">                                        .subscribeOn(Schedulers.io())</span><br><span class="line">                                        .observeOn(AndroidSchedulers.mainThread())</span><br><span class="line">                                        .subscribe(<span class="keyword">new</span> Subscriber&lt;ApiResult&lt;List&lt;String&gt;&gt;&gt;() &#123;</span><br><span class="line">                                            <span class="meta">@Override</span></span><br><span class="line">                                            <span class="keyword">public</span> <span class="function"><span class="keyword">void</span> <span class="title">onCompleted</span><span class="params">()</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">                                            &#125;</span><br><span class="line"></span><br><span class="line">                                            <span class="meta">@Override</span></span><br><span class="line">                                            <span class="keyword">public</span> <span class="function"><span class="keyword">void</span> <span class="title">onError</span><span class="params">(Throwable e)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">                                            &#125;</span><br><span class="line"></span><br><span class="line">                                            <span class="meta">@Override</span></span><br><span class="line">                                            <span class="keyword">public</span> <span class="function"><span class="keyword">void</span> <span class="title">onNext</span><span class="params">(ApiResult&lt;List&lt;String&gt;&gt; listApiResult)</span> </span>&#123;</span><br><span class="line">                                                <span class="keyword">if</span> (listApiResult.getFlag().equals(<span class="string">"1"</span>) || listApiResult.getContent().size() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                                                    cityList = listApiResult.getContent();</span><br><span class="line">                                                    receiver.send(getDatas(cityList));</span><br><span class="line">                                                &#125;</span><br><span class="line"></span><br><span class="line">                                            &#125;</span><br><span class="line">                                        &#125;);</span><br><span class="line">                                <span class="keyword">break</span>;</span><br><span class="line">                            <span class="keyword">case</span> <span class="number">2</span>:</span><br><span class="line">                                ApiManager.getBaimiApi().getArea(cityList.<span class="keyword">get</span>(preId))</span><br><span class="line">                                        .subscribeOn(Schedulers.io())</span><br><span class="line">                                        .observeOn(AndroidSchedulers.mainThread())</span><br><span class="line">                                        .subscribe(<span class="keyword">new</span> Subscriber&lt;ApiResult&lt;List&lt;String&gt;&gt;&gt;() &#123;</span><br><span class="line">                                            <span class="meta">@Override</span></span><br><span class="line">                                            <span class="keyword">public</span> <span class="function"><span class="keyword">void</span> <span class="title">onCompleted</span><span class="params">()</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">                                            &#125;</span><br><span class="line"></span><br><span class="line">                                            <span class="meta">@Override</span></span><br><span class="line">                                            <span class="keyword">public</span> <span class="function"><span class="keyword">void</span> <span class="title">onError</span><span class="params">(Throwable e)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">                                            &#125;</span><br><span class="line"></span><br><span class="line">                                            <span class="meta">@Override</span></span><br><span class="line">                                            <span class="keyword">public</span> <span class="function"><span class="keyword">void</span> <span class="title">onNext</span><span class="params">(ApiResult&lt;List&lt;String&gt;&gt; listApiResult)</span> </span>&#123;</span><br><span class="line">                                                <span class="keyword">if</span> (listApiResult.getFlag().equals(<span class="string">"1"</span>) || listApiResult.getContent().size() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                                                    areaList = listApiResult.getContent();</span><br><span class="line">                                                    receiver.send(getDatas(areaList));</span><br><span class="line">                                                &#125;</span><br><span class="line">                                            &#125;</span><br><span class="line">                                        &#125;);</span><br><span class="line">                                <span class="keyword">break</span>;</span><br><span class="line">                        &#125;</span><br><span class="line"></span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">private</span> ArrayList&lt;ISelectAble&gt; getDatas(List&lt;String&gt; list) &#123;</span><br><span class="line">                        <span class="keyword">int</span> count = list.size();</span><br><span class="line">                        ArrayList&lt;ISelectAble&gt; data = <span class="keyword">new</span> ArrayList&lt;&gt;(count);</span><br><span class="line">                        <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; count; j++) &#123;</span><br><span class="line"></span><br><span class="line">                            <span class="keyword">int</span> finalJ = j;</span><br><span class="line">                            data.add(<span class="keyword">new</span> ISelectAble() &#123;</span><br><span class="line">                                <span class="meta">@Override</span></span><br><span class="line">                                <span class="keyword">public</span> <span class="function">String <span class="title">getName</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                                    <span class="function"><span class="keyword">return</span> list.<span class="title">get</span><span class="params">(finalJ)</span></span>;</span><br><span class="line">                                &#125;</span><br><span class="line"></span><br><span class="line">                                <span class="meta">@Override</span></span><br><span class="line">                                <span class="keyword">public</span> <span class="function"><span class="keyword">int</span> <span class="title">getId</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                                    <span class="keyword">return</span> finalJ;</span><br><span class="line">                                &#125;</span><br><span class="line"></span><br><span class="line">                                <span class="meta">@Override</span></span><br><span class="line">                                <span class="keyword">public</span> <span class="function">Object <span class="title">getArg</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                                    <span class="keyword">return</span> <span class="keyword">this</span>;</span><br><span class="line">                                &#125;</span><br><span class="line">                            &#125;);</span><br><span class="line">                        &#125;</span><br><span class="line">                        <span class="keyword">return</span> data;</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">                &#125;);</span><br><span class="line">                selector.setSelectedListener(<span class="keyword">new</span> SelectedListener() &#123;</span><br><span class="line">                    <span class="meta">@Override</span></span><br><span class="line">                    <span class="keyword">public</span> <span class="function"><span class="keyword">void</span> <span class="title">onAddressSelected</span><span class="params">(ArrayList&lt;ISelectAble&gt; selectAbles)</span> </span>&#123;</span><br><span class="line">                        String result = <span class="string">""</span>;</span><br><span class="line">                        <span class="keyword">for</span> (ISelectAble selectAble : selectAbles) &#123;</span><br><span class="line">                            result += selectAble.getName() + <span class="string">" "</span>;</span><br><span class="line">                        &#125;</span><br><span class="line"><span class="comment">//                        Toast.makeText(getActivity(), result, Toast.LENGTH_SHORT).show();</span></span><br><span class="line">                        mReciveAddressTxt.setText(result);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;);</span><br><span class="line"></span><br><span class="line">                BottomDialog dialog = <span class="keyword">new</span> BottomDialog(getActivity());</span><br><span class="line">                dialog.init(getActivity(), selector);</span><br><span class="line">                dialog.show();</span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br></pre></td></tr></table></figure><h2 id="库地址"><a href="#库地址" class="headerlink" title="库地址"></a>库地址</h2><p><a href="https://github.com/dunwen/JDSelector" target="_blank" rel="noopener">https://github.com/dunwen/JDSelector</a></p><p><a href="https://github.com/chihane/JDAddressSelector" target="_blank" rel="noopener">https://github.com/chihane/JDAddressSelector</a></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;效果图&quot;&gt;&lt;a href=&quot;#效果图&quot; class=&quot;headerlink&quot; title=&quot;效果图&quot;&gt;&lt;/a&gt;效果图&lt;/h2&gt;&lt;p&gt;&lt;img src=&quot;http://7xqtsx.com1.z0.glb.clouddn.com/17-5-28/96157233.j
      
    
    </summary>
    
      <category term="移动开发" scheme="http://mzeht.com/categories/app/"/>
    
      <category term="Android" scheme="http://mzeht.com/categories/app/Android/"/>
    
    
  </entry>
  
  <entry>
    <title>popupwindow封装使用</title>
    <link href="http://mzeht.com/2017/05/28/popupwindow%E5%B0%81%E8%A3%85%E4%BD%BF%E7%94%A8/"/>
    <id>http://mzeht.com/2017/05/28/popupwindow封装使用/</id>
    <published>2017-05-28T07:00:46.000Z</published>
    <updated>2019-04-30T20:33:51.264Z</updated>
    
    <content type="html"><![CDATA[<h2 id="一个封装封装类"><a href="#一个封装封装类" class="headerlink" title="一个封装封装类"></a>一个封装封装类</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CustomPopWindow</span> <span class="keyword">implements</span> <span class="title">PopupWindow</span>.<span class="title">OnDismissListener</span></span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">float</span> DEFAULT_ALPHA = <span class="number">0.7f</span>;</span><br><span class="line">    <span class="keyword">private</span> Context mContext;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> mWidth;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> mHeight;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">boolean</span> mIsFocusable = <span class="keyword">true</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">boolean</span> mIsOutside = <span class="keyword">true</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> mResLayoutId = -<span class="number">1</span>;</span><br><span class="line">    <span class="keyword">private</span> View mContentView;</span><br><span class="line">    <span class="keyword">private</span> PopupWindow mPopupWindow;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> mAnimationStyle = -<span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">boolean</span> mClippEnable = <span class="keyword">true</span>;<span class="comment">//default is true</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">boolean</span> mIgnoreCheekPress = <span class="keyword">false</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> mInputMode = -<span class="number">1</span>;</span><br><span class="line">    <span class="keyword">private</span> PopupWindow.OnDismissListener mOnDismissListener;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> mSoftInputMode = -<span class="number">1</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">boolean</span> mTouchable = <span class="keyword">true</span>;<span class="comment">//default is ture</span></span><br><span class="line">    <span class="keyword">private</span> View.OnTouchListener mOnTouchListener;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Window mWindow;<span class="comment">//当前Activity 的窗口</span></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 弹出PopWindow 背景是否变暗，默认不会变暗。</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">boolean</span> mIsBackgroundDark = <span class="keyword">false</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">float</span> mBackgroundDrakValue = <span class="number">0</span>;<span class="comment">// 背景变暗的值，0 - 1</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="title">CustomPopWindow</span><span class="params">(Context context)</span></span>&#123;</span><br><span class="line">        mContext = context;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getWidth</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> mWidth;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getHeight</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> mHeight;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> anchor</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> xOff</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> yOff</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> CustomPopWindow <span class="title">showAsDropDown</span><span class="params">(View anchor, <span class="keyword">int</span> xOff, <span class="keyword">int</span> yOff)</span></span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(mPopupWindow!=<span class="keyword">null</span>)&#123;</span><br><span class="line">            mPopupWindow.showAsDropDown(anchor,xOff,yOff);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> CustomPopWindow <span class="title">showAsDropDown</span><span class="params">(View anchor)</span></span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(mPopupWindow!=<span class="keyword">null</span>)&#123;</span><br><span class="line">            mPopupWindow.showAsDropDown(anchor);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RequiresApi</span>(api = Build.VERSION_CODES.KITKAT)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> CustomPopWindow <span class="title">showAsDropDown</span><span class="params">(View anchor, <span class="keyword">int</span> xOff, <span class="keyword">int</span> yOff, <span class="keyword">int</span> gravity)</span></span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(mPopupWindow!=<span class="keyword">null</span>)&#123;</span><br><span class="line">            mPopupWindow.showAsDropDown(anchor,xOff,yOff,gravity);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 相对于父控件的位置（通过设置Gravity.CENTER，下方Gravity.BOTTOM等 ），可以设置具体位置坐标</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> parent 父控件</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> gravity</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> x the popup's x location offset</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> y the popup's y location offset</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> CustomPopWindow <span class="title">showAtLocation</span><span class="params">(View parent, <span class="keyword">int</span> gravity, <span class="keyword">int</span> x, <span class="keyword">int</span> y)</span></span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(mPopupWindow!=<span class="keyword">null</span>)&#123;</span><br><span class="line">            mPopupWindow.showAtLocation(parent,gravity,x,y);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 添加一些属性设置</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> popupWindow</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">apply</span><span class="params">(PopupWindow popupWindow)</span></span>&#123;</span><br><span class="line">        popupWindow.setClippingEnabled(mClippEnable);</span><br><span class="line">        <span class="keyword">if</span>(mIgnoreCheekPress)&#123;</span><br><span class="line">            popupWindow.setIgnoreCheekPress();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span>(mInputMode!=-<span class="number">1</span>)&#123;</span><br><span class="line">            popupWindow.setInputMethodMode(mInputMode);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span>(mSoftInputMode!=-<span class="number">1</span>)&#123;</span><br><span class="line">            popupWindow.setSoftInputMode(mSoftInputMode);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span>(mOnDismissListener!=<span class="keyword">null</span>)&#123;</span><br><span class="line">            popupWindow.setOnDismissListener(mOnDismissListener);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span>(mOnTouchListener!=<span class="keyword">null</span>)&#123;</span><br><span class="line">            popupWindow.setTouchInterceptor(mOnTouchListener);</span><br><span class="line">        &#125;</span><br><span class="line">        popupWindow.setTouchable(mTouchable);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> PopupWindow <span class="title">build</span><span class="params">()</span></span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(mContentView == <span class="keyword">null</span>)&#123;</span><br><span class="line">            mContentView = LayoutInflater.from(mContext).inflate(mResLayoutId,<span class="keyword">null</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 2017.3.17 add</span></span><br><span class="line">        <span class="comment">// 获取当前Activity的window</span></span><br><span class="line">        Activity activity = (Activity) mContentView.getContext();</span><br><span class="line">        <span class="keyword">if</span>(activity!=<span class="keyword">null</span> &amp;&amp; mIsBackgroundDark)&#123;</span><br><span class="line">            <span class="comment">//如果设置的值在0 - 1的范围内，则用设置的值，否则用默认值</span></span><br><span class="line">            <span class="keyword">final</span>  <span class="keyword">float</span> alpha = (mBackgroundDrakValue &gt; <span class="number">0</span> &amp;&amp; mBackgroundDrakValue &lt; <span class="number">1</span>) ? mBackgroundDrakValue : DEFAULT_ALPHA;</span><br><span class="line">            mWindow = activity.getWindow();</span><br><span class="line">            WindowManager.LayoutParams params = mWindow.getAttributes();</span><br><span class="line">            params.alpha = alpha;</span><br><span class="line">            mWindow.setAttributes(params);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(mWidth != <span class="number">0</span> &amp;&amp; mHeight!=<span class="number">0</span> )&#123;</span><br><span class="line">            mPopupWindow = <span class="keyword">new</span> PopupWindow(mContentView,mWidth,mHeight);</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            mPopupWindow = <span class="keyword">new</span> PopupWindow(mContentView, ViewGroup.LayoutParams.WRAP_CONTENT, ViewGroup.LayoutParams.WRAP_CONTENT);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span>(mAnimationStyle!=-<span class="number">1</span>)&#123;</span><br><span class="line">            mPopupWindow.setAnimationStyle(mAnimationStyle);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        apply(mPopupWindow);<span class="comment">//设置一些属性</span></span><br><span class="line"></span><br><span class="line">        mPopupWindow.setFocusable(mIsFocusable);</span><br><span class="line">        mPopupWindow.setBackgroundDrawable(<span class="keyword">new</span> ColorDrawable(Color.TRANSPARENT));</span><br><span class="line">        mPopupWindow.setOutsideTouchable(mIsOutside);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(mWidth == <span class="number">0</span> || mHeight == <span class="number">0</span>)&#123;</span><br><span class="line">            mPopupWindow.getContentView().measure(View.MeasureSpec.UNSPECIFIED, View.MeasureSpec.UNSPECIFIED);</span><br><span class="line">            <span class="comment">//如果外面没有设置宽高的情况下，计算宽高并赋值</span></span><br><span class="line">            mWidth = mPopupWindow.getContentView().getMeasuredWidth();</span><br><span class="line">            mHeight = mPopupWindow.getContentView().getMeasuredHeight();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 添加dissmiss 监听</span></span><br><span class="line">        mPopupWindow.setOnDismissListener(<span class="keyword">this</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        mPopupWindow.update();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> mPopupWindow;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onDismiss</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        dissmiss();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 关闭popWindow</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">dissmiss</span><span class="params">()</span></span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(mOnDismissListener!=<span class="keyword">null</span>)&#123;</span><br><span class="line">            mOnDismissListener.onDismiss();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//如果设置了背景变暗，那么在dissmiss的时候需要还原</span></span><br><span class="line">        <span class="keyword">if</span>(mWindow!=<span class="keyword">null</span>)&#123;</span><br><span class="line">            WindowManager.LayoutParams params = mWindow.getAttributes();</span><br><span class="line">            params.alpha = <span class="number">1.0f</span>;</span><br><span class="line">            mWindow.setAttributes(params);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span>(mPopupWindow!=<span class="keyword">null</span> &amp;&amp; mPopupWindow.isShowing())&#123;</span><br><span class="line">            mPopupWindow.dismiss();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">PopupWindowBuilder</span></span>&#123;</span><br><span class="line">        <span class="keyword">private</span> CustomPopWindow mCustomPopWindow;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">PopupWindowBuilder</span><span class="params">(Context context)</span></span>&#123;</span><br><span class="line">            mCustomPopWindow = <span class="keyword">new</span> CustomPopWindow(context);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> PopupWindowBuilder <span class="title">size</span><span class="params">(<span class="keyword">int</span> width,<span class="keyword">int</span> height)</span></span>&#123;</span><br><span class="line">            mCustomPopWindow.mWidth = width;</span><br><span class="line">            mCustomPopWindow.mHeight = height;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">this</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> PopupWindowBuilder <span class="title">setFocusable</span><span class="params">(<span class="keyword">boolean</span> focusable)</span></span>&#123;</span><br><span class="line">            mCustomPopWindow.mIsFocusable = focusable;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">this</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> PopupWindowBuilder <span class="title">setView</span><span class="params">(<span class="keyword">int</span> resLayoutId)</span></span>&#123;</span><br><span class="line">            mCustomPopWindow.mResLayoutId = resLayoutId;</span><br><span class="line">            mCustomPopWindow.mContentView = <span class="keyword">null</span>;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">this</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> PopupWindowBuilder <span class="title">setView</span><span class="params">(View view)</span></span>&#123;</span><br><span class="line">            mCustomPopWindow.mContentView = view;</span><br><span class="line">            mCustomPopWindow.mResLayoutId = -<span class="number">1</span>;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">this</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> PopupWindowBuilder <span class="title">setOutsideTouchable</span><span class="params">(<span class="keyword">boolean</span> outsideTouchable)</span></span>&#123;</span><br><span class="line">            mCustomPopWindow.mIsOutside = outsideTouchable;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">this</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * 设置弹窗动画</span></span><br><span class="line"><span class="comment">         * <span class="doctag">@param</span> animationStyle</span></span><br><span class="line"><span class="comment">         * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> PopupWindowBuilder <span class="title">setAnimationStyle</span><span class="params">(<span class="keyword">int</span> animationStyle)</span></span>&#123;</span><br><span class="line">            mCustomPopWindow.mAnimationStyle = animationStyle;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">this</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> PopupWindowBuilder <span class="title">setClippingEnable</span><span class="params">(<span class="keyword">boolean</span> enable)</span></span>&#123;</span><br><span class="line">            mCustomPopWindow.mClippEnable =enable;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">this</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> PopupWindowBuilder <span class="title">setIgnoreCheekPress</span><span class="params">(<span class="keyword">boolean</span> ignoreCheekPress)</span></span>&#123;</span><br><span class="line">            mCustomPopWindow.mIgnoreCheekPress = ignoreCheekPress;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">this</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> PopupWindowBuilder <span class="title">setInputMethodMode</span><span class="params">(<span class="keyword">int</span> mode)</span></span>&#123;</span><br><span class="line">            mCustomPopWindow.mInputMode = mode;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">this</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> PopupWindowBuilder <span class="title">setOnDissmissListener</span><span class="params">(PopupWindow.OnDismissListener onDissmissListener)</span></span>&#123;</span><br><span class="line">            mCustomPopWindow.mOnDismissListener = onDissmissListener;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">this</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> PopupWindowBuilder <span class="title">setSoftInputMode</span><span class="params">(<span class="keyword">int</span> softInputMode)</span></span>&#123;</span><br><span class="line">            mCustomPopWindow.mSoftInputMode = softInputMode;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">this</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> PopupWindowBuilder <span class="title">setTouchable</span><span class="params">(<span class="keyword">boolean</span> touchable)</span></span>&#123;</span><br><span class="line">            mCustomPopWindow.mTouchable = touchable;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">this</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> PopupWindowBuilder <span class="title">setTouchIntercepter</span><span class="params">(View.OnTouchListener touchIntercepter)</span></span>&#123;</span><br><span class="line">            mCustomPopWindow.mOnTouchListener = touchIntercepter;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">this</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * 设置背景变暗是否可用</span></span><br><span class="line"><span class="comment">         * <span class="doctag">@param</span> isDark</span></span><br><span class="line"><span class="comment">         * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> PopupWindowBuilder <span class="title">enableBackgroundDark</span><span class="params">(<span class="keyword">boolean</span> isDark)</span></span>&#123;</span><br><span class="line">            mCustomPopWindow.mIsBackgroundDark = isDark;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">this</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * 设置北京变暗的值</span></span><br><span class="line"><span class="comment">         * <span class="doctag">@param</span> darkValue</span></span><br><span class="line"><span class="comment">         * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> PopupWindowBuilder <span class="title">setBgDarkAlpha</span><span class="params">(<span class="keyword">float</span> darkValue)</span></span>&#123;</span><br><span class="line">            mCustomPopWindow.mBackgroundDrakValue = darkValue;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">this</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> CustomPopWindow <span class="title">create</span><span class="params">()</span></span>&#123;</span><br><span class="line">            <span class="comment">//构建PopWindow</span></span><br><span class="line">            mCustomPopWindow.build();</span><br><span class="line">            <span class="keyword">return</span> mCustomPopWindow;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="实际使用"><a href="#实际使用" class="headerlink" title="实际使用"></a>实际使用</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ReadMineActivity</span> <span class="keyword">extends</span> <span class="title">BaseActivity</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    CustomPopWindow mCustomPopWindow;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    Dialog dateDialog, timeDialog;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">final</span> popupwindow p = <span class="keyword">new</span> popupwindow();</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">popupwindow</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@BindView</span>(R.id.is_switch)</span><br><span class="line">        SwitchCompat is_switch;<span class="comment">//是否重复</span></span><br><span class="line">        <span class="meta">@BindView</span>(R.id.set_dataandtime)</span><br><span class="line">        LinearLayout setDateAndTimeLL;<span class="comment">//选择日期时间菜单</span></span><br><span class="line"></span><br><span class="line">        <span class="meta">@BindView</span>(R.id.set_dataandtime_detail)</span><br><span class="line">        LinearLayout setDateAndTimeDetailLL;<span class="comment">//选择日期时间</span></span><br><span class="line"></span><br><span class="line">        <span class="meta">@BindView</span>(R.id.set_time)</span><br><span class="line">        LinearLayout setTimeLL;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@BindView</span>(R.id.set_time_detail)</span><br><span class="line">        LinearLayout setTimeDetailLL;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@BindView</span>(R.id.data_text)</span><br><span class="line">        TextView dateText;<span class="comment">//日期</span></span><br><span class="line"></span><br><span class="line">        <span class="meta">@BindView</span>(R.id.time1)</span><br><span class="line">        TextView time1;<span class="comment">//time</span></span><br><span class="line"></span><br><span class="line">        <span class="meta">@BindView</span>(R.id.time2)</span><br><span class="line">        TextView time2;<span class="comment">//time</span></span><br><span class="line"></span><br><span class="line">        <span class="meta">@BindView</span>(R.id.day1)</span><br><span class="line">        CheckBox day1;</span><br><span class="line">        <span class="meta">@BindView</span>(R.id.day2)</span><br><span class="line">        CheckBox day2;</span><br><span class="line">        <span class="meta">@BindView</span>(R.id.day3)</span><br><span class="line">        CheckBox day3;</span><br><span class="line">        <span class="meta">@BindView</span>(R.id.day4)</span><br><span class="line">        CheckBox day4;</span><br><span class="line">        <span class="meta">@BindView</span>(R.id.day5)</span><br><span class="line">        CheckBox day5;</span><br><span class="line">        <span class="meta">@BindView</span>(R.id.day6)</span><br><span class="line">        CheckBox day6;</span><br><span class="line">        <span class="meta">@BindView</span>(R.id.day7)</span><br><span class="line">        CheckBox day7;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@BindView</span>(R.id.add_readmine_submit)</span><br><span class="line">        TextView submit;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@BindView</span>(R.id.readmine_message_edit)</span><br><span class="line">        EditText message;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@BindView</span>(R.id.bind_newreadmie_ll)</span><br><span class="line">    LinearLayout bindNewReadMineLL;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@BindView</span>(R.id.recyclerView)</span><br><span class="line">    RecyclerView mRecyclerView;</span><br><span class="line"></span><br><span class="line">    MultiTypeAdapter mAdapter;</span><br><span class="line">    Items items = <span class="keyword">new</span> Items();</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(Bundle savedInstanceState)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.onCreate(savedInstanceState);</span><br><span class="line">        setContentView(R.layout.activity_read_mine);</span><br><span class="line">        ButterKnife.bind(<span class="keyword">this</span>);</span><br><span class="line">        initView();</span><br><span class="line">        setListener();</span><br><span class="line">        initData();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">initData</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt;<span class="number">25</span> ; i++) &#123;</span><br><span class="line">            ReadmineItem item = <span class="keyword">new</span> ReadmineItem();</span><br><span class="line">            items.add(item);</span><br><span class="line">        &#125;</span><br><span class="line">        mAdapter.notifyDataSetChanged();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">setListener</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        bindNewReadMineLL.setOnClickListener(<span class="keyword">new</span> View.OnClickListener() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onClick</span><span class="params">(View v)</span> </span>&#123;</span><br><span class="line">                mCustomPopWindow.showAsDropDown(bindNewReadMineLL, <span class="number">0</span>, <span class="number">20</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">initView</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">//=======================================mCustomPopWindow============================================//</span></span><br><span class="line">        View contentView = LayoutInflater.from(getActivity()).inflate(R.layout.popwindow_add_readmine, <span class="keyword">null</span>);</span><br><span class="line">        <span class="comment">//处理popWindow 显示内容</span></span><br><span class="line">        handleLogic(contentView);</span><br><span class="line">        <span class="comment">//创建并显示popWindow</span></span><br><span class="line">        mCustomPopWindow = <span class="keyword">new</span> CustomPopWindow.PopupWindowBuilder(getActivity())</span><br><span class="line">                .setView(contentView)</span><br><span class="line">                .size(ViewGroup.LayoutParams.MATCH_PARENT, ViewGroup.LayoutParams.WRAP_CONTENT)</span><br><span class="line">                .enableBackgroundDark(<span class="keyword">false</span>) <span class="comment">//弹出popWindow时，背景是否变暗</span></span><br><span class="line">                .setBgDarkAlpha(<span class="number">0.7f</span>) <span class="comment">// 控制亮度</span></span><br><span class="line">                .setOnDissmissListener(<span class="keyword">new</span> PopupWindow.OnDismissListener() &#123;</span><br><span class="line">                    <span class="meta">@Override</span></span><br><span class="line">                    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onDismiss</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                        Log.e(<span class="string">"TAG"</span>, <span class="string">"onDismiss"</span>);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;)</span><br><span class="line">                .create();</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="comment">//=======================================recyclerView============================================//</span></span><br><span class="line">        mRecyclerView.setLayoutManager(<span class="keyword">new</span> WrapContentLinearLayoutManager(getActivity()));</span><br><span class="line">        mAdapter = <span class="keyword">new</span> MultiTypeAdapter();</span><br><span class="line">        mAdapter.register(ReadmineItem.class, <span class="keyword">new</span> ReadmineItemViewBinder());</span><br><span class="line">        mAdapter.setItems(items);</span><br><span class="line">        mRecyclerView.setAdapter(mAdapter);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">handleLogic</span><span class="params">(View contentView)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        ButterKnife.bind(p, contentView);</span><br><span class="line"></span><br><span class="line">        p.dateText.setOnClickListener(<span class="keyword">new</span> View.OnClickListener() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onClick</span><span class="params">(View v)</span> </span>&#123;</span><br><span class="line">                showDateDialog(DateUtil.getDateForString(p.dateText.getText().toString()));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">        p.time1.setOnClickListener(<span class="keyword">new</span> View.OnClickListener() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onClick</span><span class="params">(View v)</span> </span>&#123;</span><br><span class="line">                showTimeDialog();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">        p.time2.setOnClickListener(<span class="keyword">new</span> View.OnClickListener() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onClick</span><span class="params">(View v)</span> </span>&#123;</span><br><span class="line">                showTimeDialog();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        p.setTimeLL.setVisibility(View.GONE);</span><br><span class="line">        p.setTimeDetailLL.setVisibility(View.GONE);</span><br><span class="line">        p.is_switch.setOnCheckedChangeListener(<span class="keyword">new</span> CompoundButton.OnCheckedChangeListener() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onCheckedChanged</span><span class="params">(CompoundButton buttonView, <span class="keyword">boolean</span> isChecked)</span> </span>&#123;</span><br><span class="line">                <span class="keyword">if</span> (isChecked) &#123;</span><br><span class="line">                    p.setDateAndTimeLL.setVisibility(View.GONE);</span><br><span class="line">                    p.setDateAndTimeDetailLL.setVisibility(View.GONE);</span><br><span class="line">                    p.setTimeLL.setVisibility(View.VISIBLE);</span><br><span class="line">                    p.setTimeDetailLL.setVisibility(View.VISIBLE);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    p.setDateAndTimeLL.setVisibility(View.VISIBLE);</span><br><span class="line">                    p.setDateAndTimeDetailLL.setVisibility(View.VISIBLE);</span><br><span class="line">                    p.setTimeLL.setVisibility(View.GONE);</span><br><span class="line">                    p.setTimeDetailLL.setVisibility(View.GONE);</span><br><span class="line"></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">        p.submit.setOnClickListener(<span class="keyword">new</span> View.OnClickListener() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onClick</span><span class="params">(View v)</span> </span>&#123;</span><br><span class="line">                T.showShort(getActivity(),p.dateText.getText().toString()+p.time1.getText().toString()+p.day1.isChecked()+p.message.getText().toString());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">showTimeDialog</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (timeDialog == <span class="keyword">null</span>) &#123;</span><br><span class="line"></span><br><span class="line">            TimePickerDialog.Builder builder = <span class="keyword">new</span> TimePickerDialog.Builder(<span class="keyword">this</span>);</span><br><span class="line">            timeDialog = builder.setOnTimeSelectedListener(<span class="keyword">new</span> TimePickerDialog.OnTimeSelectedListener() &#123;</span><br><span class="line">                <span class="meta">@Override</span></span><br><span class="line">                <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onTimeSelected</span><span class="params">(<span class="keyword">int</span>[] times)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">                    p.time1.setText(times[<span class="number">0</span>] + <span class="string">":"</span> + times[<span class="number">1</span>]);</span><br><span class="line">                    p.time2.setText(times[<span class="number">0</span>] + <span class="string">":"</span> + times[<span class="number">1</span>]);</span><br><span class="line"></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;).create();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        timeDialog.show();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">showDateDialog</span><span class="params">(List&lt;Integer&gt; date)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//==============================DatePickerDialog===================================//</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (dateDialog==<span class="keyword">null</span>)&#123;</span><br><span class="line">            DatePickerDialog.Builder Datebuilder = <span class="keyword">new</span> DatePickerDialog.Builder(<span class="keyword">this</span>);</span><br><span class="line">            dateDialog=Datebuilder.setOnDateSelectedListener(<span class="keyword">new</span> DatePickerDialog.OnDateSelectedListener() &#123;</span><br><span class="line">                <span class="meta">@Override</span></span><br><span class="line">                <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onDateSelected</span><span class="params">(<span class="keyword">int</span>[] dates)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">                    p.dateText.setText(dates[<span class="number">0</span>] + <span class="string">"-"</span> + (dates[<span class="number">1</span>] &gt; <span class="number">9</span> ? dates[<span class="number">1</span>] : (<span class="string">"0"</span> + dates[<span class="number">1</span>])) + <span class="string">"-"</span></span><br><span class="line">                            + (dates[<span class="number">2</span>] &gt; <span class="number">9</span> ? dates[<span class="number">2</span>] : (<span class="string">"0"</span> + dates[<span class="number">2</span>])));</span><br><span class="line"></span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="meta">@Override</span></span><br><span class="line">                <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onCancel</span><span class="params">()</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;).setSelectYear(date.get(<span class="number">0</span>) - <span class="number">1</span>)</span><br><span class="line">                    .setSelectMonth(date.get(<span class="number">1</span>) - <span class="number">1</span>)</span><br><span class="line">                    .setSelectDay(date.get(<span class="number">2</span>) - <span class="number">1</span>)</span><br><span class="line">                    .setMaxYear(DateUtil.getYear())</span><br><span class="line">                    .setMaxMonth(DateUtil.getDateForString(DateUtil.getToday()).get(<span class="number">1</span>))</span><br><span class="line">                    .setMaxDay(DateUtil.getDateForString(DateUtil.getToday()).get(<span class="number">2</span>)).create();</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">        dateDialog.show();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="效果图"><a href="#效果图" class="headerlink" title="效果图"></a>效果图</h2><p><img src="http://7xqtsx.com1.z0.glb.clouddn.com/17-5-28/39434013.jpg" alt></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;一个封装封装类&quot;&gt;&lt;a href=&quot;#一个封装封装类&quot; class=&quot;headerlink&quot; title=&quot;一个封装封装类&quot;&gt;&lt;/a&gt;一个封装封装类&lt;/h2&gt;&lt;figure class=&quot;highlight java&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;
      
    
    </summary>
    
      <category term="移动开发" scheme="http://mzeht.com/categories/app/"/>
    
      <category term="Android" scheme="http://mzeht.com/categories/app/Android/"/>
    
    
  </entry>
  
  <entry>
    <title>Recycleview Mutitype的使用</title>
    <link href="http://mzeht.com/2017/05/04/2017-05-05-2/"/>
    <id>http://mzeht.com/2017/05/04/2017-05-05-2/</id>
    <published>2017-05-04T15:50:16.000Z</published>
    <updated>2019-04-30T20:33:51.256Z</updated>
    
    <content type="html"><![CDATA[<p>安利一波<br><figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">compile</span>(<span class="string">'me.drakeet.multitype:multitype:2.5.0'</span>, &#123;</span><br><span class="line">       <span class="keyword">exclude</span> <span class="keyword">group</span>: <span class="string">'com.android.support'</span></span><br><span class="line">   &#125;)</span><br></pre></td></tr></table></figure></p><p>基本文档github主页写的较好</p><p>基本使用<br><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">public <span class="class"><span class="keyword">class</span> <span class="title">EmptyDataViewProvider</span> <span class="keyword">extends</span> <span class="title">ItemViewBinder&lt;EmptyData</span>,<span class="title">EmptyDataViewProvider</span>.<span class="title">ViewHolder&gt;</span></span>&#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@NonNull</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="type">ViewHolder</span> onCreateViewHolder(<span class="meta">@NonNull</span> <span class="type">LayoutInflater</span> inflater, <span class="meta">@NonNull</span> <span class="type">ViewGroup</span> parent) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="type">ViewHolder</span>(inflater.inflate(<span class="type">R</span>.layout.bm_list_empty_view,parent,<span class="literal">false</span>));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> void onBindViewHolder(<span class="meta">@NonNull</span> <span class="type">ViewHolder</span> holder, <span class="meta">@NonNull</span> <span class="type">EmptyData</span> item) &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="type">TextUtils</span>.isEmpty(item.getMessage()))&#123;</span><br><span class="line">        holder.messageTextView.setText(<span class="string">"你来到一片荒芜之地, 空空如也, 什么都没有\\n实在是太冷清了╮(╯_╰)╭"</span>);</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            holder.messageTextView.setText(item.getMessage());</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    static <span class="class"><span class="keyword">class</span> <span class="title">ViewHolder</span> <span class="keyword">extends</span> <span class="title">RecyclerView</span>.<span class="title">ViewHolder</span> </span>&#123;</span><br><span class="line">        <span class="keyword">private</span> <span class="type">TextView</span> messageTextView;</span><br><span class="line"></span><br><span class="line">        public <span class="type">ViewHolder</span>(<span class="type">View</span> itemView) &#123;</span><br><span class="line">            <span class="keyword">super</span>(itemView);</span><br><span class="line">            <span class="keyword">this</span>.messageTextView = (<span class="type">TextView</span>) itemView.findViewById(<span class="type">R</span>.id.bm_empty_text);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><figure class="highlight aspectj"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">mRecyclerView.setLayoutManager(<span class="keyword">new</span> LinearLayoutManager(getActivity()));</span><br><span class="line">       mAdapter = <span class="keyword">new</span> MultiTypeAdapter();</span><br><span class="line">       mAdapter.register(EmptyData.class,<span class="keyword">new</span> EmptyDataViewProvider());</span><br><span class="line">       mAdapter.register(SendExpressOrder.class,<span class="keyword">new</span> OrderViewProvider(<span class="keyword">new</span> OrderViewProvider.OnItemClickListener() &#123;</span><br><span class="line">           <span class="meta">@Override</span></span><br><span class="line">           <span class="keyword">public</span> <span class="function"><span class="keyword">void</span> <span class="title">onItemClick</span><span class="params">(View view, <span class="keyword">int</span> position, SendExpressOrder order)</span> </span>&#123;</span><br><span class="line">               Intent intent=<span class="keyword">new</span> Intent();</span><br><span class="line">               intent.setClass(getActivity(), JijianSearchDetailActivity.class);</span><br><span class="line">               intent.putExtra(<span class="string">"order"</span>, order);</span><br><span class="line">               startActivity(intent);</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;));</span><br><span class="line">       mRecyclerView.setAdapter(mAdapter);</span><br><span class="line">       mSwipeRefreshLayout.setOnRefreshListener(<span class="keyword">new</span> SwipeRefreshLayout.OnRefreshListener() &#123;</span><br><span class="line">           <span class="meta">@Override</span></span><br><span class="line">           <span class="keyword">public</span> <span class="function"><span class="keyword">void</span> <span class="title">onRefresh</span><span class="params">()</span> </span>&#123;</span><br><span class="line">               <span class="keyword">new</span> Handler().postDelayed(<span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">                   <span class="meta">@Override</span></span><br><span class="line">                   <span class="keyword">public</span> <span class="function"><span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                       searchData();</span><br><span class="line">                   &#125;</span><br><span class="line">               &#125;, <span class="number">1000</span>);</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;);</span><br></pre></td></tr></table></figure><h3 id="下拉刷新"><a href="#下拉刷新" class="headerlink" title="下拉刷新"></a>下拉刷新</h3><p>针对LinearLayoutManager</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">OnLoadMoreListener</span> <span class="keyword">extends</span> <span class="title">RecyclerView</span>.<span class="title">OnScrollListener</span></span>&#123;</span><br><span class="line">    <span class="keyword">private</span> LinearLayoutManager layoutManager;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> itemCount, lastPosition, lastItemCount;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title">onLoadMore</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onScrolled</span><span class="params">(RecyclerView recyclerView, <span class="keyword">int</span> dx, <span class="keyword">int</span> dy)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (recyclerView.getLayoutManager() <span class="keyword">instanceof</span> LinearLayoutManager) &#123;</span><br><span class="line">            layoutManager = (LinearLayoutManager) recyclerView.getLayoutManager();</span><br><span class="line"></span><br><span class="line">            itemCount = layoutManager.getItemCount();</span><br><span class="line">            lastPosition = layoutManager.findLastCompletelyVisibleItemPosition();</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            L.e(<span class="string">"OnLoadMoreListener"</span>, <span class="string">"The OnLoadMoreListener only support LinearLayoutManager"</span>);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> ( lastPosition == itemCount - <span class="number">1</span>) &#123;</span><br><span class="line">            lastItemCount = itemCount;</span><br><span class="line">            <span class="keyword">this</span>.onLoadMore();</span><br><span class="line">        &#125;</span><br><span class="line">        L.d(<span class="string">"itemCount"</span>,itemCount+<span class="string">""</span>);</span><br><span class="line">        L.d(<span class="string">"lastPosition"</span>,lastPosition+<span class="string">""</span>);</span><br><span class="line">        L.d(<span class="string">"lastItemCount"</span>,lastItemCount+<span class="string">""</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>暴露子视图接口</p><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line">public <span class="class"><span class="keyword">class</span> <span class="title">PayMentTempLateProvider</span> <span class="keyword">extends</span> <span class="title">ItemViewBinder&lt;PayMentTempLatePO</span>,<span class="title">PayMentTempLateProvider</span>.<span class="title">ViewHolder&gt;</span> </span>&#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    public <span class="type">PayMentTempLateProvider</span>(<span class="type">OnItemClickListener</span> onItemClickListener) &#123;</span><br><span class="line">        <span class="keyword">this</span>.mOnItemClickListener=onItemClickListener;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public interface <span class="type">OnItemClickListener</span>&#123;</span><br><span class="line">        void onItemClick(<span class="type">View</span> view,int position,<span class="type">PayMentTempLatePO</span> payMentTempLatePO);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="type">OnItemClickListener</span> mOnItemClickListener;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@NonNull</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="type">ViewHolder</span> onCreateViewHolder(<span class="meta">@NonNull</span> <span class="type">LayoutInflater</span> inflater, <span class="meta">@NonNull</span> <span class="type">ViewGroup</span> parent) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="type">ViewHolder</span>(inflater.inflate(<span class="type">R</span>.layout.item_express_template,parent,<span class="literal">false</span>));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> void onBindViewHolder(<span class="meta">@NonNull</span> <span class="type">ViewHolder</span> holder, <span class="meta">@NonNull</span> <span class="type">PayMentTempLatePO</span> item) &#123;</span><br><span class="line">        holder.templateName_tv.setText(item.getTemplateName());</span><br><span class="line">        holder.templatCode.setText(item.getTemplateCode());</span><br><span class="line">        holder.itemView.setOnClickListener(<span class="keyword">new</span> <span class="type">View</span>.<span class="type">OnClickListener</span>() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            public void onClick(<span class="type">View</span> v) &#123;</span><br><span class="line">                mOnItemClickListener.onItemClick(holder.itemView,holder.getLayoutPosition(),item);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">ViewHolder</span> <span class="keyword">extends</span> <span class="title">RecyclerView</span>.<span class="title">ViewHolder</span> </span>&#123;</span><br><span class="line">        <span class="keyword">private</span> <span class="type">TextView</span> templateName_tv;</span><br><span class="line">        <span class="keyword">private</span> <span class="type">TextView</span> templatCode;</span><br><span class="line">        public <span class="type">ViewHolder</span>(<span class="type">View</span> itemView) &#123;</span><br><span class="line">            <span class="keyword">super</span>(itemView);</span><br><span class="line">            templateName_tv = (<span class="type">TextView</span>) itemView.findViewById(<span class="type">R</span>.id.templateName);</span><br><span class="line">            templatCode = (<span class="type">TextView</span>) itemView.findViewById(<span class="type">R</span>.id.templateCode);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>更新ui</p><figure class="highlight aspectj"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line">                   <span class="keyword">public</span> <span class="function"><span class="keyword">void</span> <span class="title">onCompleted</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                       QujianFragment.getInstance().setWeiquItemText(count);</span><br><span class="line">                   &#125;</span><br><span class="line"></span><br><span class="line">                   <span class="meta">@Override</span></span><br><span class="line">                   <span class="keyword">public</span> <span class="function"><span class="keyword">void</span> <span class="title">onError</span><span class="params">(Throwable e)</span> </span>&#123;</span><br><span class="line">                       L.e(e.getMessage());</span><br><span class="line">                       <span class="keyword">if</span> (mSwipeRefreshLayout.isRefreshing()) &#123;</span><br><span class="line">                           mSwipeRefreshLayout.setRefreshing(<span class="keyword">false</span>);</span><br><span class="line">                       &#125;</span><br><span class="line">                       Items items = <span class="keyword">new</span> Items();</span><br><span class="line">                       items.add(<span class="keyword">new</span> EmptyData(<span class="string">"请求失败"</span>));</span><br><span class="line">                       adapter.setItems(items);</span><br><span class="line">                       adapter.notifyDataSetChanged();</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">                   &#125;</span><br><span class="line"></span><br><span class="line">                   <span class="meta">@Override</span></span><br><span class="line">                   <span class="keyword">public</span> <span class="function"><span class="keyword">void</span> <span class="title">onNext</span><span class="params">(ApiPagesResult&lt;SendExpressOrder&gt; listApiResult)</span> </span>&#123;</span><br><span class="line">                       <span class="keyword">if</span> (mSwipeRefreshLayout.isRefreshing()) &#123;</span><br><span class="line">                           mSwipeRefreshLayout.setRefreshing(<span class="keyword">false</span>);</span><br><span class="line">                       &#125;</span><br><span class="line">                       mRecyclerView.scrollToPosition(<span class="number">0</span>);</span><br><span class="line">                       <span class="keyword">if</span> (listApiResult.getFlag().equals(<span class="string">"1"</span>)) &#123;</span><br><span class="line">                           Items items = <span class="keyword">new</span> Items();</span><br><span class="line">                           <span class="keyword">if</span> (listApiResult.getContent().getCount() == <span class="number">0</span>) &#123;</span><br><span class="line">                               items.add(<span class="keyword">new</span> EmptyData());</span><br><span class="line">                           &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                               items.addAll(listApiResult.getContent().getContent());</span><br><span class="line">                               count = listApiResult.getContent().getCount();</span><br><span class="line"></span><br><span class="line">                           &#125;</span><br><span class="line"></span><br><span class="line">                           adapter.setItems(items);</span><br><span class="line">                           adapter.notifyDataSetChanged();</span><br><span class="line"></span><br><span class="line">                       &#125;</span><br><span class="line"></span><br><span class="line">                   &#125;</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;安利一波&lt;br&gt;&lt;figure class=&quot;highlight gradle&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br
      
    
    </summary>
    
      <category term="移动开发" scheme="http://mzeht.com/categories/app/"/>
    
      <category term="Android" scheme="http://mzeht.com/categories/app/Android/"/>
    
    
      <category term="multitype" scheme="http://mzeht.com/tags/multitype/"/>
    
  </entry>
  
  <entry>
    <title>重构到springboot注意事项</title>
    <link href="http://mzeht.com/2017/05/03/2017-05-05-1/"/>
    <id>http://mzeht.com/2017/05/03/2017-05-05-1/</id>
    <published>2017-05-03T13:47:33.000Z</published>
    <updated>2019-04-30T20:33:51.256Z</updated>
    
    <content type="html"><![CDATA[<h2 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h2><p>旧web项目没有采用maven管理依赖包，jsp页面，xml配置环境，mybatis数据库交互，现在改造为springboot项目，最终打包为war包，java命令直接启动，不依赖tomcat容器</p><p>开发环境 idea</p><p>###idea新建springboot项目<br>选择web支持</p><p>生成的项目src／main下有java，resource两个文件夹</p><p>新建第三个文件夹webapp，和之上两个同级，最终<br><img src="http://7xqtsx.com1.z0.glb.clouddn.com/17-5-5/36622722-file_1493976502014_16cc0.png" alt></p><h3 id="jsp依赖配置（同时适配本地运行和打包）"><a href="#jsp依赖配置（同时适配本地运行和打包）" class="headerlink" title="jsp依赖配置（同时适配本地运行和打包）"></a>jsp依赖配置（同时适配本地运行和打包）</h3><p>注意有些依赖改为<code>&lt;scope&gt;compile&lt;/scope&gt;</code>， 参考maven的scope解释(test,runtime,provide,complie)<br>这样通过idea的application或者打包都不会有问题</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-tomcat<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">scope</span>&gt;</span>compile<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-test<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>javax.servlet<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>jstl<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!--用于编译jsp--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.tomcat.embed<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>tomcat-embed-jasper<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">scope</span>&gt;</span>compile<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><p>jsp映射路径</p><figure class="highlight dts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">spring:</span></span><br><span class="line"><span class="symbol">  profiles:</span> dev</span><br><span class="line"><span class="symbol">  mvc:</span></span><br><span class="line"><span class="symbol">    view:</span></span><br><span class="line"><span class="symbol">      prefix:</span> /WEB-INF<span class="meta-keyword">/jsp/</span></span><br><span class="line"><span class="symbol">      suffix:</span> .jsp</span><br></pre></td></tr></table></figure><h3 id="serverlet支持"><a href="#serverlet支持" class="headerlink" title="serverlet支持"></a>serverlet支持</h3><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line">public <span class="class"><span class="keyword">class</span> <span class="title">BootlabbookmanagerApplication</span>  <span class="keyword">extends</span> <span class="title">SpringBootServletInitializer</span></span>&#123;</span><br><span class="line"> <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="type">SpringApplicationBuilder</span> configure(<span class="type">SpringApplicationBuilder</span> application) &#123;</span><br><span class="line">        <span class="keyword">return</span> application.sources(<span class="type">BootlabbookmanagerApplication</span>.<span class="keyword">class</span>);</span><br><span class="line">    &#125;</span><br><span class="line">.......</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>###拦截器，资源映射，</p><figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">@Configuration</span></span><br><span class="line"><span class="variable">@Component</span></span><br><span class="line">public class WebMVCConfig extends WebMvcConfigurerAdapter</span><br><span class="line">&#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="variable">@Bean</span></span><br><span class="line">    public HandlerInterceptor getLoginInterceptor()&#123;</span><br><span class="line">        <span class="selector-tag">return</span> <span class="selector-tag">new</span> <span class="selector-tag">LoginInterceptor</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     *  * &lt;mvc:mapping path="/**" /&gt;</span></span><br><span class="line"><span class="comment">     &lt;mvc:exclude-mapping path="/assets/**" /&gt;</span></span><br><span class="line"><span class="comment">     &lt;mvc:exclude-mapping path="/images/**" /&gt;</span></span><br><span class="line"><span class="comment">     &lt;mvc:exclude-mapping path="/upload/**" /&gt;</span></span><br><span class="line"><span class="comment">     &lt;mvc:exclude-mapping path="/login/**" /&gt;</span></span><br><span class="line"><span class="comment">     &lt;mvc:exclude-mapping path="/register/**" /&gt;</span></span><br><span class="line"><span class="comment">     &lt;mvc:exclude-mapping path="/forgetPassword/**" /&gt;</span></span><br><span class="line"><span class="comment">     &lt;mvc:exclude-mapping path="/check/**" /&gt;</span></span><br><span class="line"><span class="comment">     &lt;mvc:exclude-mapping path="/exists/**" /&gt;</span></span><br><span class="line"><span class="comment">     &lt;mvc:exclude-mapping path="/code/**" /&gt;</span></span><br><span class="line"><span class="comment">     * @param registry</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    @<span class="selector-tag">Override</span></span><br><span class="line">    <span class="selector-tag">public</span> <span class="selector-tag">void</span> <span class="selector-tag">addInterceptors</span>(InterceptorRegistry registry) &#123;</span><br><span class="line">        <span class="selector-tag">registry</span><span class="selector-class">.addInterceptor</span>(getLoginInterceptor())<span class="selector-class">.addPathPatterns</span>(<span class="string">"/**"</span>);</span><br><span class="line">        <span class="selector-tag">registry</span><span class="selector-class">.addInterceptor</span>(getLoginInterceptor())<span class="selector-class">.excludePathPatterns</span>(<span class="string">"/assets/**"</span>,<span class="string">"/images/**"</span>,<span class="string">"/upload/**"</span>,<span class="string">"/login/**"</span>,<span class="string">"/register/**"</span>,<span class="string">"/forgetPassword/**"</span>,<span class="string">"/check/**"</span>,<span class="string">"/exists/**"</span>,<span class="string">"/code/**"</span>);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * &lt;mvc:resources location="/WEB-INF/assets/" mapping="/assets/**" /&gt;</span></span><br><span class="line"><span class="comment">     &lt;mvc:resources location="/WEB-INF/images/" mapping="/images/**" /&gt;</span></span><br><span class="line"><span class="comment">     &lt;mvc:resources location="/upload/" mapping="/upload/**" /&gt;</span></span><br><span class="line"><span class="comment">     * @param registry</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    @<span class="selector-tag">Override</span></span><br><span class="line">    <span class="selector-tag">public</span> <span class="selector-tag">void</span> <span class="selector-tag">addResourceHandlers</span>(ResourceHandlerRegistry registry) &#123;</span><br><span class="line">        <span class="selector-tag">registry</span><span class="selector-class">.addResourceHandler</span>(<span class="string">"/assets/**"</span>)<span class="selector-class">.addResourceLocations</span>(<span class="string">"classpath:/WEB-INF/assets/"</span>);</span><br><span class="line">        <span class="selector-tag">registry</span><span class="selector-class">.addResourceHandler</span>(<span class="string">"/images/**"</span>)<span class="selector-class">.addResourceLocations</span>(<span class="string">"classpath:/WEB-INF/images/"</span>);</span><br><span class="line">        <span class="selector-tag">registry</span><span class="selector-class">.addResourceHandler</span>(<span class="string">"/upload/**"</span>)<span class="selector-class">.addResourceLocations</span>(<span class="string">"classpath:/upload"</span>);</span><br><span class="line">        <span class="selector-tag">super</span><span class="selector-class">.addResourceHandlers</span>(registry);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>注释对象旧web项目中的设置，注意拦截器之中引用service或其他需要注入的变量时</p><p>配置拦截器不能写成以下形式</p><figure class="highlight aspectj"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">void</span> <span class="title">addInterceptors</span><span class="params">(InterceptorRegistry registry)</span> </span>&#123;</span><br><span class="line">        registry.addInterceptor(<span class="keyword">new</span> LoginInterceptor().addPathPatterns(<span class="string">"/**"</span>);</span><br><span class="line">       </span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>必须要提前注入，否则LoginInterceptor中变量注入失败</p><figure class="highlight aspectj"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Bean</span></span><br><span class="line">   <span class="keyword">public</span> <span class="function">HandlerInterceptor <span class="title">getLoginInterceptor</span><span class="params">()</span></span>&#123;</span><br><span class="line">       <span class="keyword">return</span> <span class="keyword">new</span> LoginInterceptor();</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure><h3 id="默认error页面"><a href="#默认error页面" class="headerlink" title="默认error页面"></a>默认error页面</h3><p>Application中</p><figure class="highlight aspectj"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"> <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function">EmbeddedServletContainerCustomizer <span class="title">containerCustomizer</span><span class="params">()</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> EmbeddedServletContainerCustomizer() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="function"><span class="keyword">void</span> <span class="title">customize</span><span class="params">(ConfigurableEmbeddedServletContainer container)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line"><span class="comment">//                ErrorPage error401Page = new ErrorPage(HttpStatus.UNAUTHORIZED, "/401.html");</span></span><br><span class="line">                ErrorPage error404Page = <span class="keyword">new</span> ErrorPage(HttpStatus.NOT_FOUND, <span class="string">"/error"</span>);</span><br><span class="line"><span class="comment">//                ErrorPage error500Page = new ErrorPage(HttpStatus.INTERNAL_SERVER_ERROR, "/500.html");</span></span><br><span class="line"></span><br><span class="line">                container.addErrorPages( error404Page);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><h3 id="全局错误处理"><a href="#全局错误处理" class="headerlink" title="全局错误处理"></a>全局错误处理</h3><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@ControllerAdvice</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">GlobalExceptionHandler</span> &#123;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String DEFAULT_ERROR_VIEW = <span class="string">"error"</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String DEFAULT_NOT_LOG = <span class="string">"login"</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String DEFAULT_INDEX = <span class="string">"index"</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@ExceptionHandler</span>(value = UserNotLoginException.<span class="keyword">class</span>)</span><br><span class="line">    <span class="keyword">public</span> ModelAndView defaultErrorHandler(HttpServletRequest req, Exception e) <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        ModelAndView mav = <span class="keyword">new</span> ModelAndView();</span><br><span class="line">        mav.setViewName(DEFAULT_NOT_LOG);</span><br><span class="line">        <span class="keyword">return</span> mav;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="其他"><a href="#其他" class="headerlink" title="其他"></a>其他</h3><p>数据库源，mybatis，redis之类的就很常规了</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;概述&quot;&gt;&lt;a href=&quot;#概述&quot; class=&quot;headerlink&quot; title=&quot;概述&quot;&gt;&lt;/a&gt;概述&lt;/h2&gt;&lt;p&gt;旧web项目没有采用maven管理依赖包，jsp页面，xml配置环境，mybatis数据库交互，现在改造为springboot项目，最终打包
      
    
    </summary>
    
      <category term="后端开发" scheme="http://mzeht.com/categories/bg/"/>
    
      <category term="java" scheme="http://mzeht.com/categories/bg/java/"/>
    
    
      <category term="springboot" scheme="http://mzeht.com/tags/springboot/"/>
    
  </entry>
  
  <entry>
    <title>老式web项目重构springboot帮助文档</title>
    <link href="http://mzeht.com/2017/05/03/2017-05-05/"/>
    <id>http://mzeht.com/2017/05/03/2017-05-05/</id>
    <published>2017-05-03T12:47:33.000Z</published>
    <updated>2019-04-30T20:33:51.256Z</updated>
    
    <content type="html"><![CDATA[<h2 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h2><ol><li>采用springboot 1.5.3 重构现有项目</li><li>配置文件精简，提高开发效率</li><li>maven管理依赖包</li><li>注解代替xml</li></ol><h2 id="如何启动"><a href="#如何启动" class="headerlink" title="如何启动"></a>如何启动</h2><p>开发时idea<br><code>BootlabbookmanagerApplication</code>文件右侧绿色三角形，启动即可</p><h2 id="如何打包发布"><a href="#如何打包发布" class="headerlink" title="如何打包发布"></a>如何打包发布</h2><h3 id="打包"><a href="#打包" class="headerlink" title="打包"></a>打包</h3><p>本地需要安装maven，添加环境变量<br>项目根目录下</p><figure class="highlight armasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">mvn </span>clean &amp;&amp; <span class="keyword">mvn </span>package -Dmaven.test<span class="meta">.skip</span></span><br></pre></td></tr></table></figure><p>在target目录下生成<br><code>bootlabbookmanager-0.0.1-SNAPSHOT.war</code></p><h3 id="前台运行"><a href="#前台运行" class="headerlink" title="前台运行"></a>前台运行</h3><p>前台启动（命令行启动，退出命令行，进程跟着退出）</p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">java</span> <span class="selector-tag">-jar</span> <span class="selector-tag">bootlabbookmanager-0</span><span class="selector-class">.0</span><span class="selector-class">.1-SNAPSHOT</span><span class="selector-class">.war</span></span><br></pre></td></tr></table></figure><h3 id="发布"><a href="#发布" class="headerlink" title="发布"></a>发布</h3><p>后台运行（命令行关闭后进程仍在，发布到服务器上用）</p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">nohup</span> <span class="selector-tag">java</span> <span class="selector-tag">-jar</span>  <span class="selector-tag">bootlabbookmanager-0</span><span class="selector-class">.0</span><span class="selector-class">.1-SNAPSHOT</span><span class="selector-class">.war</span> &amp;</span><br></pre></td></tr></table></figure><h3 id="重新发布"><a href="#重新发布" class="headerlink" title="重新发布"></a>重新发布</h3><p>查找旧进程并kill</p><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">➜  target git:(master) ✗ ps -ef|grep bootlabbookmanager-0.0.1-SNAPSHOT.war</span><br><span class="line">  501  3524  2794   0 12:25上午 ttys000    0:32.90 /usr/bin/java -jar bootlabbookmanager-0.0.1-SNAPSHOT.war</span><br><span class="line">  501  3536  2794   0 12:25上午 ttys000    0:00.00 grep <span class="attribute">--color</span>=auto <span class="attribute">--exclude-dir</span>=.bzr <span class="attribute">--exclude-dir</span>=CVS <span class="attribute">--exclude-dir</span>=.git <span class="attribute">--exclude-dir</span>=.hg <span class="attribute">--exclude-dir</span>=.svn bootlabbookmanager-0.0.1-SNAPSHOT.war</span><br><span class="line">➜  target git:(master) ✗ kill 3524</span><br><span class="line">➜  target git:(master) ✗ </span><br><span class="line">[1]  + 3524 exit 143   nohup java -jar bootlabbookmanager-0.0.1-SNAPSHOT.war</span><br><span class="line">➜  target git:(master) ✗ ps -ef|grep bootlabbookmanager-0.0.1-SNAPSHOT.war</span><br><span class="line">  501  3580  2794   0 12:27上午 ttys000    0:00.00 grep <span class="attribute">--color</span>=auto <span class="attribute">--exclude-dir</span>=.bzr <span class="attribute">--exclude-dir</span>=CVS <span class="attribute">--exclude-dir</span>=.git <span class="attribute">--exclude-dir</span>=.hg <span class="attribute">--exclude-dir</span>=.svn bootlabbookmanager-0.0.1-SNAPSHOT.war</span><br><span class="line">➜  target git:(master) ✗</span><br></pre></td></tr></table></figure><p>然后替换war包 后台启动新war包</p><h2 id="改造概述"><a href="#改造概述" class="headerlink" title="改造概述"></a>改造概述</h2><p>推荐两本书，电子版／实体<br><code>springboot实战</code><br><code>spring实战第四版</code></p><p>点到即止，零碎知识点可以以下方式查阅资料<br>推荐</p><ol><li><code>简书</code> 很多很好的spring文章和系列博客</li><li><code>stackoverflow</code> </li><li>springboot的官方<code>github</code> 本身就有很多示例了</li></ol><h3 id="添加jsp支持"><a href="#添加jsp支持" class="headerlink" title="添加jsp支持"></a>添加jsp支持</h3><ol><li>Application继承<code>SpringBootServletInitializer</code></li><li>pom文件添加jsp支持，servlet，标签，tomcat等等</li><li>view解析规则配置</li></ol><h3 id="登录拦截器"><a href="#登录拦截器" class="headerlink" title="登录拦截器"></a>登录拦截器</h3><p>见<code>WebMvcConfigurerAdapter</code>–》<code>addInterceptors</code></p><h3 id="资源映射"><a href="#资源映射" class="headerlink" title="资源映射"></a>资源映射</h3><p>见<code>WebMvcConfigurerAdapter</code>–》<code>addResourceHandlers</code></p><h3 id="UserNotLoginException-处理"><a href="#UserNotLoginException-处理" class="headerlink" title="UserNotLoginException 处理"></a>UserNotLoginException 处理</h3><p>见<code>GlobalExceptionHandler</code>–》<code>defaultErrorHandler</code></p><h3 id="全局错误页面处理"><a href="#全局错误页面处理" class="headerlink" title="全局错误页面处理"></a>全局错误页面处理</h3><p>见<code>BootlabbookmanagerApplication</code>–》<br><code>EmbeddedServletContainerCustomizer</code></p><h3 id="Mybatis"><a href="#Mybatis" class="headerlink" title="Mybatis"></a>Mybatis</h3><p>阿里开源druid数据库连接池<br>见<code>LabBookDBConfig</code>，时间问题，未启用数据库连接加密，但加入了监控页面<br>访问<code>http://localhost:8080/druid</code><br>yml文件中找到用户名，密码 登录<br>可查看sql监控，访问，servlet监控</p><p>注意：<code>ApplyPurchaseMapper</code>之类文件要添加注解</p><h3 id="日志配置"><a href="#日志配置" class="headerlink" title="日志配置"></a>日志配置</h3><p>见<code>log4j.xml</code></p><h2 id="其他"><a href="#其他" class="headerlink" title="其他"></a>其他</h2><ol><li>Service 相关类都要<code>@Service</code>注解</li><li><code>@Autowired</code>一般直接标注在变量上，不用set</li><li><code>application.yml</code>可以定义常量</li><li>有兴趣可以用jenkins配置自动发布</li></ol>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;概述&quot;&gt;&lt;a href=&quot;#概述&quot; class=&quot;headerlink&quot; title=&quot;概述&quot;&gt;&lt;/a&gt;概述&lt;/h2&gt;&lt;ol&gt;
&lt;li&gt;采用springboot 1.5.3 重构现有项目&lt;/li&gt;
&lt;li&gt;配置文件精简，提高开发效率&lt;/li&gt;
&lt;li&gt;maven管
      
    
    </summary>
    
      <category term="后端开发" scheme="http://mzeht.com/categories/bg/"/>
    
      <category term="java" scheme="http://mzeht.com/categories/bg/java/"/>
    
    
      <category term="springboot" scheme="http://mzeht.com/tags/springboot/"/>
    
  </entry>
  
  <entry>
    <title>android项目利用cmake方式实现ndk开发</title>
    <link href="http://mzeht.com/2017/04/28/2017-04-28-1/"/>
    <id>http://mzeht.com/2017/04/28/2017-04-28-1/</id>
    <published>2017-04-28T06:53:01.000Z</published>
    <updated>2019-04-30T20:33:51.256Z</updated>
    
    <content type="html"><![CDATA[<h2 id="添加ndk支持"><a href="#添加ndk支持" class="headerlink" title="添加ndk支持"></a>添加ndk支持</h2><p><code>gradle.properties</code>(project properties)</p><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">org.gradle.daemon</span>=<span class="literal">true</span></span><br><span class="line"><span class="attr">org.gradle.jvmargs</span>=-Xmx2048m -XX:MaxPermSize=<span class="number">512</span>m -XX:+HeapDumpOnOutOfMemoryError -Dfile.encoding=UTF-<span class="number">8</span></span><br><span class="line"><span class="attr">org.gradle.parallel</span>=<span class="literal">true</span></span><br><span class="line"><span class="attr">org.gradle.configureondemand</span>=<span class="literal">true</span></span><br><span class="line"><span class="attr">android.useDeprecatedNdk</span>=<span class="literal">true</span></span><br></pre></td></tr></table></figure><h2 id="在需要ndk的模块新建JNI-Folder"><a href="#在需要ndk的模块新建JNI-Folder" class="headerlink" title="在需要ndk的模块新建JNI Folder"></a>在需要ndk的模块新建JNI Folder</h2><p>当前模块下生成了/src/main/jni</p><p>这个文件夹下放置<code>CMakeLists.txt</code>，和c文件<br><img src="http://7xqtsx.com1.z0.glb.clouddn.com/17-4-28/13776882-file_1493364079424_4904.png" alt></p><h2 id="创建CMakeLists-txt"><a href="#创建CMakeLists-txt" class="headerlink" title="创建CMakeLists.txt"></a>创建CMakeLists.txt</h2><p><code>stringutils</code> cmake生成so包命名相关<br>反编译apk，可以发现so包名称为<code>libstringutils.so</code></p><p><code>SHARED</code>之后</p><p>打包进入so包的文件目录，可以多个</p><p><code>cmake_minimum_required(VERSION 3.4.1)</code>默认版本</p><figure class="highlight lisp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">cmake_minimum_required(<span class="name">VERSION</span> <span class="number">3.4</span>.<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">add_library(<span class="name">stringutils</span> SHARED</span><br><span class="line">            stringutils.c)</span><br><span class="line"></span><br><span class="line"># Include libraries needed for stringutils lib</span><br><span class="line">target_link_libraries(<span class="name">stringutils</span> log android)</span><br></pre></td></tr></table></figure><p>##在java文件中创建native方法</p><p>如<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">StringUtils</span> &#123;</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> native String <span class="title">makeSkey</span><span class="params">(String[] <span class="built_in">array</span>, Context context)</span></span>;</span><br><span class="line">    <span class="keyword">static</span> &#123;</span><br><span class="line">        System.loadLibrary(<span class="string">"stringutils"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><h2 id="创建c文件"><a href="#创建c文件" class="headerlink" title="创建c文件"></a>创建c文件</h2><p>在java报红的方法名处查看智能提示，生成c文件</p><p>如</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;jni.h&gt;</span></span></span><br><span class="line"></span><br><span class="line">JNIEXPORT jstring JNICALL</span><br><span class="line">Java_com_mzeht_wp_skbyjni_StringUtils_makeSkey(JNIEnv *env, jclass type, jobjectArray <span class="built_in">array</span>,</span><br><span class="line">                                               jobject context) &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// TODO</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> (*env)-&gt;NewStringUTF(env, <span class="string">"hehe"</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>返回一个“hehe”，运行android项目即可</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;添加ndk支持&quot;&gt;&lt;a href=&quot;#添加ndk支持&quot; class=&quot;headerlink&quot; title=&quot;添加ndk支持&quot;&gt;&lt;/a&gt;添加ndk支持&lt;/h2&gt;&lt;p&gt;&lt;code&gt;gradle.properties&lt;/code&gt;(project properties)
      
    
    </summary>
    
      <category term="移动开发" scheme="http://mzeht.com/categories/app/"/>
    
      <category term="Android" scheme="http://mzeht.com/categories/app/Android/"/>
    
    
      <category term="ndk" scheme="http://mzeht.com/tags/ndk/"/>
    
      <category term="cmake" scheme="http://mzeht.com/tags/cmake/"/>
    
  </entry>
  
  <entry>
    <title>android ndk开发检查包名，签名</title>
    <link href="http://mzeht.com/2017/04/28/2017-04-28-2/"/>
    <id>http://mzeht.com/2017/04/28/2017-04-28-2/</id>
    <published>2017-04-28T06:53:01.000Z</published>
    <updated>2019-04-30T20:33:51.256Z</updated>
    
    <content type="html"><![CDATA[<p>java层传入app的Context，ndk内检查包名和签名特征</p><h2 id="java-native-方法"><a href="#java-native-方法" class="headerlink" title="java native 方法"></a>java native 方法</h2><figure class="highlight aspectj"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">native</span> <span class="function">String <span class="title">getSignIfo</span><span class="params">(Context context)</span></span>;</span><br></pre></td></tr></table></figure><h2 id="c语言调用"><a href="#c语言调用" class="headerlink" title="c语言调用"></a>c语言调用</h2><figure class="highlight moonscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line">JNIEXPORT jstring JNICALL</span><br><span class="line">Java_com_example_hehe_utils_StringUtils_getSignIfo(JNIEnv *env, jclass <span class="built_in">type</span>, jobject obj) &#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    // 获得Context类</span><br><span class="line">    jclass cls = <span class="function"><span class="params">(*env)</span>-&gt;</span>GetObjectClass(env, obj);</span><br><span class="line">    // 得到getPackageManager方法的ID</span><br><span class="line">    jmethodID mid = <span class="function"><span class="params">(*env)</span>-&gt;</span>GetMethodID(env, cls, <span class="string">"getPackageManager"</span>, <span class="string">"()Landroid/content/pm/PackageManager;"</span>);</span><br><span class="line"></span><br><span class="line">    // 获得应用包的管理器</span><br><span class="line">    jobject pm = <span class="function"><span class="params">(*env)</span>-&gt;</span>CallObjectMethod(env, obj, mid);</span><br><span class="line"></span><br><span class="line">    // 得到getPackageName方法的ID</span><br><span class="line"><span class="function">    <span class="title">mid</span> = <span class="params">(*env)</span>-&gt;</span>GetMethodID(env, cls, <span class="string">"getPackageName"</span>, <span class="string">"()Ljava/lang/String;"</span>);</span><br><span class="line">    // 获得当前应用包名</span><br><span class="line">    jstring packageName = <span class="function"><span class="params">(jstring)(*env)</span>-&gt;</span>CallObjectMethod(env, obj, mid);</span><br><span class="line"></span><br><span class="line">//    printf(<span class="string">"%s"</span>,packageName);</span><br><span class="line">//    const jbyte *str = <span class="function"><span class="params">(*env)</span>-&gt;</span>GetStringUTFChars(env, packageName, NULL);</span><br><span class="line">//    __android_log_print(ANDROID_LOG_INFO, <span class="string">"JNITag"</span>,<span class="string">"string From Java To C : %s"</span>, str);</span><br><span class="line"></span><br><span class="line">    // 获得PackageManager类</span><br><span class="line"><span class="function">    <span class="title">cls</span> = <span class="params">(*env)</span>-&gt;</span>GetObjectClass(env, pm);</span><br><span class="line">    // 得到getPackageInfo方法的ID</span><br><span class="line"><span class="function">    <span class="title">mid</span>  = <span class="params">(*env)</span>-&gt;</span>GetMethodID(env, cls, <span class="string">"getPackageInfo"</span>, <span class="string">"(Ljava/lang/String;I)Landroid/content/pm/PackageInfo;"</span>);</span><br><span class="line">    // 获得应用包的信息</span><br><span class="line">    jobject packageInfo = <span class="function"><span class="params">(*env)</span>-&gt;</span>CallObjectMethod(env, pm, mid, packageName, <span class="number">0x40</span>); //GET_SIGNATURES = <span class="number">64</span>;</span><br><span class="line">    // 获得PackageInfo 类</span><br><span class="line"><span class="function">    <span class="title">cls</span> = <span class="params">(*env)</span>-&gt;</span>GetObjectClass(env, packageInfo);</span><br><span class="line">    // 获得签名数组属性的ID</span><br><span class="line">    jfieldID fid = <span class="function"><span class="params">(*env)</span>-&gt;</span>GetFieldID(env, cls, <span class="string">"signatures"</span>, <span class="string">"[Landroid/content/pm/Signature;"</span>);</span><br><span class="line">    // 得到签名数组</span><br><span class="line">    jobjectArray signatures = <span class="function"><span class="params">(jobjectArray)(*env)</span>-&gt;</span>GetObjectField(env, packageInfo, fid);</span><br><span class="line">    // 得到签名</span><br><span class="line">    jobject sign = <span class="function"><span class="params">(*env)</span>-&gt;</span>GetObjectArrayElement(env, signatures, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    // 获得Signature类</span><br><span class="line"><span class="function">    <span class="title">cls</span> = <span class="params">(*env)</span>-&gt;</span>GetObjectClass(env, sign);</span><br><span class="line">    // 得到toCharsString方法的ID</span><br><span class="line"><span class="function">    <span class="title">mid</span> = <span class="params">(*env)</span>-&gt;</span>GetMethodID(env, cls, <span class="string">"toCharsString"</span>, <span class="string">"()Ljava/lang/String;"</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    jstring signString=<span class="function"><span class="params">(jstring)(*env)</span>-&gt;</span>CallObjectMethod(env, sign, mid);</span><br><span class="line">//    const jbyte *singn = <span class="function"><span class="params">(*env)</span>-&gt;</span>GetStringUTFChars(env, signString, NULL);</span><br><span class="line">//    __android_log_print(ANDROID_LOG_INFO, <span class="string">"JNITag"</span>,<span class="string">"string From Java To C : %s"</span>, singn);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> packageName;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><a href="http://blog.csdn.net/grafx/article/details/40403577" target="_blank" rel="noopener">参考链接</a></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;java层传入app的Context，ndk内检查包名和签名特征&lt;/p&gt;
&lt;h2 id=&quot;java-native-方法&quot;&gt;&lt;a href=&quot;#java-native-方法&quot; class=&quot;headerlink&quot; title=&quot;java native 方法&quot;&gt;&lt;/a&gt;java
      
    
    </summary>
    
      <category term="移动开发" scheme="http://mzeht.com/categories/app/"/>
    
      <category term="Android" scheme="http://mzeht.com/categories/app/Android/"/>
    
    
      <category term="ndk" scheme="http://mzeht.com/tags/ndk/"/>
    
  </entry>
  
  <entry>
    <title>jenkins 发布war包到远程tomcat(含脚本)</title>
    <link href="http://mzeht.com/2017/04/28/2017-04-28/"/>
    <id>http://mzeht.com/2017/04/28/2017-04-28/</id>
    <published>2017-04-28T04:53:01.000Z</published>
    <updated>2019-04-30T20:33:51.256Z</updated>
    
    <content type="html"><![CDATA[<h2 id="总体步骤"><a href="#总体步骤" class="headerlink" title="总体步骤"></a>总体步骤</h2><ol><li>配置源码</li><li>编译打包</li><li>ssh传输到远处服务器</li><li>启动远程服务器脚本</li></ol><h3 id="配置代码源"><a href="#配置代码源" class="headerlink" title="配置代码源"></a>配置代码源</h3><p>jenkis上的git插件</p><h3 id="编译打包"><a href="#编译打包" class="headerlink" title="编译打包"></a>编译打包</h3><p>jenkins机器上安装需要的命令工具<br>一般是maven</p><p>构建选项卡中，配置和项目相对应的打包脚本</p><p>如：</p><figure class="highlight armasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">mvn </span>clean &amp;&amp; <span class="keyword">mvn </span>package -Dmaven.test<span class="meta">.skip</span></span><br></pre></td></tr></table></figure><h3 id="传输到远程服务器"><a href="#传输到远程服务器" class="headerlink" title="传输到远程服务器"></a>传输到远程服务器</h3><p>jenkins插件<code>ssh publish</code></p><p>系统设置中配置远程服务器信息（密钥或用户名密码）</p><p><code>构建后操作</code>选项卡中<br>如：<br><img src="http://7xqtsx.com1.z0.glb.clouddn.com/17-4-28/37403645-file_1493355931851_4fe5.png" alt></p><h2 id="启动远程服务器脚本"><a href="#启动远程服务器脚本" class="headerlink" title="启动远程服务器脚本"></a>启动远程服务器脚本</h2><p><code>project_name</code> 生成的war包名称，没有’.war’<br><code>jenkins_dir</code> 本机上jenkins传输来的war包的存储位置<br><code>tomcat_dir</code> 该war包需要放置的tomcat的位置<br><code>shell_name</code> 脚本自身的名称</p><p>test-deploy.sh</p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># !bin/sh</span></span><br><span class="line"><span class="comment"># tomcat路径</span></span><br><span class="line">jenkins_dir=<span class="string">"/root/jenkinsproject"</span></span><br><span class="line">project_name=<span class="string">"delopytest"</span></span><br><span class="line">tomcat_dir=<span class="string">"/usr/apache-tomcat-7.0.70"</span></span><br><span class="line"><span class="comment"># 当前脚本名称</span></span><br><span class="line">shell_name=<span class="string">"test-deploy.sh"</span></span><br><span class="line">pid=`ps -ef | grep <span class="variable">$tomcat_dir</span> | grep -v <span class="variable">$shell_name</span> | grep -v grep | awk <span class="string">'&#123;print $2&#125;'</span>`</span><br><span class="line">echo <span class="string">"old pid:"</span>.<span class="variable">$pid</span></span><br><span class="line"><span class="keyword">if</span> test <span class="string">"$pid"</span></span><br><span class="line">then </span><br><span class="line">  echo <span class="string">"kill old pid: $pid ing"</span></span><br><span class="line">  kill -<span class="number">9</span> <span class="variable">$pid</span></span><br><span class="line">  <span class="comment"># 睡眠10s</span></span><br><span class="line">  sleep <span class="number">10</span>s</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">echo <span class="string">"not find old pid"</span></span><br><span class="line">fi</span><br><span class="line"><span class="comment"># 删除旧的war包及解压文件夹，拷贝新的war包</span></span><br><span class="line">rm -rf <span class="variable">$tomcat_dir</span><span class="regexp">/webapps/</span><span class="variable">$project_name</span>*</span><br><span class="line">cp <span class="variable">$jenkins_dir</span><span class="regexp">/$project_name.war  $tomcat_dir/</span>webapps</span><br><span class="line">sh <span class="variable">$tomcat_dir</span><span class="regexp">/bin/</span>startup.sh</span><br><span class="line">sleep <span class="number">10</span>s</span><br><span class="line"><span class="comment"># 检查启动</span></span><br><span class="line">newpid=`ps -ef | grep <span class="variable">$tomcat_dir</span> | grep -v <span class="variable">$shell_name</span> | grep -v grep | awk <span class="string">'&#123;print $2&#125;'</span>`</span><br><span class="line"><span class="keyword">if</span> test <span class="string">"$newpid"</span></span><br><span class="line">then</span><br><span class="line">echo <span class="string">"new pid:"</span>.<span class="variable">$newpid</span></span><br><span class="line"><span class="keyword">exit</span></span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">echo <span class="string">"not find new pid"</span></span><br><span class="line"><span class="keyword">exit</span> <span class="number">1</span></span><br><span class="line">fi</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;总体步骤&quot;&gt;&lt;a href=&quot;#总体步骤&quot; class=&quot;headerlink&quot; title=&quot;总体步骤&quot;&gt;&lt;/a&gt;总体步骤&lt;/h2&gt;&lt;ol&gt;
&lt;li&gt;配置源码&lt;/li&gt;
&lt;li&gt;编译打包&lt;/li&gt;
&lt;li&gt;ssh传输到远处服务器&lt;/li&gt;
&lt;li&gt;启动远程服务器
      
    
    </summary>
    
      <category term="运维" scheme="http://mzeht.com/categories/operation/"/>
    
    
      <category term="jenkins" scheme="http://mzeht.com/tags/jenkins/"/>
    
      <category term="shell" scheme="http://mzeht.com/tags/shell/"/>
    
  </entry>
  
  <entry>
    <title>Mybatis-plugin收费插件破解</title>
    <link href="http://mzeht.com/2017/02/10/Mybatis-plugin%E6%94%B6%E8%B4%B9%E6%8F%92%E4%BB%B6%E7%A0%B4%E8%A7%A3/"/>
    <id>http://mzeht.com/2017/02/10/Mybatis-plugin收费插件破解/</id>
    <published>2017-02-10T15:53:42.000Z</published>
    <updated>2019-04-30T20:33:51.261Z</updated>
    
    <content type="html"><![CDATA[<p>IDEA版本</p><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">IntelliJ IDEA 2016.3.4</span><br><span class="line">Build #IU-163.12024.16, built on January 31, 2017</span><br><span class="line">Licensed <span class="keyword">to</span><span class="built_in"> lan </span>yu</span><br><span class="line">Subscription is active until February 25, 2017</span><br><span class="line">JRE: 1.8.0_112-release-408-b6 x86_64</span><br><span class="line">JVM: OpenJDK 64-Bit<span class="built_in"> Server </span>VM by JetBrains s.r.o</span><br></pre></td></tr></table></figure><p>Mybatis-plugin版本</p><figure class="highlight avrasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">Version:</span> <span class="number">2.9</span></span><br></pre></td></tr></table></figure><p>插件功能介绍地址</p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http:<span class="regexp">//</span>www.oschina.net<span class="regexp">/p/i</span>ntellij-mybatis-plugin</span><br></pre></td></tr></table></figure><p>破解方法来院地址</p><figure class="highlight llvm"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://myoss.github.io/<span class="number">2016</span>/MyBatis-Plugin-<span class="symbol">%E5</span><span class="symbol">%AD</span><span class="symbol">%A6</span><span class="symbol">%E4</span><span class="symbol">%B9</span><span class="symbol">%A0</span><span class="symbol">%E4</span><span class="symbol">%BD</span><span class="symbol">%BF</span><span class="symbol">%E7</span><span class="symbol">%94</span><span class="symbol">%A8</span>/</span><br></pre></td></tr></table></figure><figure class="highlight crystal"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">➜  IntelliJIdea2016.<span class="number">3</span> git clone <span class="symbol">https:</span>/<span class="regexp">/github.com/myoss</span><span class="regexp">/profile.git</span></span><br><span class="line"><span class="regexp">Cloning into 'profile'...</span></span><br><span class="line"><span class="regexp">remote: Counting objects: 297, done.</span></span><br><span class="line"><span class="regexp">remote: Total 297 (delta 0), reused 0 (delta 0), pack-reused 297</span></span><br><span class="line"><span class="regexp">Receiving objects: 100% (297/</span><span class="number">297</span>), <span class="number">87.32</span> KiB | <span class="number">143.00</span> KiB/s, done.</span><br><span class="line">Resolving <span class="symbol">deltas:</span> <span class="number">100</span>% (<span class="number">90</span>/<span class="number">90</span>), done.</span><br><span class="line">➜  IntelliJIdea2016.<span class="number">3</span> ls</span><br><span class="line">ECTranslation1.<span class="number">3</span>.jar     GsonFormat.jar           Sexy_Editor.jar          availables.xml           idea-gitignore           jvm-memory-view          mybatis_plus</span><br><span class="line">GenerateSerialVersionUID MavenRunHelper           TranslationPlugin        codehelper.generator     jr-ide-idea              lombok-plugin            profile</span><br><span class="line">➜  IntelliJIdea2016.<span class="number">3</span> cd mybatis_plus</span><br><span class="line">➜  mybatis_plus ls</span><br><span class="line"><span class="class"><span class="keyword">lib</span></span></span><br><span class="line">➜  mybatis_plus cd <span class="class"><span class="keyword">lib</span></span></span><br><span class="line">➜  <span class="class"><span class="keyword">lib</span> <span class="title">ls</span></span></span><br><span class="line">mybatis-generator-core-<span class="number">1.3</span>.<span class="number">2</span>.jar mybatis_plus.jar                 ref.idea.common-<span class="number">1.0</span>.jar</span><br><span class="line">➜  <span class="class"><span class="keyword">lib</span> <span class="title">cp</span> -<span class="title">R</span> ~/<span class="title">Library</span>/<span class="title">Application</span>\ <span class="title">Support</span>/<span class="title">IntelliJIdea2016</span>.3/<span class="title">profile</span>/<span class="title">idea</span>/<span class="title">plugin</span></span></span><br><span class="line"><span class="symbol">usage:</span> cp [-R [-H | -L | -P]] [-fi | -n] [-apvX] source_file target_file</span><br><span class="line">       cp [-R [-H | -L | -P]] [-fi | -n] [-apvX] source_file ... target_directory</span><br><span class="line">➜  <span class="class"><span class="keyword">lib</span> <span class="title">cp</span> -<span class="title">R</span> ~/<span class="title">Library</span>/<span class="title">Application</span>\ <span class="title">Support</span>/<span class="title">IntelliJIdea2016</span>.3/<span class="title">profile</span>/<span class="title">idea</span>/<span class="title">plugin</span>/<span class="title">MybatisPlugin</span>/<span class="title">v2</span>.7\~<span class="title">v2</span>.87 .</span></span><br><span class="line">➜  <span class="class"><span class="keyword">lib</span> <span class="title">ls</span></span></span><br><span class="line">mybatis-generator-core-<span class="number">1.3</span>.<span class="number">2</span>.jar mybatis_plus.jar                 ref.idea.common-<span class="number">1.0</span>.jar          v2.<span class="number">7</span>~v2.<span class="number">87</span></span><br><span class="line">➜  <span class="class"><span class="keyword">lib</span> <span class="title">cp</span> -<span class="title">R</span> ~/<span class="title">Library</span>/<span class="title">Application</span>\ <span class="title">Support</span>/<span class="title">IntelliJIdea2016</span>.3/<span class="title">profile</span>/<span class="title">idea</span>/<span class="title">plugin</span>/<span class="title">MybatisPlugin</span>/<span class="title">v2</span>.7\~<span class="title">v2</span>.87 .</span></span><br><span class="line">➜  <span class="class"><span class="keyword">lib</span> <span class="title">ls</span></span></span><br><span class="line">mybatis-generator-core-<span class="number">1.3</span>.<span class="number">2</span>.jar mybatis_plus.jar                 ref.idea.common-<span class="number">1.0</span>.jar          v2.<span class="number">7</span>~v2.<span class="number">87</span></span><br><span class="line">➜  <span class="class"><span class="keyword">lib</span> <span class="title">cp</span> -<span class="title">R</span> ~/<span class="title">Library</span>/<span class="title">Application</span>\ <span class="title">Support</span>/<span class="title">IntelliJIdea2016</span>.3/<span class="title">profile</span>/<span class="title">idea</span>/<span class="title">plugin</span>/<span class="title">MybatisPlugin</span>/<span class="title">v2</span>.7\~<span class="title">v2</span>.87/<span class="title">com</span> .</span></span><br><span class="line">➜  <span class="class"><span class="keyword">lib</span> <span class="title">ls</span></span></span><br><span class="line">com                              mybatis-generator-core-<span class="number">1.3</span>.<span class="number">2</span>.jar mybatis_plus.jar                 ref.idea.common-<span class="number">1.0</span>.jar          v2.<span class="number">7</span>~v2.<span class="number">87</span></span><br><span class="line">➜  <span class="class"><span class="keyword">lib</span> <span class="title">jar</span> <span class="title">uvf</span> <span class="title">mybatis_plus</span>.<span class="title">jar</span> <span class="title">com</span></span></span><br><span class="line"></span><br><span class="line">正在添加: com/(输入 = <span class="number">0</span>) (输出 = <span class="number">0</span>)(存储了 <span class="number">0</span>%)</span><br><span class="line">正在添加: com/seventh7/(输入 = <span class="number">0</span>) (输出 = <span class="number">0</span>)(存储了 <span class="number">0</span>%)</span><br><span class="line">正在添加: com/seventh7/mybatis/(输入 = <span class="number">0</span>) (输出 = <span class="number">0</span>)(存储了 <span class="number">0</span>%)</span><br><span class="line">正在添加: com/seventh7/mybatis/dom/(输入 = <span class="number">0</span>) (输出 = <span class="number">0</span>)(存储了 <span class="number">0</span>%)</span><br><span class="line">正在添加: com/seventh7/mybatis/dom/model/(输入 = <span class="number">0</span>) (输出 = <span class="number">0</span>)(存储了 <span class="number">0</span>%)</span><br><span class="line">正在添加: com/seventh7/mybatis/ref/(输入 = <span class="number">0</span>) (输出 = <span class="number">0</span>)(存储了 <span class="number">0</span>%)</span><br><span class="line">正在添加: com/seventh7/mybatis/ref/license/(输入 = <span class="number">0</span>) (输出 = <span class="number">0</span>)(存储了 <span class="number">0</span>%)</span><br><span class="line">正在添加: com/seventh7/mybatis/ref/license/ActivationDriver$<span class="number">1</span>.<span class="keyword">class</span>(输入 = <span class="number">1926</span>) (输出 = <span class="number">797</span>)(压缩了 <span class="number">58</span>%)</span><br><span class="line">正在添加: com/seventh7/mybatis/ref/license/ActivationDriver.<span class="keyword">class</span>(输入 = <span class="number">1398</span>) (输出 = <span class="number">656</span>)(压缩了 <span class="number">53</span>%)</span><br><span class="line">正在添加: com/seventh7/mybatis/ref/RefProject$<span class="number">1</span>.<span class="keyword">class</span>(输入 = <span class="number">2224</span>) (输出 = <span class="number">1092</span>)(压缩了 <span class="number">50</span>%)</span><br><span class="line">正在添加: com/seventh7/mybatis/ref/RefProject.<span class="keyword">class</span>(输入 = <span class="number">1982</span>) (输出 = <span class="number">919</span>)(压缩了 <span class="number">53</span>%)</span><br><span class="line">正在添加: com/seventh7/mybatis/service/(输入 = <span class="number">0</span>) (输出 = <span class="number">0</span>)(存储了 <span class="number">0</span>%)</span><br><span class="line">正在添加: com/seventh7/mybatis/service/JavaService$<span class="number">1</span>.<span class="keyword">class</span>(输入 = <span class="number">1408</span>) (输出 = <span class="number">613</span>)(压缩了 <span class="number">56</span>%)</span><br><span class="line">正在添加: com/seventh7/mybatis/service/JavaService$<span class="number">2</span>.<span class="keyword">class</span>(输入 = <span class="number">1312</span>) (输出 = <span class="number">575</span>)(压缩了 <span class="number">56</span>%)</span><br><span class="line">正在添加: com/seventh7/mybatis/service/JavaService.<span class="keyword">class</span>(输入 = <span class="number">10921</span>) (输出 = <span class="number">4166</span>)(压缩了 <span class="number">61</span>%)</span><br><span class="line">正在添加: com/seventh7/mybatis/util/(输入 = <span class="number">0</span>) (输出 = <span class="number">0</span>)(存储了 <span class="number">0</span>%)</span><br><span class="line">正在添加: com/seventh7/mybatis/util/JavaUtils$SystemData.<span class="keyword">class</span>(输入 = <span class="number">3412</span>) (输出 = <span class="number">1602</span>)(压缩了 <span class="number">53</span>%)</span><br><span class="line">正在添加: com/seventh7/mybatis/util/JavaUtils.<span class="keyword">class</span>(输入 = <span class="number">13339</span>) (输出 = <span class="number">4773</span>)(压缩了 <span class="number">64</span>%)</span><br><span class="line">正在添加: com/seventh7/mybatis/dom/model/Completion.<span class="keyword">class</span>(输入 = <span class="number">1663</span>) (输出 = <span class="number">923</span>)(压缩了 <span class="number">44</span>%)</span><br><span class="line">➜  <span class="class"><span class="keyword">lib</span> <span class="title">ls</span></span></span><br><span class="line">com                              mybatis-generator-core-<span class="number">1.3</span>.<span class="number">2</span>.jar mybatis_plus.jar                 ref.idea.common-<span class="number">1.0</span>.jar          v2.<span class="number">7</span>~v2.<span class="number">87</span></span><br><span class="line">➜  <span class="class"><span class="keyword">lib</span> <span class="title">rm</span> -<span class="title">rf</span> <span class="title">v2</span>.7\~<span class="title">v2</span>.87</span></span><br><span class="line">➜  <span class="class"><span class="keyword">lib</span> <span class="title">ls</span></span></span><br><span class="line">com                              mybatis-generator-core-<span class="number">1.3</span>.<span class="number">2</span>.jar mybatis_plus.jar                 ref.idea.common-<span class="number">1.0</span>.jar</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;IDEA版本&lt;/p&gt;
&lt;figure class=&quot;highlight routeros&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/spa
      
    
    </summary>
    
      <category term="工具" scheme="http://mzeht.com/categories/tool/"/>
    
      <category term="破解" scheme="http://mzeht.com/categories/tool/%E7%A0%B4%E8%A7%A3/"/>
    
    
      <category term="Mybatis" scheme="http://mzeht.com/tags/Mybatis/"/>
    
      <category term="IDEA" scheme="http://mzeht.com/tags/IDEA/"/>
    
  </entry>
  
  <entry>
    <title>Centos下docker导致的升级内核</title>
    <link href="http://mzeht.com/2017/02/01/Centos%E4%B8%8Bdocker%E5%AF%BC%E8%87%B4%E7%9A%84%E5%8D%87%E7%BA%A7%E5%86%85%E6%A0%B8/"/>
    <id>http://mzeht.com/2017/02/01/Centos下docker导致的升级内核/</id>
    <published>2017-02-01T05:50:42.000Z</published>
    <updated>2019-04-30T20:33:51.259Z</updated>
    
    <content type="html"><![CDATA[<p>接着上一篇文章</p><p>形如下面的错误出现了</p><figure class="highlight crystal"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ docker run --rm -ti <span class="symbol">ubuntu:</span><span class="number">14.04</span> bin/bash                                       </span><br><span class="line">FATA[<span class="number">0</span>000] Error response from <span class="symbol">daemon:</span> mkdir /var/<span class="class"><span class="keyword">lib</span>/<span class="title">docker</span>/<span class="title">overlay</span>/<span class="title">c4a8f5e516d401534f2d994f5546f7e08639ffd675eb3573267f76d79394f172</span>-<span class="title">init</span>/<span class="title">merged</span>/<span class="title">dev</span>/<span class="title">shm</span>: <span class="title">invalid</span> <span class="title">argument</span></span></span><br></pre></td></tr></table></figure><p>Centos下安装docker正常，拉取镜像正常，就在启动容器的时候报错<br><a id="more"></a></p><p>一番谷歌，github</p><p><a href="https://github.com/docker/docker/issues/10294" target="_blank" rel="noopener">https://github.com/docker/docker/issues/10294</a></p><h1 id="首先检查docker-info"><a href="#首先检查docker-info" class="headerlink" title="首先检查docker info"></a>首先检查docker info</h1><p>如果有</p><figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">WARNING: </span>bridge-nf-call-iptables is disabled</span><br><span class="line"><span class="symbol">WARNING: </span>bridge-nf-call-ip6tables is disabled</span><br></pre></td></tr></table></figure><p>就需要添加内核参数，具体看上一篇</p><p>之后看到</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">Fixed...</span><br><span class="line"></span><br><span class="line">from docker official site.</span><br><span class="line"></span><br><span class="line">To configure Docker to <span class="keyword">use</span> the overlay <span class="keyword">storage</span> driver your Docker host must be running <span class="keyword">version</span> <span class="number">3.18</span> <span class="keyword">of</span> the Linux kernel (preferably newer) <span class="keyword">with</span> the overlay kernel <span class="keyword">module</span> loaded. OverlayFS can operate <span class="keyword">on</span> top <span class="keyword">of</span> most supported Linux filesystems. However, ext4 <span class="keyword">is</span> currently recommended <span class="keyword">for</span> <span class="keyword">use</span> <span class="keyword">in</span> production environments.</span><br><span class="line">so, <span class="keyword">update</span> kernel <span class="keyword">from</span> <span class="number">3.10</span><span class="number">.0</span> <span class="keyword">to</span> <span class="number">3.18</span><span class="number">.0</span> + <span class="keyword">fixed</span> the issue.</span><br></pre></td></tr></table></figure><p>提示我们要升级Centos内核3.10.0 to 3.18.0 + </p><h1 id="升级内核"><a href="#升级内核" class="headerlink" title="升级内核"></a>升级内核</h1><h2 id="查看机器内核版本"><a href="#查看机器内核版本" class="headerlink" title="查看机器内核版本"></a>查看机器内核版本</h2><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">uname</span> <span class="selector-tag">-r</span></span><br><span class="line">4<span class="selector-class">.9</span><span class="selector-class">.6-1</span><span class="selector-class">.el7</span><span class="selector-class">.elrepo</span><span class="selector-class">.x86_64</span></span><br></pre></td></tr></table></figure><p>这里我是升级后在写的文章，升级之前是3.10</p><h2 id="查看Linux各版本内核"><a href="#查看Linux各版本内核" class="headerlink" title="查看Linux各版本内核"></a>查看Linux各版本内核</h2><p><a href="https://www.kernel.org/" target="_blank" rel="noopener">网站地址</a></p><p><img src="http://7xqtsx.com1.z0.glb.clouddn.com/17-2-1/55278371-file_1485959943374_7bc7.png" alt></p><p>稳定版 4.9.7</p><h2 id="导入key"><a href="#导入key" class="headerlink" title="导入key"></a>导入key</h2><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rpm --<span class="keyword">import</span> <span class="string">https:</span><span class="comment">//www.elrepo.org/RPM-GPG-KEY-elrepo.org</span></span><br></pre></td></tr></table></figure><h2 id="安装elrepo的yum源"><a href="#安装elrepo的yum源" class="headerlink" title="安装elrepo的yum源"></a>安装elrepo的yum源</h2><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rpm -Uvh <span class="string">http:</span><span class="comment">//www.elrepo.org/elrepo-release-7.0-2.el7.elrepo.noarch.rpm</span></span><br></pre></td></tr></table></figure><h2 id="安装内核"><a href="#安装内核" class="headerlink" title="安装内核"></a>安装内核</h2><figure class="highlight stata"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum --enablerepo=elrepo-kernel install  kernel-<span class="keyword">ml</span>-devel kernel-<span class="keyword">ml</span> -<span class="built_in">y</span></span><br></pre></td></tr></table></figure><h2 id="查看默认启动顺序"><a href="#查看默认启动顺序" class="headerlink" title="查看默认启动顺序"></a>查看默认启动顺序</h2><figure class="highlight lsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">awk -F\' '$<span class="number">1</span>==<span class="string">"menuentry "</span> &#123;print $<span class="number">2</span>&#125;' /etc/grub2.cfg</span><br><span class="line">CentOS Linux (<span class="number">4.9</span><span class="number">.6</span><span class="number">-1.</span>el7.elrepo.x86_64) <span class="number">7</span> (Core)</span><br><span class="line">CentOS Linux (<span class="number">3.10</span><span class="number">.0</span><span class="number">-514.2</span><span class="number">.2</span>.el7.x86_64) <span class="number">7</span> (Core)</span><br><span class="line">CentOS Linux (<span class="number">3.10</span><span class="number">.0</span><span class="number">-327.22</span><span class="number">.2</span>.el7.x86_64) <span class="number">7</span> (Core)</span><br><span class="line">CentOS Linux (<span class="number">3.10</span><span class="number">.0</span><span class="number">-327.</span>el7.x86_64) <span class="number">7</span> (Core)</span><br><span class="line">CentOS Linux (<span class="number">0</span>-rescue<span class="number">-7</span>d26c16f128042a684ea474c9e2c240f) <span class="number">7</span> (Core)</span><br></pre></td></tr></table></figure><h2 id="调整启动顺序"><a href="#调整启动顺序" class="headerlink" title="调整启动顺序"></a>调整启动顺序</h2><figure class="highlight actionscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">grub2-<span class="keyword">set</span>-<span class="keyword">default</span> <span class="number">0</span></span><br></pre></td></tr></table></figure><h2 id="重新启动"><a href="#重新启动" class="headerlink" title="重新启动"></a>重新启动</h2><figure class="highlight ebnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">reboot</span></span><br></pre></td></tr></table></figure><h2 id="验证"><a href="#验证" class="headerlink" title="验证"></a>验证</h2><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"> <span class="selector-tag">uname</span> <span class="selector-tag">-r</span></span><br><span class="line">4<span class="selector-class">.9</span><span class="selector-class">.6-1</span><span class="selector-class">.el7</span><span class="selector-class">.elrepo</span><span class="selector-class">.x86_64</span></span><br></pre></td></tr></table></figure><p>成功</p>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;接着上一篇文章&lt;/p&gt;
&lt;p&gt;形如下面的错误出现了&lt;/p&gt;
&lt;figure class=&quot;highlight crystal&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;$ docker run --rm -ti &lt;span class=&quot;symbol&quot;&gt;ubuntu:&lt;/span&gt;&lt;span class=&quot;number&quot;&gt;14.04&lt;/span&gt; bin/bash                                       &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;FATA[&lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;000] Error response from &lt;span class=&quot;symbol&quot;&gt;daemon:&lt;/span&gt; mkdir /var/&lt;span class=&quot;class&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;lib&lt;/span&gt;/&lt;span class=&quot;title&quot;&gt;docker&lt;/span&gt;/&lt;span class=&quot;title&quot;&gt;overlay&lt;/span&gt;/&lt;span class=&quot;title&quot;&gt;c4a8f5e516d401534f2d994f5546f7e08639ffd675eb3573267f76d79394f172&lt;/span&gt;-&lt;span class=&quot;title&quot;&gt;init&lt;/span&gt;/&lt;span class=&quot;title&quot;&gt;merged&lt;/span&gt;/&lt;span class=&quot;title&quot;&gt;dev&lt;/span&gt;/&lt;span class=&quot;title&quot;&gt;shm&lt;/span&gt;: &lt;span class=&quot;title&quot;&gt;invalid&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;argument&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;Centos下安装docker正常，拉取镜像正常，就在启动容器的时候报错&lt;br&gt;
    
    </summary>
    
      <category term="运维" scheme="http://mzeht.com/categories/operation/"/>
    
      <category term="docker" scheme="http://mzeht.com/categories/operation/docker/"/>
    
    
      <category term="Centos" scheme="http://mzeht.com/tags/Centos/"/>
    
  </entry>
  
  <entry>
    <title>Centos下docker部署rap</title>
    <link href="http://mzeht.com/2017/02/01/Centos%E4%B8%8Bdocker%E9%83%A8%E7%BD%B2rap/"/>
    <id>http://mzeht.com/2017/02/01/Centos下docker部署rap/</id>
    <published>2017-02-01T05:43:42.000Z</published>
    <updated>2019-04-30T20:33:51.259Z</updated>
    
    <content type="html"><![CDATA[<p><a href="http://rap.taobao.org/org/index.do" target="_blank" rel="noopener">rap官网</a><br><a href="https://github.com/thx/RAP/wiki/home_cn" target="_blank" rel="noopener">rapgithub地址</a></p><p>RAP是一个GUI的WEB接口管理工具。在RAP中，您可定义接口的URL、请求&amp;响应细节格式等等。通过分析这些数据，RAP提供MOCK服务、测试服务等自动化工具。RAP同时提供大量企业级功能，帮助企业和团队高效的工作。</p><p>在前后端分离的开发模式下，我们通常需要定义一份接口文档来规范接口的具体信息。如一个请求的地址、有几个参数、参数名称及类型含义等等。RAP 首先方便团队录入、查看和管理这些接口文档，并通过分析结构化的文档数据，重复利用并生成自测数据、提供自测控制台等等… 大幅度提升开发效率</p><a id="more"></a><p>1.<code>强大的GUI工具</code> 给力的用户体验，你将会爱上使用RAP来管理您的API文档。<br>2.<code>完善的MOCK服务</code> 文档定义好的瞬间，所有接口已经准备就绪。有了MockJS，无论您的业务模型有多复杂，它都能很好的满足。</p><h1 id="安装docker"><a href="#安装docker" class="headerlink" title="安装docker"></a>安装docker</h1><p>由于我是在阿里云上的服务器</p><h2 id="采用阿里云的脚本进行安装"><a href="#采用阿里云的脚本进行安装" class="headerlink" title="采用阿里云的脚本进行安装"></a>采用阿里云的脚本进行安装</h2><figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl -sSL http://acs-public-mirror.oss-<span class="keyword">cn</span>-hangzhou.aliyuncs.<span class="keyword">com</span>/docker-engine/internet | <span class="keyword">sh</span> -</span><br></pre></td></tr></table></figure><h2 id="添加内核参数"><a href="#添加内核参数" class="headerlink" title="添加内核参数"></a>添加内核参数</h2><p>默认配置下，在 CentOS 使用 Docker 可能会碰到下面的这些警告信息：</p><figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">WARNING: </span>bridge-nf-call-iptables is disabled</span><br><span class="line"><span class="symbol">WARNING: </span>bridge-nf-call-ip6tables is disabled</span><br></pre></td></tr></table></figure><p>很不巧我就遇到了</p><p>添加内核配置参数以启用这些功能。</p><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ sudo tee -<span class="selector-tag">a</span> /etc/sysctl<span class="selector-class">.conf</span> &lt;&lt;-EOF</span><br><span class="line">net<span class="selector-class">.bridge</span><span class="selector-class">.bridge-nf-call-ip6tables</span> = <span class="number">1</span></span><br><span class="line">net<span class="selector-class">.bridge</span><span class="selector-class">.bridge-nf-call-iptables</span> = <span class="number">1</span></span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><p>然后重新加载 sysctl.conf</p><figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$ </span>sudo sysctl -p</span><br></pre></td></tr></table></figure><h1 id="配置加速器"><a href="#配置加速器" class="headerlink" title="配置加速器"></a>配置加速器</h1><p> 参考阿里云论坛的一篇文章<a href="https://yq.aliyun.com/articles/29941" target="_blank" rel="noopener">here</a></p><p>CentOS的配置方式略微复杂，需要先将默认的配置文件复制出来<br>/lib/systemd/system/docker.service -&gt; /etc/systemd/system/docker.service<br>然后再将加速器地址添加到配置文件的启动命令<br>重启Docker就可以了。</p><figure class="highlight crystal"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">sudo cp -n /<span class="class"><span class="keyword">lib</span>/<span class="title">systemd</span>/<span class="title">system</span>/<span class="title">docker</span>.<span class="title">service</span> /<span class="title">etc</span>/<span class="title">systemd</span>/<span class="title">system</span>/<span class="title">docker</span>.<span class="title">service</span></span></span><br><span class="line">sudo sed -i <span class="string">"s|ExecStart=/usr/bin/docker daemon|ExecStart=/usr/bin/docker daemon --registry-mirror=&lt;your accelerate address&gt;|g"</span> /etc/systemd/system/docker.service</span><br><span class="line">sudo systemctl daemon-reload</span><br><span class="line">sudo service docker restart</span><br></pre></td></tr></table></figure><p>your accelerate address 处填入阿里云账号分配的加速器地址</p><h1 id="拉取镜像"><a href="#拉取镜像" class="headerlink" title="拉取镜像"></a>拉取镜像</h1><figure class="highlight inform7"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">docker search rap</span><br><span class="line">NAME                            DESCRIPTION                                     STARS     OFFICIAL   AUTOMATED</span><br><span class="line">neo4j                           Neo4j <span class="keyword">is</span> a highly scalable, robust native ...   282       <span class="comment">[OK]</span></span><br><span class="line">r-base                          R <span class="keyword">is</span> a system for statistical computation ...   147       <span class="comment">[OK]</span></span><br><span class="line">arangodb                        ArangoDB - a distributed database with a f...   78        <span class="comment">[OK]</span></span><br><span class="line">orientdb                        OrientDB a Multi-Model <span class="keyword">Open</span> Source NoSQL D...   46        <span class="comment">[OK]</span></span><br><span class="line">ubuntu-debootstrap              debootstrap --variant=minbase --components...   27        <span class="comment">[OK]</span></span><br><span class="line">rapidftr/rapidftr               UNICEF RapidFTR (Family Tracing and Reunif...   2                    <span class="comment">[OK]</span></span><br><span class="line">rapi/psgi                       Image for running PSGI apps, comes with Ra...   2                    <span class="comment">[OK]</span></span><br><span class="line">huangfushun/rap                 ali rap web ui docker file                      1                    <span class="comment">[OK]</span></span><br><span class="line">lihuansse/rap                   RAP 接口管理工具                                      1</span><br><span class="line">masonliu/rap                    Docker Image for RAP https://github.com/th...   1</span><br><span class="line">rapidoid                        Rapidoid <span class="keyword">is</span> a high-performance HTTP server...   1         <span class="comment">[OK]</span></span><br><span class="line">ukgovdatascience/rap-docker     Environment for reproducible analytical pi...   0                    <span class="comment">[OK]</span></span><br><span class="line">rapidreg/rapidreg                                                               0                    <span class="comment">[OK]</span></span><br><span class="line">raphiz/raphael.li                                                               0                    <span class="comment">[OK]</span></span><br><span class="line">rapi/rapidapp                   Standard RapidApp base image, from officia...   0                    <span class="comment">[OK]</span></span><br><span class="line">team19awshack/rapidprowebhook   RapidProWebhook                                 0                    <span class="comment">[OK]</span></span><br><span class="line">tp81/rapidstorm                 RapidSTORM docker image                         0                    <span class="comment">[OK]</span></span><br><span class="line">qdsang/rap                      docker rap alpine                               0                    <span class="comment">[OK]</span></span><br><span class="line">raphsfeir/raphaelsfeir          Portfolio and blog for me                       0                    <span class="comment">[OK]</span></span><br><span class="line">rapidpro/rapidpro-base          Base Python 2.7 + geolibs Docker image for...   0                    <span class="comment">[OK]</span></span><br><span class="line">tonimichel/rapidflask           A boilerplate flask application for easy s...   0                    <span class="comment">[OK]</span></span><br><span class="line">andreweskeclarke/rapidftr                                                       0                    <span class="comment">[OK]</span></span><br><span class="line">raphiz/mathe.raphael.li                                                         0                    <span class="comment">[OK]</span></span><br><span class="line">raphaelgroup/magi                                                               0                    <span class="comment">[OK]</span></span><br><span class="line">divio/rapidpro                  RapidPro in docker.                             0                    <span class="comment">[OK]</span></span><br></pre></td></tr></table></figure><p>这里选择lihuansse/rap</p><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">docker</span> pull lihuansse/rap</span><br></pre></td></tr></table></figure><p>创建并启动</p><figure class="highlight applescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker <span class="built_in">run</span> <span class="comment">--name rap -p 8080:8080 -d lihuansse/rap:latest</span></span><br></pre></td></tr></table></figure><p>然而就在即将完成这最后一步的时候</p><p>形如下面的错误出现了</p><figure class="highlight crystal"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ docker run --rm -ti <span class="symbol">ubuntu:</span><span class="number">14.04</span> bin/bash                                       </span><br><span class="line">FATA[<span class="number">0</span>000] Error response from <span class="symbol">daemon:</span> mkdir /var/<span class="class"><span class="keyword">lib</span>/<span class="title">docker</span>/<span class="title">overlay</span>/<span class="title">c4a8f5e516d401534f2d994f5546f7e08639ffd675eb3573267f76d79394f172</span>-<span class="title">init</span>/<span class="title">merged</span>/<span class="title">dev</span>/<span class="title">shm</span>: <span class="title">invalid</span> <span class="title">argument</span></span></span><br></pre></td></tr></table></figure><p>请看下回分解</p>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;&lt;a href=&quot;http://rap.taobao.org/org/index.do&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;rap官网&lt;/a&gt;&lt;br&gt;&lt;a href=&quot;https://github.com/thx/RAP/wiki/home_cn&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;rapgithub地址&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;RAP是一个GUI的WEB接口管理工具。在RAP中，您可定义接口的URL、请求&amp;amp;响应细节格式等等。通过分析这些数据，RAP提供MOCK服务、测试服务等自动化工具。RAP同时提供大量企业级功能，帮助企业和团队高效的工作。&lt;/p&gt;
&lt;p&gt;在前后端分离的开发模式下，我们通常需要定义一份接口文档来规范接口的具体信息。如一个请求的地址、有几个参数、参数名称及类型含义等等。RAP 首先方便团队录入、查看和管理这些接口文档，并通过分析结构化的文档数据，重复利用并生成自测数据、提供自测控制台等等… 大幅度提升开发效率&lt;/p&gt;
    
    </summary>
    
      <category term="运维" scheme="http://mzeht.com/categories/operation/"/>
    
      <category term="docker" scheme="http://mzeht.com/categories/operation/docker/"/>
    
    
      <category term="Centos" scheme="http://mzeht.com/tags/Centos/"/>
    
  </entry>
  
</feed>
