<!doctype html>



  


<html class="theme-next pisces use-motion">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>



<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />












  <link href="/vendors/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css"/>




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  




<link href="/vendors/font-awesome/css/font-awesome.min.css?v=4.4.0" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.0.1" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="Hexo, NexT" />





  <link rel="alternate" href="/atom.xml" title="my soul your beats" type="application/atom+xml" />




  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.0.1" />






<meta name="description" content="学习总结 思考感悟 知识管理">
<meta property="og:type" content="website">
<meta property="og:title" content="my soul your beats">
<meta property="og:url" content="http://mzeht.com/index.html">
<meta property="og:site_name" content="my soul your beats">
<meta property="og:description" content="学习总结 思考感悟 知识管理">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="my soul your beats">
<meta name="twitter:description" content="学习总结 思考感悟 知识管理">



<script type="text/javascript" id="hexo.configuration">
  var NexT = window.NexT || {};
  var CONFIG = {
    scheme: 'Pisces',
    sidebar: {"position":"left","display":"post"},
    fancybox: true,
    motion: true,
    duoshuo: {
      userId: 0,
      author: 'Author'
    }
  };
</script>

  <title> my soul your beats </title>
</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="en">

  










  
  
    
  

  <div class="container one-collumn sidebar-position-left 
  
 ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-meta ">
  

  <div class="custom-logo-site-title">
    <a href="/"  class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <span class="site-title">my soul your beats</span>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>
  <p class="site-subtitle"></p>
</div>

<div class="site-nav-toggle">
  <button>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
  </button>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-home fa-fw"></i> <br />
            
            Home
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories" rel="section">
            
              <i class="menu-item-icon fa fa-th fa-fw"></i> <br />
            
            Categories
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about" rel="section">
            
              <i class="menu-item-icon fa fa-user fa-fw"></i> <br />
            
            About
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
              <i class="menu-item-icon fa fa-archive fa-fw"></i> <br />
            
            Archives
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags" rel="section">
            
              <i class="menu-item-icon fa fa-tags fa-fw"></i> <br />
            
            Tags
          </a>
        </li>
      

      
    </ul>
  

  
</nav>

 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/09/07/Intellij-IDEA-Mac-OS-X-KeyMap-中文版/" itemprop="url">
                  Intellij IDEA Mac OS X KeyMap 中文版
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">Posted on</span>
            <time itemprop="dateCreated" datetime="2016-09-07T18:52:50+08:00" content="Sep 7 2016">
              Sep 7 2016
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">In</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/文档/" itemprop="url" rel="index">
                    <span itemprop="name">文档</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2016/09/07/Intellij-IDEA-Mac-OS-X-KeyMap-中文版/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2016/09/07/Intellij-IDEA-Mac-OS-X-KeyMap-中文版/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          
             <span id="/2016/09/07/Intellij-IDEA-Mac-OS-X-KeyMap-中文版/" class="leancloud_visitors" data-flag-title="Intellij IDEA Mac OS X KeyMap 中文版">
               &nbsp; | &nbsp;
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               <span class="post-meta-item-text">visitors </span>
               <span class="leancloud-visitors-count"></span>
              </span>
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="官方版本">官方版本</h1><p><a href="https://resources.jetbrains.com/assets/products/intellij-idea/IntelliJIDEA_ReferenceCard_mac.pdf" target="_blank" rel="external">官方版本</a></p>
<h1 id="翻译版本预览">翻译版本预览</h1><p><img src="http://7xqtsx.com1.z0.glb.clouddn.com/16-9-7/44368370.jpg" alt=""></p>
<h1 id="翻译版本下载">翻译版本下载</h1><p><a href="https://www.jianguoyun.com/p/DSblRVAQpN36BRi7jBs" target="_blank" rel="external">Word版本下载</a></p>
<p><a href="https://www.jianguoyun.com/p/DSMleAUQpN36BRi9jBs" target="_blank" rel="external">PDF版本下载</a></p>
<p><a href="https://www.jianguoyun.com/p/DQuCALMQpN36BRi-jBs" target="_blank" rel="external">JPG版本下载</a></p>

          
        
      
    </div>
    
    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/09/07/Android-Studio-Gradle-进阶设置/" itemprop="url">
                  Android Studio Gradle 进阶设置
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">Posted on</span>
            <time itemprop="dateCreated" datetime="2016-09-07T01:10:55+08:00" content="Sep 7 2016">
              Sep 7 2016
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">In</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/文档/" itemprop="url" rel="index">
                    <span itemprop="name">文档</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2016/09/07/Android-Studio-Gradle-进阶设置/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2016/09/07/Android-Studio-Gradle-进阶设置/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          
             <span id="/2016/09/07/Android-Studio-Gradle-进阶设置/" class="leancloud_visitors" data-flag-title="Android Studio Gradle 进阶设置">
               &nbsp; | &nbsp;
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               <span class="post-meta-item-text">visitors </span>
               <span class="leancloud-visitors-count"></span>
              </span>
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="配置独立的签名信息">配置独立的签名信息</h2><p>一般来说，我们可以直接把签名的信息明文写在gradle配置文件中，但是在多人协作或者开源代码的时候不是很方便，前者可能存放签名文件的位置需要修改，后者则希望隐藏签名信息，在看不少开源项目的时候，发现很多是这样做的</p>
<p>signingConfigs位置， <code>android的下一级</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">signingConfigs &#123;</div><div class="line">        release &#123;</div><div class="line">            storeFile file(RELEASE_STORE_FILE)</div><div class="line">            storePassword RELEASE_STORE_PASSWORD</div><div class="line">            keyAlias RELEASE_KEY_ALIAS</div><div class="line">            keyPassword RELEASE_KEY_PASSWORD</div><div class="line">        &#125;</div></pre></td></tr></table></figure>
<p>在对应位置引用常量，在properties中再进行具体赋值<br>在gradle.properties中</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">RELEASE_KEY_PASSWORD=xxxx</div><div class="line">RELEASE_KEY_ALIAS=xxx</div><div class="line">RELEASE_STORE_PASSWORD=xxx</div><div class="line">RELEASE_STORE_FILE=../.keystore/xxx.jks</div></pre></td></tr></table></figure>
<p>这样不会直接暴露签名信息，也方便配置</p>
<h2 id="多渠道打包">多渠道打包</h2><p>在product flavor下定义不同类型, 把AndroiManifest中的channel替换</p>
<p>productFlavors位置： <code>android的下一级</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">android &#123;</div><div class="line">      productFlavors &#123;</div><div class="line">        fir &#123;</div><div class="line">            manifestPlaceholders = [UMENG_CHANNEL_VALUE: &quot;fir&quot;]</div><div class="line">        &#125;</div><div class="line">        GooglePlay &#123;</div><div class="line">            manifestPlaceholders = [UMENG_CHANNEL_VALUE: &quot;GooglePlay&quot;]</div><div class="line">        &#125;</div><div class="line">        Umeng &#123;</div><div class="line">            manifestPlaceholders = [UMENG_CHANNEL_VALUE: &quot;Umeng&quot;]</div><div class="line">        &#125;</div><div class="line">       </div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>如果flavor标识是数字开头，要加以处理，添加””</p>
<p>替换AndroiManifest中的字段</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">&lt;meta-data</div><div class="line">    android:name=&quot;UMENG_CHANNEL&quot;</div><div class="line">    android:value=&quot;$&#123;UMENG_CHANNEL_VALUE&#125;&quot;/&gt;</div></pre></td></tr></table></figure>
<h2 id="定制生成apk文件名称">定制生成apk文件名称</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div></pre></td><td class="code"><pre><div class="line">def buildTime() &#123;</div><div class="line">    return new Date().format(&quot;yyyy-MM-dd HH:mm:ss&quot;)</div><div class="line">&#125;</div><div class="line">def hostName() &#123;</div><div class="line">    return System.getProperty(&quot;user.name&quot;) + &quot;@&quot; + InetAddress.localHost.hostName</div><div class="line">&#125;</div><div class="line"></div><div class="line"></div><div class="line">android &#123;</div><div class="line"></div><div class="line">   //...</div><div class="line">   </div><div class="line">    productFlavors &#123;</div><div class="line">        fir &#123;</div><div class="line">            manifestPlaceholders = [UMENG_CHANNEL_VALUE: &quot;fir&quot;]</div><div class="line">        &#125;</div><div class="line">        GooglePlay &#123;</div><div class="line">            manifestPlaceholders = [UMENG_CHANNEL_VALUE: &quot;GooglePlay&quot;]</div><div class="line">        &#125;</div><div class="line">        Umeng &#123;</div><div class="line">            manifestPlaceholders = [UMENG_CHANNEL_VALUE: &quot;Umeng&quot;]</div><div class="line">        &#125;</div><div class="line"></div><div class="line">    &#125;</div><div class="line"></div><div class="line">   buildTypes &#123;</div><div class="line">        release &#123;</div><div class="line">            minifyEnabled true</div><div class="line">            proguardFiles getDefaultProguardFile(&apos;proguard-android.txt&apos;), &apos;proguard-rules.pro&apos;</div><div class="line">            signingConfig signingConfigs.app1</div><div class="line">        &#125;</div><div class="line"></div><div class="line">    &#125;</div><div class="line"></div><div class="line">    applicationVariants.all &#123; variant -&gt;</div><div class="line">        variant.outputs.each &#123; output -&gt;</div><div class="line">            def outputFile = output.outputFile</div><div class="line">            if (outputFile != null &amp;&amp; outputFile.name.endsWith(&apos;.apk&apos;)) &#123;</div><div class="line"></div><div class="line">                def fileName = &quot;mzeht_v$&#123;defaultConfig.versionName&#125;_$&#123;hostName()&#125;_$&#123;buildTime()&#125;_$&#123;variant.productFlavors[0].name&#125;.apk&quot;</div><div class="line">                output.outputFile = new File(outputFile.parent, fileName)</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>同样注意层级关系,在android同级下定义一个时间函数和一个host函数并引用，生成的apk包如下：</p>
<p><img src="http://7xqtsx.com1.z0.glb.clouddn.com/16-9-7/53721167.jpg" alt=""></p>
<h2 id="配置依赖版本号">配置依赖版本号</h2><p>在Maven中我们可以方便的定义spring等核心依赖的版本号，便于统一管理，在Gradle中我们同样可以做到</p>
<p>在看google的架构综合项目时<a href="https://github.com/googlesamples/android-architecture/tree/todo-mvp/" target="_blank" rel="external">todo-mvp</a>,看见了一种写法</p>
<p>在根目录下的build.gradle文件中</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div></pre></td><td class="code"><pre><div class="line">buildscript &#123;</div><div class="line">    repositories &#123;</div><div class="line">        jcenter()</div><div class="line">    &#125;</div><div class="line">    dependencies &#123;</div><div class="line">        classpath &apos;com.android.tools.build:gradle:2.1.2&apos;</div><div class="line"></div><div class="line">        // NOTE: Do not place your application dependencies here; they belong</div><div class="line">        // in the individual module build.gradle files</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line">allprojects &#123;</div><div class="line">    repositories &#123;</div><div class="line">        jcenter()</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line">task clean(type: Delete) &#123;</div><div class="line">    delete rootProject.buildDir</div><div class="line">&#125;</div><div class="line"></div><div class="line">// Define versions in a single place</div><div class="line">ext &#123;</div><div class="line">    // Sdk and tools</div><div class="line">    minSdkVersion = 10</div><div class="line">    targetSdkVersion = 22</div><div class="line">    compileSdkVersion = 23</div><div class="line">    buildToolsVersion = &apos;23.0.2&apos;</div><div class="line"></div><div class="line">    // App dependencies</div><div class="line">    supportLibraryVersion = &apos;23.4.0&apos;</div><div class="line">    guavaVersion = &apos;18.0&apos;</div><div class="line">    junitVersion = &apos;4.12&apos;</div><div class="line">    mockitoVersion = &apos;1.10.19&apos;</div><div class="line">    powerMockito = &apos;1.6.2&apos;</div><div class="line">    hamcrestVersion = &apos;1.3&apos;</div><div class="line">    runnerVersion = &apos;0.4.1&apos;</div><div class="line">    rulesVersion = &apos;0.4.1&apos;</div><div class="line">    espressoVersion = &apos;2.2.1&apos;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>然后在app的build.gradle中</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div></pre></td><td class="code"><pre><div class="line">apply plugin: &apos;com.android.application&apos;</div><div class="line"></div><div class="line">android &#123;</div><div class="line">    compileSdkVersion rootProject.ext.compileSdkVersion</div><div class="line">    buildToolsVersion rootProject.ext.buildToolsVersion</div><div class="line"></div><div class="line">    defaultConfig &#123;</div><div class="line">        applicationId &quot;com.example.android.architecture.blueprints.todomvp&quot;</div><div class="line">        minSdkVersion rootProject.ext.minSdkVersion</div><div class="line">        targetSdkVersion rootProject.ext.targetSdkVersion</div><div class="line">        versionCode 1</div><div class="line">        versionName &quot;1.0&quot;</div><div class="line"></div><div class="line">        testInstrumentationRunner &apos;android.support.test.runner.AndroidJUnitRunner&apos;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    buildTypes &#123;</div><div class="line">        debug &#123;</div><div class="line">            minifyEnabled true</div><div class="line">            // Uses new built-in shrinker http://tools.android.com/tech-docs/new-build-system/built-in-shrinker</div><div class="line">            useProguard false</div><div class="line">            proguardFiles getDefaultProguardFile(&apos;proguard-android.txt&apos;), &apos;proguard-rules.pro&apos;</div><div class="line">            testProguardFiles getDefaultProguardFile(&apos;proguard-android.txt&apos;), &apos;proguardTest-rules.pro&apos;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        release &#123;</div><div class="line">            minifyEnabled true</div><div class="line">            useProguard true</div><div class="line">            proguardFiles getDefaultProguardFile(&apos;proguard-android.txt&apos;), &apos;proguard-rules.pro&apos;</div><div class="line">            testProguardFiles getDefaultProguardFile(&apos;proguard-android.txt&apos;), &apos;proguardTest-rules.pro&apos;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    // If you need to add more flavors, consider using flavor dimensions.</div><div class="line">    productFlavors &#123;</div><div class="line">        mock &#123;</div><div class="line">            applicationIdSuffix = &quot;.mock&quot;</div><div class="line">        &#125;</div><div class="line">        prod &#123;</div><div class="line"></div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    // Remove mockRelease as it&apos;s not needed.</div><div class="line">    android.variantFilter &#123; variant -&gt;</div><div class="line">        if(variant.buildType.name.equals(&apos;release&apos;)</div><div class="line">                &amp;&amp; variant.getFlavors().get(0).name.equals(&apos;mock&apos;)) &#123;</div><div class="line">            variant.setIgnore(true);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    // Always show the result of every unit test, even if it passes.</div><div class="line">    testOptions.unitTests.all &#123;</div><div class="line">        testLogging &#123;</div><div class="line">            events &apos;passed&apos;, &apos;skipped&apos;, &apos;failed&apos;, &apos;standardOut&apos;, &apos;standardError&apos;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line">/*</div><div class="line"> Dependency versions are defined in the top level build.gradle file. This helps keeping track of</div><div class="line"> all versions in a single place. This improves readability and helps managing project complexity.</div><div class="line"> */</div><div class="line">dependencies &#123;</div><div class="line">    // App&apos;s dependencies, including test</div><div class="line">    compile &quot;com.android.support:appcompat-v7:$rootProject.supportLibraryVersion&quot;</div><div class="line">    compile &quot;com.android.support:cardview-v7:$rootProject.supportLibraryVersion&quot;</div><div class="line">    compile &quot;com.android.support:design:$rootProject.supportLibraryVersion&quot;</div><div class="line">    compile &quot;com.android.support:recyclerview-v7:$rootProject.supportLibraryVersion&quot;</div><div class="line">    compile &quot;com.android.support:support-v4:$rootProject.supportLibraryVersion&quot;</div><div class="line">    compile &quot;com.android.support.test.espresso:espresso-idling-resource:$rootProject.espressoVersion&quot;</div><div class="line">    compile &quot;com.google.guava:guava:$rootProject.guavaVersion&quot;</div><div class="line"></div><div class="line">    // Dependencies for local unit tests</div><div class="line">    testCompile &quot;junit:junit:$rootProject.ext.junitVersion&quot;</div><div class="line">    testCompile &quot;org.mockito:mockito-all:$rootProject.ext.mockitoVersion&quot;</div><div class="line">    testCompile &quot;org.hamcrest:hamcrest-all:$rootProject.ext.hamcrestVersion&quot;</div><div class="line"></div><div class="line">    // Android Testing Support Library&apos;s runner and rules</div><div class="line">    androidTestCompile &quot;com.android.support.test:runner:$rootProject.ext.runnerVersion&quot;</div><div class="line">    androidTestCompile &quot;com.android.support.test:rules:$rootProject.ext.runnerVersion&quot;</div><div class="line"></div><div class="line">    // Dependencies for Android unit tests</div><div class="line">    androidTestCompile &quot;junit:junit:$rootProject.ext.junitVersion&quot;</div><div class="line">    androidTestCompile &quot;org.mockito:mockito-core:$rootProject.ext.mockitoVersion&quot;</div><div class="line">    androidTestCompile &apos;com.google.dexmaker:dexmaker:1.2&apos;</div><div class="line">    androidTestCompile &apos;com.google.dexmaker:dexmaker-mockito:1.2&apos;</div><div class="line"></div><div class="line">    // Espresso UI Testing</div><div class="line">    androidTestCompile &quot;com.android.support.test.espresso:espresso-core:$rootProject.espressoVersion&quot;</div><div class="line">    androidTestCompile (&quot;com.android.support.test.espresso:espresso-contrib:$rootProject.espressoVersion&quot;)</div><div class="line">    androidTestCompile &quot;com.android.support.test.espresso:espresso-intents:$rootProject.espressoVersion&quot;</div><div class="line"></div><div class="line">    // Resolve conflicts between main and test APK:</div><div class="line">    androidTestCompile &quot;com.android.support:support-annotations:$rootProject.supportLibraryVersion&quot;</div><div class="line">    androidTestCompile &quot;com.android.support:support-v4:$rootProject.supportLibraryVersion&quot;</div><div class="line">    androidTestCompile &quot;com.android.support:recyclerview-v7:$rootProject.supportLibraryVersion&quot;</div></pre></td></tr></table></figure>
<h2 id="减少编译错误和忽略lint检查">减少编译错误和忽略lint检查</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line">packagingOptions &#123;</div><div class="line">        exclude &apos;META-INF/DEPENDENCIES.txt&apos;</div><div class="line">        exclude &apos;META-INF/LICENSE.txt&apos;</div><div class="line">        exclude &apos;META-INF/NOTICE.txt&apos;</div><div class="line">        exclude &apos;META-INF/NOTICE&apos;</div><div class="line">        exclude &apos;META-INF/LICENSE&apos;</div><div class="line">        exclude &apos;META-INF/DEPENDENCIES&apos;</div><div class="line">        exclude &apos;META-INF/notice.txt&apos;</div><div class="line">        exclude &apos;META-INF/license.txt&apos;</div><div class="line">        exclude &apos;META-INF/dependencies.txt&apos;</div><div class="line">        exclude &apos;META-INF/LGPL2.1&apos;</div><div class="line">    &#125;</div><div class="line"></div><div class="line"> </div><div class="line"></div><div class="line">    lintOptions &#123;</div><div class="line">        abortOnError false</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<h2 id="结语">结语</h2><p>gralde设置结合AndroidStudio提供的图形界面设置，理解会更快更透彻</p>
<p>File-Project Structure-Modules-app</p>
<p><img src="http://7xqtsx.com1.z0.glb.clouddn.com/16-9-7/37008097.jpg" alt=""></p>

          
        
      
    </div>
    
    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/09/04/Data-Binding-Guide/" itemprop="url">
                  Data Binding Guide
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">Posted on</span>
            <time itemprop="dateCreated" datetime="2016-09-04T14:37:50+08:00" content="Sep 4 2016">
              Sep 4 2016
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">In</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/文档/" itemprop="url" rel="index">
                    <span itemprop="name">文档</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2016/09/04/Data-Binding-Guide/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2016/09/04/Data-Binding-Guide/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          
             <span id="/2016/09/04/Data-Binding-Guide/" class="leancloud_visitors" data-flag-title="Data Binding Guide">
               &nbsp; | &nbsp;
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               <span class="post-meta-item-text">visitors </span>
               <span class="leancloud-visitors-count"></span>
              </span>
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p><img src="http://7xqtsx.com1.z0.glb.clouddn.com/16-9-4/6040336.jpg" alt=""></p>
<h2 id="前言">前言</h2><p>2016的Google IO 大会上，Android 团队发布了一个数据绑定框架（Data Binding Library）。以后可以直接在 layout 布局 xml 文件中绑定数据了，无需再 findViewById 然后手工设置数据了。其语法和使用方式和 JSP 中的 EL 表达式非常类似。</p>
<p>看到google出品的<a href="https://developer.android.com/topic/libraries/data-binding/index.html" target="_blank" rel="external">Data Binding Library</a>本来是想边翻译边写写demo，但是csdn上已经有人翻译了，没必要重复劳动，直接拿来链接：</p>
<h1 id="Data_Binding_Guide——google官方文档翻译（上）"><a href="http://blog.csdn.net/u014486880/article/details/50508133" target="_blank" rel="external">Data Binding Guide——google官方文档翻译（上）</a></h1><h1 id="Data_Binding_Guide——google官方文档翻译（下）"><a href="http://blog.csdn.net/u014486880/article/details/50531110" target="_blank" rel="external"> Data Binding Guide——google官方文档翻译（下）</a></h1><h2 id="防坑指南">防坑指南</h2><p>引入DataBindingLibrary从最初发布开始，已经有了变化，起初是</p>
<p>在项目的 gradle 配置文件中添加依赖项：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">dependencies &#123; classpath &quot;com.android.tools.build:gradle:1.2.3&quot; classpath &quot;com.android.databinding:dataBinder:1.0-rc0&quot; &#125;</div></pre></td></tr></table></figure>
<p>上面的依赖项目前在 jcenter 服务器中，所以确保 repositories 中包含 jcenter。<br>allprojects { repositories { jcenter() }}</p>
<p>在每个需要使用 Data Binding 功能的模块的 gradle 配置文件中启用该插件（添加在 android 插件之后），</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">apply plugin: ‘com.android.application&apos;apply plugin: &apos;com.android.databinding&apos;</div></pre></td></tr></table></figure>
<p>但是现在的google文档中 只要</p>
<ul>
<li><p>To get started with Data Binding, download the library from the Support repository in the Android SDK manager.</p>
</li>
<li><p>To configure your app to use data binding, add the dataBinding element to your build.gradle file in the app module.</p>
</li>
<li><p>Use the following code snippet to configure data binding:</p>
</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">android &#123;</div><div class="line">    ....</div><div class="line">    dataBinding &#123;</div><div class="line">        enabled = true</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><a href="https://github.com/jingle1267/DataDindingSample" target="_blank" rel="external">demo github 地址</a></p>

          
        
      
    </div>
    
    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/07/30/Mac:windows下nexus系列产品的刷机官方指南/" itemprop="url">
                  Mac/windows下nexus系列产品的刷机官方指南
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">Posted on</span>
            <time itemprop="dateCreated" datetime="2016-07-30T15:26:44+08:00" content="Jul 30 2016">
              Jul 30 2016
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">In</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/文档/" itemprop="url" rel="index">
                    <span itemprop="name">文档</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2016/07/30/Mac:windows下nexus系列产品的刷机官方指南/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2016/07/30/Mac:windows下nexus系列产品的刷机官方指南/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          
             <span id="/2016/07/30/Mac:windows下nexus系列产品的刷机官方指南/" class="leancloud_visitors" data-flag-title="Mac/windows下nexus系列产品的刷机官方指南">
               &nbsp; | &nbsp;
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               <span class="post-meta-item-text">visitors </span>
               <span class="leancloud-visitors-count"></span>
              </span>
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="注意事项">注意事项</h1><p>1.仅针对官方镜像<br>2.需要下载官方镜像，需要翻墙或者国内寻找搬运资源<br>3.nexus刷入新系统后，开机需要网络验证激活（部分可以跳过），需要网络环境能够翻墙，请自行解决  </p>
<h1 id="镜像">镜像</h1><p>1.前往<a href="https://developers.google.com/android/nexus/images" target="_blank" rel="external">镜像官网</a><br>2.<img src="http://7xqtsx.com1.z0.glb.clouddn.com/16-7-30/11576201.jpg" alt=""><br>右侧选择对应的设备,同意相关协议，选择下载镜像<br><img src="http://7xqtsx.com1.z0.glb.clouddn.com/16-7-30/27674143.jpg" alt=""><br>这里以6p为例子，镜像列表从上到下，从旧到新</p>
<h1 id="环境准备">环境准备</h1><p>1.fastboot工具  </p>
<p>To flash a device using one of the system images below (or one of your own), you need the latest fastboot tool. You can get it from one of the sources below.</p>
<ul>
<li><p>From a compiled version of the <a href="https://source.android.com/" target="_blank" rel="external">Android Open Source Project</a>.  </p>
</li>
<li><p>From the <code>platform-tools/</code> directory in the Android SDK. Be sure that you have the latest version of the <code>Android SDK Platform-tools</code> from the <a href="https://developer.android.com/studio/intro/update.html" target="_blank" rel="external">SDK Manager</a>.  </p>
</li>
</ul>
<p>Once you have the <code>fastboot tool</code>, add it to your <code>PATH</code> environment variable (the flash-all script below must be able to find it). Also be certain that you’ve set up USB access for your device, as described in the Using <a href="https://developer.android.com/studio/run/device.html" target="_blank" rel="external">Hardware Devices guide</a>.  </p>
<p>Caution: Flashing a new system image deletes all user data. Be certain to first backup any personal data such as photos.</p>
<p>简单来说就是下载fastboot工具 并且添加到系统变量，注意用户数据会被清空</p>
<h1 id="刷入步骤">刷入步骤</h1><ol>
<li><p>Download the appropriate system image for your device below, then unzip it to a safe directory.  </p>
</li>
<li><p>Connect your device to your computer over USB.  </p>
</li>
<li><p>Start the device in fastboot mode with one of the following methods:</p>
<ul>
<li><p>Using the <code>adb tool</code>: With the device powered on, execute:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">adb reboot bootloader</div></pre></td></tr></table></figure>
</li>
<li><p>Using a key combo: Turn the device off, then turn it on and immediately hold down the relevant<code>key combination</code> for your device. For example, to put a Nexus 5 (“hammerhead”) into fastboot mode, press and hold Volume Up + Volume Down + Power as the device begins booting up.  </p>
</li>
</ul>
</li>
<li><p>If necessary, unlock the device’s bootloader by running:</p>
</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">fastboot flashing unlock</div></pre></td></tr></table></figure>
<p>or, for older devices, running:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">fastboot oem unlock</div></pre></td></tr></table></figure>
<p>The target device will show you a confirmation screen. (This erases all data on the target device.)  </p>
<ol>
<li><p>Open a terminal and navigate to the unzipped system image directory.  </p>
</li>
<li><p>Execute the flash-all script. This script installs the necessary bootloader, baseband firmware(s), and operating system.  </p>
</li>
</ol>
<p>Once the script finishes, your device reboots. You should now lock the bootloader for security:</p>
<ol>
<li>Start the device in fastboot mode again, as described above.</li>
<li>Execute:<br>fastboot flashing lock<br>or, for older devices, running:<br>fastboot oem lock</li>
</ol>
<p>Locking bootloader will wipe the data on some devices. After locking the bootloader, if you want to flash the device again, you must run <code>fastboot oem unlock again</code>, which will wipe the data.</p>
<h1 id="结语">结语</h1><p>偷懒，直接上官方指南了，一些细节问题，（比如怎么下载fastboot，怎么配置系统变量）,相信能看到这篇文章和有这个意向的人都能解决。  </p>
<p>通过此方法完美利用mac给nexus5手机和nexus7wifi刷好系统,前者网络验证可以跳过，后者不行，采用可以刷入开源固件的路由器，刷入openwrt，设置好socks代理（付费版），即可无线翻墙，顺利激活，windows上可以电脑翻墙后共享热点，期间还尝试了<code>Privoxy</code>将shadowsocks的socks5代理转为http代理,然后验证阶段，连接普通wifi,设备和mac处在同一局域网下，设置代理地址为mac上的socks代理，但是不是很理想，还是硬件翻墙来的粗暴</p>

          
        
      
    </div>
    
    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/06/30/Synchronize-files-from-ftpserver/" itemprop="url">
                  Synchronize files from ftpserver
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">Posted on</span>
            <time itemprop="dateCreated" datetime="2016-06-30T21:10:57+08:00" content="Jun 30 2016">
              Jun 30 2016
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">In</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/项目/" itemprop="url" rel="index">
                    <span itemprop="name">项目</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2016/06/30/Synchronize-files-from-ftpserver/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2016/06/30/Synchronize-files-from-ftpserver/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          
             <span id="/2016/06/30/Synchronize-files-from-ftpserver/" class="leancloud_visitors" data-flag-title="Synchronize files from ftpserver">
               &nbsp; | &nbsp;
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               <span class="post-meta-item-text">visitors </span>
               <span class="leancloud-visitors-count"></span>
              </span>
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="项目功能">项目功能</h1><ol>
<li>软件为运行于安卓平台的客户端软件。</li>
<li>客户端软件运行于一台19寸屏的安卓媒体机上。</li>
<li>该客户端软件有播放广告视频的功能，广告视频从FTP服务器下载，本地的视频文件每隔三分钟与FTP服务器同步一次，保持本地视频和服务器视频的同步。</li>
<li>FTP服务器的下载目录要求可配置，第一次运行该软件时弹出配置窗口，要求输入服务器IP地址，用户名和密码，以及服务器视频所在的目录路径。配置完成后，以后运行不再需要重新配置。</li>
<li>媒体机主板通过串口外接了一块STM32单片机，STM32单片机会将采集到的PM2.5指数，温湿度信息上传，媒体板通过串口接收，并将数据显示在屏幕的最上方。通信协议见“媒体板和单片机通信协议.docx”文档。</li>
<li>开机播放一段欢迎视频，视频打包在Android程序内部</li>
</ol>
<h1 id="功能分析">功能分析</h1><p><img src="http://7xqtsx.com1.z0.glb.clouddn.com/16-6-30/89255535.jpg" alt=""></p>
<p>工程部分结构图</p>
<p>LaunchActivity:播放欢迎视频</p>
<p>LoginActivity：登录FTP服务器并且下载所有的视频文件</p>
<p>DisplayActivity:播放服务器上最新的文件，并且每个三分钟检查视频的更新和废除，若有更新，则下载下来，不在服务器目录的文件删除掉，否则存储空间占用不断增加</p>
<blockquote>
<ul>
<li>由于设备的网络问题和服务器等造成下载中断，不完整等，必须要有重试下载和检查下载完整的机制</li>
<li>每播放完一组视频，若有更新，刷新播放队列，若无更新，循环播放该组视频</li>
<li>服务器上的文件信息要实时保存到数据库，以供对比</li>
<li>需要下载服务器指定目录下的一类文件</li>
</ul>
</blockquote>
<h1 id="依赖包">依赖包</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"> compile fileTree(include: [&apos;*.jar&apos;], dir: &apos;libs&apos;)</div><div class="line">    compile &apos;com.android.support:recyclerview-v7:23.4.0&apos;</div><div class="line">    compile &apos;com.android.support:leanback-v17:23.4.0&apos;</div><div class="line">//    compile files(&apos;libs/commons-net-3.0.1.jar&apos;)</div><div class="line">    compile &apos;com.jakewharton:butterknife:7.0.0&apos;</div><div class="line">    compile &apos;org.xutils:xutils:3.3.26&apos;</div><div class="line">    compile files(&apos;libs/commons-net-3.3.jar&apos;)</div></pre></td></tr></table></figure>
<h2 id="v17_Leanback_Library">v17 Leanback Library</h2><p><a href="https://developer.android.com/topic/libraries/support-library/features.html#v17-leanback" target="_blank" rel="external">https://developer.android.com/topic/libraries/support-library/features.html#v17-leanback</a><br>内置了对TV设备的支持</p>
<h2 id="org-xutils:xutils:3-3-26">org.xutils:xutils:3.3.26</h2><p>开源框架 这里主要是用到数据库模块</p>
<h2 id="commons-net-3-3-jar">commons-net-3.3.jar</h2><p>apache出品的与FTP服务器交互的jar包</p>
<h1 id="技术实现">技术实现</h1><h2 id="数据库的实时更新">数据库的实时更新</h2><p>创建:在LoginActivity</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line">    public static DbManager.DaoConfig daoConfig = new DbManager.DaoConfig()</div><div class="line">            .setDbName(&quot;addisplay.db&quot;)</div><div class="line">            .setTableCreateListener(new DbManager.TableCreateListener() &#123;</div><div class="line">                @Override</div><div class="line">                public void onTableCreated(DbManager db, TableEntity&lt;?&gt; table) &#123;</div><div class="line">                    Log.i(&quot;mzeht&quot;, &quot;onTableCreated&lt;&lt;&quot; + table.getName());</div><div class="line">                &#125;</div><div class="line">            &#125;)</div><div class="line">//            .setAllowTransaction(true)</div><div class="line">//            .setDbDir(new File(&quot;/mnt/sdcard/&quot;))</div><div class="line">//            .setDbVersion(1)</div><div class="line">            .setDbUpgradeListener(new DbManager.DbUpgradeListener() &#123;</div><div class="line">                @Override</div><div class="line">                public void onUpgrade(DbManager db, int oldVersion, int newVersion) &#123;</div><div class="line"></div><div class="line">                &#125;</div><div class="line">            &#125;)</div><div class="line">            .setDbOpenListener(new DbManager.DbOpenListener() &#123;</div><div class="line">                @Override</div><div class="line">                public void onDbOpened(DbManager db) &#123;</div><div class="line">                    db.getDatabase().enableWriteAheadLogging();</div><div class="line">                &#125;</div><div class="line">            &#125;);</div><div class="line">    DbManager db = x.getDb(daoConfig);</div></pre></td></tr></table></figure>
<p>我们需要一个NewFile</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div></pre></td><td class="code"><pre><div class="line">@Table(name=&quot;mp4file_info&quot;)</div><div class="line">public class NewFile &#123;</div><div class="line">    @Column(name=&quot;id&quot;,isId = true,autoGen = true,property = &quot;&quot;)</div><div class="line">    private int id;</div><div class="line">    @Column(name = &quot;file_Name&quot;)</div><div class="line">    private String fileName;</div><div class="line">    @Column(name = &quot;file_Size&quot;)</div><div class="line">    private long fileSize;</div><div class="line">    @Column(name = &quot;file_Path&quot;)</div><div class="line">    private String filePath;</div><div class="line"></div><div class="line">    public NewFile(String fileName, long fileSize, String filePath) &#123;</div><div class="line">        this.fileName = fileName;</div><div class="line">        this.fileSize = fileSize;</div><div class="line">        this.filePath = filePath;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    public NewFile() &#123;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    public int getId() &#123;</div><div class="line">        return id;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    public void setId(int id) &#123;</div><div class="line">        this.id = id;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    public String getFileName() &#123;</div><div class="line">        return fileName;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    public void setFileName(String fileName) &#123;</div><div class="line">        this.fileName = fileName;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    public long getFileSize() &#123;</div><div class="line">        return fileSize;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    public void setFileSize(long fileSize) &#123;</div><div class="line">        this.fileSize = fileSize;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    public String getFilePath() &#123;</div><div class="line">        return filePath;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    public void setFilePath(String filePath) &#123;</div><div class="line">        this.filePath = filePath;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    @Override</div><div class="line">    public String toString() &#123;</div><div class="line">        return &quot;NewFile&#123;&quot; +</div><div class="line">                &quot;fileName=&apos;&quot; + fileName + &apos;\&apos;&apos; +</div><div class="line">                &quot;, fileSize=&quot; + fileSize +&apos;\&apos;&apos; +</div><div class="line">                &quot;, filePath=&quot; + filePath +</div><div class="line">                &apos;&#125;&apos;;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>在下载工具类中：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">NewFile newFile = new NewFile(file.getName(), file.getSize(), LocalSavePath + fileName);</div><div class="line">                           newFiles.add(newFile);</div><div class="line">                       &#125;</div><div class="line">                   &#125;</div><div class="line">               &#125;</div><div class="line">           &#125;</div><div class="line">           //退出登陆FTP，关闭ftpCLient的连接</div><div class="line">           ftpClient.logout();</div><div class="line">           ftpClient.disconnect();</div><div class="line"></div><div class="line"></div><div class="line">           DbManager db = x.getDb(LoginActivity.daoConfig);</div><div class="line">           db.delete(NewFile.class);</div><div class="line">           db.save(newFiles);</div><div class="line">           Log.i(&quot;数据库保存实时服务器文件信息&quot;, newFiles.toString());</div></pre></td></tr></table></figure>
<h2 id="视频的循环播放">视频的循环播放</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div></pre></td><td class="code"><pre><div class="line"> public void loadView(String path) &#123;</div><div class="line"></div><div class="line">        Uri uri = Uri.parse(path);</div><div class="line">        final String fileinfo = path + &quot;&quot;;</div><div class="line">        mVideoView.setVideoURI(uri);</div><div class="line">        mVideoView.start();</div><div class="line"></div><div class="line">        mVideoView.setOnPreparedListener(new MediaPlayer.OnPreparedListener() &#123;</div><div class="line"></div><div class="line">            @Override</div><div class="line">            public void onPrepared(MediaPlayer mp) &#123;</div><div class="line"></div><div class="line">                mp.start();// 播放</div><div class="line">                Log.i(&quot;开始播放&quot;, &quot;服务器的第&quot; + count + &quot;个文件&gt;&gt;&gt;&gt;&gt;&gt;&quot; + playFile.getName());</div><div class="line">            &#125;</div><div class="line">        &#125;);</div><div class="line"></div><div class="line">        mVideoView.setOnCompletionListener(new MediaPlayer.OnCompletionListener() &#123;</div><div class="line"></div><div class="line">            @Override</div><div class="line">            public void onCompletion(MediaPlayer mp) &#123;</div><div class="line">                android.util.Log.i(&quot;播放完成&quot;, &quot;服务器的第&quot; + count + &quot;个文件&gt;&gt;&gt;&gt;&gt;&gt;&quot; + playFile.getName());</div><div class="line">                count++;</div><div class="line">                if (count &lt; displaySize) &#123;</div><div class="line">                &#125; else &#123;</div><div class="line">                    count = 0;</div><div class="line">                    playendFlag = true;</div><div class="line">                &#125;</div><div class="line">                Log.i(&quot;&quot;, &quot;count:&quot; + count + &quot;dispalysize:&quot; + displaySize);</div><div class="line">                playFile = mp4Files.get(count);</div><div class="line">                Uri uri = Uri.parse(playFile.getAbsolutePath());</div><div class="line">//                Log.i(&quot;setOnCompletionListener&quot;,playFile.getAbsolutePath());</div><div class="line">                mVideoView.setVideoURI(uri);</div><div class="line">                mVideoView.start();// 播放</div><div class="line"></div><div class="line">            &#125;</div><div class="line">        &#125;);</div><div class="line"></div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>主要是对mVideoView的两个监听</p>
<h2 id="从数据库刷新播放列表">从数据库刷新播放列表</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div></pre></td><td class="code"><pre><div class="line">private void initData() &#123;</div><div class="line"></div><div class="line">        boolean sdCardExist = Environment.getExternalStorageState().equals(android.os.Environment.MEDIA_MOUNTED);</div><div class="line">        String pathdir;</div><div class="line">        if (!sdCardExist) &#123;</div><div class="line">            pathdir = getFilesDir().getAbsolutePath();//新建一级主目录</div><div class="line">        &#125; else &#123;</div><div class="line">            pathdir = FileUtils.CacheDir[3];//新建一级主目录</div><div class="line">        &#125;</div><div class="line">        DbManager db = x.getDb(LoginActivity.daoConfig);</div><div class="line">        String sql = &quot;select id,file_Name,file_Size,file_Path from mp4file_info &quot;;</div><div class="line">        List&lt;DbModel&gt; dbModelAll = null;</div><div class="line">        try &#123;</div><div class="line">            dbModelAll = db.findDbModelAll(new SqlInfo(sql));</div><div class="line">        &#125; catch (DbException e) &#123;</div><div class="line">            e.printStackTrace();</div><div class="line">        &#125;</div><div class="line">        List&lt;String&gt; pathList = new ArrayList&lt;String&gt;();</div><div class="line">        for (DbModel dbmodel : dbModelAll) &#123;</div><div class="line">            String id = dbmodel.getString(&quot;id&quot;);</div><div class="line">            String file_Nanme = dbmodel.getString(&quot;file_Name&quot;);</div><div class="line">            String file_path = dbmodel.getString(&quot;file_Path&quot;);</div><div class="line">            long file_Size = dbmodel.getLong(&quot;file_Size&quot;);</div><div class="line">            pathList.add(file_path);</div><div class="line">            Log.i(&quot;需要播放:&quot;, &quot; file_Nanme&lt;&lt;&quot; + file_Nanme + &quot; file_Size&lt;&lt;&quot; + file_Size + &quot; file_path&lt;&lt;&quot; + file_path);</div><div class="line">        &#125;</div><div class="line">        mp4Files.clear();</div><div class="line">        for (String path : pathList) &#123;</div><div class="line">            File file = new File(path);</div><div class="line">            mp4Files.add(file);</div><div class="line">        &#125;</div><div class="line">        DeletediscardedFile();</div><div class="line">//        File file = new File(pathdir);</div><div class="line">//        mp4Files = file.listFiles(getFileExtensionFilter(&quot;.mp4&quot;));</div><div class="line">        displaySize = mp4Files.size();</div><div class="line">        initFlag = true;</div><div class="line"></div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<h2 id="删除无用的文件">删除无用的文件</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line">private void DeletediscardedFile() &#123;</div><div class="line"></div><div class="line">        String loaclpath = getVideoFilePathStr();</div><div class="line">        File localfiles = new File(loaclpath);</div><div class="line">        File[] localfile = localfiles.listFiles();</div><div class="line">        boolean flag = false;</div><div class="line">        for (int i = 0; i &lt; localfile.length; i++) &#123;</div><div class="line">            flag = false;</div><div class="line">            for (int j = 0; j &lt; mp4Files.size(); j++) &#123;</div><div class="line">                //如果文件名称相同则不删除</div><div class="line">                String name1 = localfile[i].getAbsolutePath();</div><div class="line">                String name2 = mp4Files.get(j).getAbsolutePath();</div><div class="line">                if (name1.equals(name2)) &#123;</div><div class="line">                    flag = true;</div><div class="line">                &#125; else &#123;</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">            if (flag == false) &#123;</div><div class="line">                File deletefile = new File(localfile[i].getAbsolutePath());</div><div class="line">                deletefile.delete();</div><div class="line">                Log.i(&quot;deletefile:&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&quot;, localfile[i].getName());</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<h1 id="Thread和Hanler实现循环线程">Thread和Hanler实现循环线程</h1><p>在LoginActivity中有network和download两个线程，一个连接，一个下载，连接失败则会重试连接，成功则开启下载，下载成功则跳转展示页面，失败则重新连接</p>
<p>在DisplayActivity中有三个线程，network，download，initdata，多出一个刷新播放队列的线程</p>
<p>都是通过Therad和Hanler实现，循环线程，确保下载成功</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div></pre></td><td class="code"><pre><div class="line">Runnable initDataTask = new Runnable() &#123;</div><div class="line">        @Override</div><div class="line">        public void run() &#123;</div><div class="line">            initData();</div><div class="line">            Message msg = new Message();</div><div class="line">            Bundle data = new Bundle();</div><div class="line">            data.putBoolean(&quot;value&quot;, initFlag);</div><div class="line">            msg.setData(data);</div><div class="line">            ihandler.sendMessage(msg);</div><div class="line">        &#125;</div><div class="line">    &#125;;</div><div class="line"></div><div class="line">    Handler ihandler = new Handler() &#123;</div><div class="line">        @Override</div><div class="line">        public void handleMessage(Message msg) &#123;</div><div class="line">            super.handleMessage(msg);</div><div class="line">            Bundle data = msg.getData();</div><div class="line">            flag = data.getBoolean(&quot;value&quot;);</div><div class="line">            if (flag &amp;&amp; playendFlag) &#123;</div><div class="line">                playFile = mp4Files.get(count);</div><div class="line">                playendFlag = false;</div><div class="line">                loadView(playFile.getAbsolutePath());</div><div class="line">            &#125;</div><div class="line">            // TODO</div><div class="line">            // UI界面的更新等相关操作</div><div class="line">        &#125;</div><div class="line">    &#125;;</div><div class="line"></div><div class="line"></div><div class="line">    Runnable networkTask = new Runnable() &#123;</div><div class="line"></div><div class="line">        @Override</div><div class="line">        public void run() &#123;</div><div class="line">            // TODO</div><div class="line">            // 在这里进行 http request.网络请求相关操作</div><div class="line">            ftpUtils = FTPUtils.getInstance();</div><div class="line">            flag = ftpUtils.initFTPSetting(ip, Integer.valueOf(port), name, password);</div><div class="line">            Message msg = new Message();</div><div class="line">            Bundle data = new Bundle();</div><div class="line">            data.putBoolean(&quot;value&quot;, flag);</div><div class="line">            msg.setData(data);</div><div class="line">            chandler.sendMessage(msg);</div><div class="line">        &#125;</div><div class="line">    &#125;;</div><div class="line"></div><div class="line">    Handler chandler = new Handler() &#123;</div><div class="line">        @Override</div><div class="line">        public void handleMessage(Message msg) &#123;</div><div class="line">            super.handleMessage(msg);</div><div class="line">            Bundle data = msg.getData();</div><div class="line">            flag = data.getBoolean(&quot;value&quot;);</div><div class="line">            if (flag) &#123;</div><div class="line">                new Thread(downloadTask).start();</div><div class="line">            &#125;</div><div class="line">            // TODO</div><div class="line">            // UI界面的更新等相关操作</div><div class="line">        &#125;</div><div class="line">    &#125;;</div><div class="line"></div><div class="line">    Runnable downloadTask = new Runnable() &#123;</div><div class="line"></div><div class="line">        @Override</div><div class="line">        public void run() &#123;</div><div class="line">            // TODO</div><div class="line">            // 在这里进行 http request.网络请求相关操作</div><div class="line">            String savePath = getVideoFilePathStr();</div><div class="line">                downlodFlag = ftpUtils.downLoadTypeFile(dir, savePath, &quot;mp4&quot;);</div><div class="line"></div><div class="line">            Message msg = new Message();</div><div class="line">            Bundle data = new Bundle();</div><div class="line">            data.putBoolean(&quot;value&quot;, downlodFlag);</div><div class="line">            msg.setData(data);</div><div class="line">            dhandler.sendMessage(msg);</div><div class="line">        &#125;</div><div class="line">    &#125;;</div><div class="line">    Handler dhandler = new Handler() &#123;</div><div class="line">        @Override</div><div class="line">        public void handleMessage(Message msg) &#123;</div><div class="line">            super.handleMessage(msg);</div><div class="line">            Bundle data = msg.getData();</div><div class="line">            flag = data.getBoolean(&quot;value&quot;);</div><div class="line">            if (flag) &#123;</div><div class="line">                new Thread(initDataTask).run();</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;;</div><div class="line"></div><div class="line"></div><div class="line">    private void checkUpdateVideo() &#123;</div><div class="line"></div><div class="line">//        Intent intent= new Intent(this, UpdateService.class);</div><div class="line">//        startService(intent);</div><div class="line">        mHandler = new Handler();</div><div class="line"></div><div class="line">        mHandler.post(new Runnable() &#123;</div><div class="line">            @Override</div><div class="line">            public void run() &#123;</div><div class="line">                new Thread(networkTask).start();</div><div class="line">                mHandler.postDelayed(this, Constants.checkViedoTime);</div><div class="line">            &#125;</div><div class="line">        &#125;);</div><div class="line">    &#125;</div></pre></td></tr></table></figure>

          
        
      
    </div>
    
    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/04/13/企业征信客户端竞争品分析/" itemprop="url">
                  企业征信移动客户端竞品分析
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">Posted on</span>
            <time itemprop="dateCreated" datetime="2016-04-13T17:12:31+08:00" content="Apr 13 2016">
              Apr 13 2016
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">In</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/文档/" itemprop="url" rel="index">
                    <span itemprop="name">文档</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2016/04/13/企业征信客户端竞争品分析/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2016/04/13/企业征信客户端竞争品分析/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          
             <span id="/2016/04/13/企业征信客户端竞争品分析/" class="leancloud_visitors" data-flag-title="企业征信移动客户端竞品分析">
               &nbsp; | &nbsp;
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               <span class="post-meta-item-text">visitors </span>
               <span class="leancloud-visitors-count"></span>
              </span>
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="企加">企加</h1><h2 id="图例">图例</h2><p><img src="http://7xsxyu.com2.z0.glb.clouddn.com/gif/jiaohuqjiahome.gif" alt=""></p>
<h2 id="布局">布局</h2><p>1.首页是传统的tab 和view的切换模式，中间的按钮“企业查询”重点突出<br>2，进入app第一个模块是企业头条，分为推荐和我的关注，推荐是所有企业的新闻，我的关注是关注的企业相关头条。</p>
<h2 id="颜色">颜色</h2><p>以蓝白黑灰为主，白色背景，蓝色主题</p>
<h2 id="交互细节">交互细节</h2><p>下拉刷新自定义的”企“字设计的较好，周围边框有loadding效果，输出处理结果会以动态添加试图的形式通知客户，点击进入webview在工具栏的下方有progressbar指示进度。</p>
<h2 id="小结">小结</h2><p>刷新的交互和中间按钮的强调设计</p>
<h1 id="企查查">企查查</h1><h2 id="图例-1">图例</h2><p><img src="http://7xsxyu.com2.z0.glb.clouddn.com/gif/jiaohuqcchome.gif" alt=""></p>
<h2 id="布局-1">布局</h2><p>1.侧滑式首页设计，没有下侧的切换按钮<br>2，系统栏颜色配合工具栏<br>2，从上往下依次是搜索区域，功能引导区域，热搜区域，关注区域，新闻区域</p>
<h2 id="颜色-1">颜色</h2><p>以红色为主题，白色背景，图标颜色很多</p>
<h2 id="交互细节-1">交互细节</h2><p>搜索区域下整体滑动，保持搜索区域始终可见，新闻区域不触发下拉刷新，点击刷新的方式</p>
<h2 id="小结-1">小结</h2><p>系统状态栏的设置整体感较强</p>
<p><a href="https://www.jianguoyun.com/p/DftAlPkQpN36BRjD1BQ" target="_blank" rel="external">Excel分析文档下载</a></p>

          
        
      
    </div>
    
    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/03/22/MongoDB/" itemprop="url">
                  MongoDB
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">Posted on</span>
            <time itemprop="dateCreated" datetime="2016-03-22T20:55:47+08:00" content="Mar 22 2016">
              Mar 22 2016
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">In</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/文档/" itemprop="url" rel="index">
                    <span itemprop="name">文档</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2016/03/22/MongoDB/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2016/03/22/MongoDB/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          
             <span id="/2016/03/22/MongoDB/" class="leancloud_visitors" data-flag-title="MongoDB">
               &nbsp; | &nbsp;
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               <span class="post-meta-item-text">visitors </span>
               <span class="leancloud-visitors-count"></span>
              </span>
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="简单介绍">简单介绍</h1><h2 id="简介">简介</h2><p>MongoDB是一个基于分布式文件存储的数据库，由C++语言编写，旨在为WEB应用提供可扩展的高性能数据存储解决方案。</p>
<p>MongoDB是一个高性能，开源，无模式的文档型数据库，官方给自己的定义是Key-value存储(高性能和高扩展)和传统RDBMS(丰富的查询和功能)之间的一座桥梁</p>
<h2 id="Document和BSON">Document和BSON</h2><p>MongoDB中保存的数据格式为BSON，如：。<br><img src="http://7xqtsx.com1.z0.glb.clouddn.com/bson.jpg" alt=""></p>
<p>MongoDB中数据的基本单元称为文档(Document)，它是MongoDB的核心概念，由多个键极其关联的值有序的放置在一起组成，数据库中它对应于关系型数据库的行。</p>
<p>数据在MongoDB中以BSON（Binary-JSON）文档的格式存储在磁盘上。</p>
<p>BSON（Binary Serialized Document Format）是一种类json的一种二进制形式的存储格式，简称Binary JSON，BSON和JSON一样，支持内嵌的文档对象和数组对象，但是BSON有JSON没有的一些数据类型，如Date和BinData类型。</p>
<p>BSON的优点是灵活性高，但它的缺点是空间利用率不是很理想，BSON有三个特点：轻量性、可遍历性、高效性。</p>
<h1 id="文档的增删查改">文档的增删查改</h1><h2 id="简单插入文档">简单插入文档</h2><p>在数据库中，数据插入是最基本的操作，在MongoDB使用db.collection.insert(document)语句来插入文档，如下图：<br><img src="http://7xqtsx.com1.z0.glb.clouddn.com/insert1.png" alt=""></p>
<p>document是文档数据，collection是存放文档数据的集合。</p>
<p>例如：所有用户的信息存放在users集合中，每个用户的信息为一个user文档，插入数据:</p>
<p>db.users.insert(user);<br>如果collection存在，document会添加到collection目录下， 如果collection不存在，数据库会先创建collection，然后再保存document。</p>
<p>练习一下：把自己的姓名(name)和年龄(age)保存到person集合中！<br>如果想要查看已插入的person文档，可以使用：db.person.find()查看当前库中person集合里的数据。</p>
<p>如果想要查看当前数据库中的集合列表，可以使用：show collections。</p>
<p>db.person.insert({name:’阿牛’, age:28});</p>
<h2 id="批量插入文档">批量插入文档</h2><p>insert语句不但可以插入单个文档，还可以一次性插入多个文档。</p>
<p>插入多个文档时，insert命令的参数为一个数组，数组元素为BSON格式的文档。</p>
<p>多个文档可以放在一个数组内，一次插入多条数据，例如：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">db.users.insert([&#123;name:&quot;tommy&quot;&#125;,&#123;name:&quot;xiaoming&quot;&#125;])</div></pre></td></tr></table></figure>
<p>文档批量插入非常方便，但是使用批量插入时也有一些问题需要注意，因为BSON格式的限制，一次插入的数据量不能超过16M，在一个insert命令中插入多条数据时，MongoDB不保证完全成功或完全失败。</p>
<p>使用insert命令将以下数据一次性插入person集合中。</p>
<p>文／Te_Lee（简书作者）<br>原文链接：<a href="http://www.jianshu.com/p/1e402922ee32/" target="_blank" rel="external">http://www.jianshu.com/p/1e402922ee32/</a><br>著作权归作者所有，转载请联系作者获得授权，并标注“简书作者”。</p>
<table>
<thead>
<tr>
<th>name</th>
<th style="text-align:center">age</th>
<th style="text-align:center">status</th>
</tr>
</thead>
<tbody>
<tr>
<td>mary</td>
<td style="text-align:center">21</td>
<td style="text-align:center">A</td>
</tr>
<tr>
<td>Lucy</td>
<td style="text-align:center">89</td>
<td style="text-align:center">A</td>
</tr>
<tr>
<td>Jacky</td>
<td style="text-align:center">30</td>
<td style="text-align:center">A</td>
</tr>
</tbody>
</table>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">db.person.insert([</div><div class="line"> &#123;name:&quot;Mary&quot;,  age:21, status:&quot;A&quot;&#125;,</div><div class="line"> &#123;name:&quot;Lucy&quot;,  age:89, status:&quot;A&quot;&#125;,</div><div class="line"> &#123;name:&quot;Jacky&quot;, age:30, status:&quot;A&quot;&#125; </div><div class="line">]);</div></pre></td></tr></table></figure>
<h2 id="查询文档">查询文档</h2><p>在MongoDB中，查询指向特定的文档集合，查询设定条件，指明MongoDB需要返回的文档；查询也可以包含一个投影，指定返回的字段。</p>
<p>如下图，在查询过程指定了一个查询条件和一个排序修饰。</p>

          
        
      
    </div>
    
    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/03/21/nodejs-mongodb实现简单购物网站/" itemprop="url">
                  nodejs + mongodb实现简单购物网站
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">Posted on</span>
            <time itemprop="dateCreated" datetime="2016-03-21T22:53:59+08:00" content="Mar 21 2016">
              Mar 21 2016
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">In</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/项目/" itemprop="url" rel="index">
                    <span itemprop="name">项目</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2016/03/21/nodejs-mongodb实现简单购物网站/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2016/03/21/nodejs-mongodb实现简单购物网站/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          
             <span id="/2016/03/21/nodejs-mongodb实现简单购物网站/" class="leancloud_visitors" data-flag-title="nodejs + mongodb实现简单购物网站">
               &nbsp; | &nbsp;
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               <span class="post-meta-item-text">visitors </span>
               <span class="leancloud-visitors-count"></span>
              </span>
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="需求与设计">需求与设计</h1><h2 id="功能介绍">功能介绍</h2><ol>
<li><p>用户可以完成注册、登录然后登录后对商品的浏览。</p>
</li>
<li><p>登录之后，用户可以对相关商品进行选购并添加到购物车。</p>
</li>
<li><p>用户可以对购物车里面的商品进行增加、减少、删除操作。</p>
</li>
<li><p>用户可对购物车商品进行结算操作。</p>
</li>
</ol>
<h2 id="技术选型">技术选型</h2><p>本项目涉及使用到NodeJS、Express框架、MongoDB数据库、Mongoose对象模型库，详细介绍如下：</p>
<p>NodeJS：Node.js采用Google Chrome浏览器的V8引擎，一个后端的Javascript运行环境，提供很多系统级的API，如文件操作、网络编程等。</p>
<p>MongoDB：MongoDB是一个基于分布式文件存储的一个高性能，开源，无模式的文档型数据库，数据以BSON文档的格式存储在磁盘上。</p>
<p>Express：一个简洁、灵活的基于Node.js的Web应用开发框架, 支持Ejs、jade等多种模板，并且提供一系列强大的功能，比如：模板解析、静态文件服务、中间件、路由控制等等。</p>
<p>Mongoose：一个针对MongoDB操作的对象模型库，封装了MongoDB对文档的的一些增删改查等常用方法。</p>
<h2 id="结构划分">结构划分</h2><p>项目主要分为以下几大模块：注册模块，登录模块，商品模块、购物车模块、结算模块。</p>
<ol>
<li><p>用户注册模块：填写用户名、密码、确认密码后，实现成功注册，然后进行登录。</p>
</li>
<li><p>用户登录模块：填写已注册的用户名称，填写正确的密码，进入商品展示页面。</p>
</li>
<li><p>商品模块：用户选择相关产品加入购物车。</p>
</li>
<li><p>购物车模块：对相关商品进行增加、减少、删除操作。</p>
</li>
<li><p>结算模块：对购物车内已选择商品进行结算。</p>
</li>
</ol>
<p>模块结构如下图所示：<br><img src="http://7xqtsx.com1.z0.glb.clouddn.com/module.jpg" alt="image"></p>
<h2 id="流程设计">流程设计</h2><p>此流程图显示用户可以进行登录和注册操作，如果用户已经注册，则可以直接登录，若未注册则必须先注册成功后才能进行登录，登录成功后可以进入商品页浏览商品，也可以选择相关商品并可加入购物车，在购物车页面内可以对购物车商品进行相关操作，最后结选择相关商品进行结算。</p>
<p>其流程如下图所示：</p>
<p><img src="http://7xqtsx.com1.z0.glb.clouddn.com/process.jpg" alt=""></p>
<h1 id="数据库设计">数据库设计</h1><h2 id="数据库介绍">数据库介绍</h2><p>数据库的使用呢，我们这里选择了MongoDB。</p>
<p>MongoDB的简单介绍如下：</p>
<p>MongoDB是一个开源的NoSQL数据库，相比MySQL那样的关系型数据库，它更显得轻巧、灵活， 非常适合在数据规模很大、事务性不强的场合下使用。同时它也是一个对象数据库，没有表、行等概念，也没有固定的模式和结构，所有的数据以文档的形式存储，数据格式就是JSON。</p>
<p>MongoDB —— 是一个对象数据库，没有表、行等概念，也没有固定的模式和结构，所有的数据以Document(以下简称文档)的形式存储(Document，就是一个关联数组式的对象，它的内部由属性组成，一个属性对应的值可能是一个数、字符串、日期、数组，甚至是一个嵌套的文档。)</p>
<p>我们一共要创建三个集合，分别是user(用户)集合、commodity(商品)集合、cart(购物车)集合，后面我们会一一介绍。</p>
<h2 id="user集合属性值展示">user集合属性值展示</h2><p>关于user集合，我们设计的属性有name(用户名)、password(密码)， 如下所示：</p>
<p><img src="http://7xqtsx.com1.z0.glb.clouddn.com/c_user.jpg" alt=""></p>
<h2 id="commodity集合属性值展示">commodity集合属性值展示</h2><p>关于commodity集合，我们设计的属性有name(商品名称)、price(商品价格)、imgSrc(商品展示图片路径)， 如下所示：<br><img src="http://7xqtsx.com1.z0.glb.clouddn.com/c_commodity.jpg" alt=""></p>
<h2 id="carts集合属性值展示">carts集合属性值展示</h2><p>关于cart集合，我们设计的属性有uId(用户ID)、cId(商品ID)、cName(商品名称)、cPrice(商品价格)、cImgSrc(商品展示图片路径)、cQuantity(商品数量)、cStatus(商品结算状态，未结算为false,已结算为true)， 如下所示：<br>![](<a href="http://7xqtsx.com1.z0.glb.clouddn.com/c_cart.jpg" target="_blank" rel="external">http://7xqtsx.com1.z0.glb.clouddn.com/c_cart.jpg</a></p>
<h1 id="详细设计">详细设计</h1><h2 id="注册模块功能设计介绍">注册模块功能设计介绍</h2><p>功能：本模块主要用于新用户注册，用户通过表单提供用户名和密码信息，系统根据用户提供的注册信息对用户进行具体操作。</p>
<p>输入操作：用户名、密码、确认密码。</p>
<p>对应处理：</p>
<ol>
<li>输入注册信息：在页面提供的表单处输入用户的用户名和密码信息，点击“注册”按钮提交表单数据信息。已注册用户，可点击“登录”按钮，进入登录页面。</li>
</ol>
<p>(2) 用户注册身份验证：连接数据库，以输入的“用户名”数据为查询条件来查看输入用户名是否已存在，如果用户名未注册，则提示注册成功并转到登录页进行登录，如果用户已注册，则给出用户已存在提示并重新注册。</p>
<h2 id="注册界面">注册界面</h2><p>用户注册界面草图如下：</p>
<p><img src="http://7xqtsx.com1.z0.glb.clouddn.com/Register.jpg" alt=""></p>
<h2 id="登录模块设计与实现">登录模块设计与实现</h2><p>功能：本模块主要用于对用户身份进行鉴别。用户通过表单提供用户名和密码信息，系统根据用户提供的登录信息对用户进行查询鉴别。 如果身份合法，则用户可进入商品页面。</p>
<p>输入操作：用户名、密码。</p>
<p>对应处理：</p>
<ol>
<li><p>输入用户的登录信息：在页面提供的表单处输入用户的用户名和密码信息，点击“登录”按钮提交表单数据信息。 也可点击“注册”按钮，注册新用户。</p>
</li>
<li><p>用户身份进行验证：连接数据库，打开user集合，检验用户登录信息。以输入的“用户名”数据为查询条件来查看用户是否存在，如果存在，继续检验其输入密码是否正确，密码和用户名都正确，则进入商品展示页面；如果用户名不存在或密码不正确，则给出相应的提示。</p>
</li>
</ol>
<h2 id="登录界面草图">登录界面草图</h2><p>用户登录界面草图如下：</p>
<p><img src="http://7xqtsx.com1.z0.glb.clouddn.com/Login.jpg" alt=""></p>
<h2 id="商品页面介绍">商品页面介绍</h2><p>商品页呢，我们主要要来展示商品，用户登录成功之后将会跳入商品页，可对所有商品进行查看， 每个商品信息的内容包括：商品名称、商品图片、商品价格，用户可浏览也可将其加入购物车。</p>
<p>页面草图如下所示：</p>
<p><img src="http://7xqtsx.com1.z0.glb.clouddn.com/Commodity.jpg" alt=""></p>
<h2 id="商品页面介绍-1">商品页面介绍</h2><p>关于购物车页面，主要展示用户已购买的商品，包括商品的信息、价格、数量，当然用户可以对其中商品进行增加、减少、删除操作，最后，用户可选择对其中商品进行结算，选择结算后，会提示相应的付款金额。</p>
<p>页面草图如下所示：</p>
<p><img src="http://7xqtsx.com1.z0.glb.clouddn.com/Cart.jpg" alt=""></p>
<h1 id="实现注册">实现注册</h1><h2 id="简单启动">简单启动</h2><p>首先呢，我们先新建一个项目工程目录，然后在目录下创建启动文件app.js，开始我们的第一步。</p>
<p>这里我们会用到Express框架来实现相关功能，所以，需要先安装它，具体安装方法这里就不在做介绍了。</p>
<p>在启动文件添加如下内容，来测试Express框架是否引用成功。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">var express = require(&apos;express&apos;);</div><div class="line">var app = express();</div><div class="line">app.get(&apos;/&apos;, function (req, res) &#123;  </div><div class="line">   res.send(&apos;Hello World!&apos;);</div><div class="line">&#125;);</div><div class="line"> </div><div class="line">app.listen(80);</div></pre></td></tr></table></figure>
<p>浏览器查看结果，如收到响应信息则表明我们项目的第一步已经成功搞定。</p>
<h2 id="创建目录">创建目录</h2><p>项目已经启动成功，下面我们开始创建相关目录，用于存储不同的文件。</p>
<p>说明：右侧栏”文件管理”中可添加相应目录和文件。</p>
<ol>
<li><p>public目录：存放静态文件。</p>
</li>
<li><p>routes目录：存放路由文件。</p>
</li>
<li><p>views目录： 存放页面文件。</p>
</li>
<li><p>common目录：存放公共文件。</p>
</li>
<li><p>public目录(可不选)，新建javascripts、stylesheets、images三个目录用以存储js、css、img相关文件。</p>
</li>
</ol>
<p>这里我们内置了一些js、css文件来实现简单页面样式和操作，在页面视图中直接使用即可，引用方法如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">&lt;link href=&quot;example/css/bootstrap.min.css&quot; rel=&quot;stylesheet&quot; &gt;</div><div class="line"> </div><div class="line">&lt;script src=&quot;example/js/jquery.min.js&quot; type=&quot;text/javascript&quot;&gt;&lt;/script&gt;</div><div class="line"> </div><div class="line">&lt;script src=&quot;example/js/bootstrap.min.js&quot; type=&quot;text/javascript&quot;&gt;&lt;/script&gt;</div></pre></td></tr></table></figure>
<h2 id="添加文件">添加文件</h2><p>有了目录，我们开始添加文件，先来添加一个登录页面register.html，便于管理和开发我们统一把视图页面放到views目录下。</p>
<p>views目录，添加register.html注册视图页，如下简单效果图：<br><img src="http://7xqtsx.com1.z0.glb.clouddn.com/Register.jpg" alt=""></p>
<p>有了视图页面，我们就可以访问它了，那要如何访问呢，这里就要使用到ejs模板了，安装方法不在阐述，直接如下引用：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">app.set( &apos;view engine&apos;, &apos;html&apos; );</div><div class="line">app.engine( &apos;.html&apos;, require( &apos;ejs&apos; ).__express );</div></pre></td></tr></table></figure>
<p>使用engine函数注册模板引擎并指定处理后缀名为html的文件。</p>
<p>设定视图存放的目录</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">app.set(&apos;views&apos;, require(&apos;path&apos;).join(__dirname, &apos;views&apos;));</div></pre></td></tr></table></figure>
<p>如果是在本地项目中，我们还要指定本地静态资源访问的路径,如下设置：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">app.use(express.static(require(&apos;path&apos;).join(__dirname, &apos;public&apos;)));</div></pre></td></tr></table></figure>
<h2 id="访问注册页">访问注册页</h2><p>有了视图页面，下面我们就开始访问它，app.js文件部分内容，引入相关模块资源，然后简单访问如下：</p>
<p>app.get(‘/‘, function (req, res) {<br>    res.render(‘register’);<br>});<br>app.listen(80);<br>本节启动访问80端口，如成功看到注册页面则表示项目已经运行成功，如未看到，查看相关错误信息，是否缺少相关模块，安装和引用即可。</p>
<h2 id="定义Schema">定义Schema</h2><p>首先在common目录内添加models.js文件用来保存各个集合的Schema文件(集合属性)，也便于我们查看和访问，具体内容如下所示：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">module.exports = &#123;</div><div class="line">    user: &#123;</div><div class="line">        name: &#123; type: String, required: true &#125;,</div><div class="line">        password: &#123; type: String, required: true &#125;,</div><div class="line">        gender: &#123; type: Boolean, default: true &#125;</div><div class="line">    &#125;</div><div class="line">&#125;;</div></pre></td></tr></table></figure>
<p>有了集合的Schema文件，如何访问呢，接着我们会介绍如何使用Model模型操作这些属性。</p>
<h2 id="创建公共方法">创建公共方法</h2><p>还是common目录，我们在新建一个公共方法 —— dbHelper.js文件，来操作这些Schema，因为后面还会涉及此问题，所以我们写成一个公共的方法，dbHelper文件内容如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">var mongoose = require(&apos;mongoose&apos;),</div><div class="line">    Schema = mongoose.Schema,</div><div class="line">    models = require(&apos;./models&apos;);</div><div class="line"> </div><div class="line">for(var m in models) &#123;</div><div class="line">    mongoose.model(m, new Schema(models[m]));</div><div class="line">&#125;</div><div class="line">module.exports = &#123;</div><div class="line">    getModel: function (type) &#123;</div><div class="line">        return _getModel(type);</div><div class="line">    &#125;</div><div class="line">&#125;;</div><div class="line">var _getModel = function (type) &#123;</div><div class="line">    return mongoose.model(type);</div><div class="line">&#125;;</div></pre></td></tr></table></figure>
<p>如上所示我们通过getModel可获取集合的Model模型就可以对数据库有实质性的操作了</p>
<p>关于Model，简单介绍：由Schema构造生成的模型，具有数据库操作的行为。</p>
<h2 id="添加函数">添加函数</h2><p>关于dbHelper.js文件里方法的访问很简单，如下所示：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">global.dbHelper = require( &apos;./common/dbHelper&apos; );</div></pre></td></tr></table></figure>
<p>这里我们使用globa来定义全局变量dbHelper，那么dbHelper就可以在任何模块内调用了。</p>
<p>然后我们就开始修改register视图页面，添加单击事件，例如：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">&lt;input type=&quot;button&quot;  onclick=&quot;register()&quot; value=&quot;注 册&quot; /&gt;</div></pre></td></tr></table></figure>
<p>对应register()函数，大致如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line">function register()&#123;</div><div class="line">   //通过serialize()方法进行序列化表单值，创建文本字符串。</div><div class="line">   var data = $(&quot;form&quot;).serialize();</div><div class="line">   //例如：&quot;username=张三&amp;password=12345&quot;</div><div class="line">   $.ajax(&#123;</div><div class="line">       url:&apos;/register&apos;,</div><div class="line">       type:&apos;POST&apos;,</div><div class="line">       data:data,</div><div class="line">       success:function(data,status)&#123;</div><div class="line">           if(status == &apos;success&apos;)&#123;</div><div class="line">               location.href=&apos;register&apos;;</div><div class="line">           &#125;</div><div class="line">       &#125;,</div><div class="line">       error:function(res,err)&#123;</div><div class="line">           location.href=&apos;register&apos;;</div><div class="line">       &#125;</div><div class="line">   &#125;);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="添加路由">添加路由</h2><p>这里我们需要新建一个文件register.js，专门用来处理来之register页面的post请求， 在后面的学习中还会有多个不同处理文件，万所以我们统一管理在routes目录下，在实际开发中我们可能需要针对不同文件请求给出相应文件的处理，所以我们就做分开处理。</p>
<p>这里贴出register.js文件处理get和post请求的相关代码以供参考，如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div></pre></td><td class="code"><pre><div class="line">// app：express对象</div><div class="line">module.exports = function ( app ) &#123;</div><div class="line">  app.get(&apos;/register&apos;, function(req, res) &#123;</div><div class="line">      res.render(&apos;register&apos;);</div><div class="line">  &#125;);</div><div class="line">  app.post(&apos;/register&apos;, function (req, res) &#123;</div><div class="line">     var User = global.dbHelper.getModel(&apos;user&apos;),</div><div class="line">     uname = req.body.uname;</div><div class="line">     User.findOne(&#123;name: uname&#125;, function (error, doc) &#123;</div><div class="line">       if (doc) &#123;</div><div class="line">            req.session.error = &apos;用户名已存在！&apos;;</div><div class="line">            res.send(500);</div><div class="line">        &#125; else &#123;</div><div class="line">            User.create(&#123;</div><div class="line">                name: uname,</div><div class="line">                password: req.body.upwd</div><div class="line">            &#125;, function (error, doc) &#123;</div><div class="line">                if (error) &#123;</div><div class="line">                    res.send(500);</div><div class="line">                &#125; else &#123;</div><div class="line">                    req.session.error = &apos;用户名创建成功！&apos;;</div><div class="line">                    res.send(200);</div><div class="line">                &#125;</div><div class="line">            &#125;);</div><div class="line">        &#125;</div><div class="line">    &#125;);</div><div class="line">  &#125;);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="模块的加载和引用">模块的加载和引用</h2><p>register的post请求处理中，我们使用了session(express-session模块)还有处理post请求数据的body属性(body-parser和multer模块)，需先安装他们，然后引用即可，如下参考：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">&lt;pre&gt;</div><div class="line">//引用模块</div><div class="line">var bodyParser = require(&apos;body-parser&apos;);</div><div class="line">var multer = require(&apos;multer&apos;);</div><div class="line">var session = require(&apos;express-session&apos;);</div><div class="line"></div><div class="line"> </div><div class="line">//调用中间件使用</div><div class="line">app.use(bodyParser.json());</div><div class="line">app.use(bodyParser.urlencoded(&#123; extended: true &#125;));</div><div class="line">app.use(multer());</div></pre></td></tr></table></figure>
<p>后面我们还会再次添加多个路由记录，所以便于管理和访问，我们可以把他们统一放到一起，比如routes目录下新建index.js文件专门用来存放添加的文件，代码如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">module.exports = function ( app ) &#123;</div><div class="line">    require(&apos;./register&apos;)(app);</div><div class="line">&#125;;</div></pre></td></tr></table></figure>
<p>那么我们在app.js文件中直接引用index.js文件就可以访问这些文件了，如下所示：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">require(&apos;./routes&apos;)(app); //app:express对象。;</div></pre></td></tr></table></figure>
<h2 id="中间件传递信息">中间件传递信息</h2><p>这里我们就一步到位，在register的post请求处理中我们使用了express-session模块来保存相关信息，这里我们就使用中间件来传递这些提示信息，中间件内容如下所示：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">app.use(function(req, res, next)&#123;</div><div class="line">    res.locals.user = req.session.user; //保存用户信息</div><div class="line">    var err = req.session.error;  //保存结果响应信息</div><div class="line">    res.locals.message = &apos;&apos;;  // 保存html标签</div><div class="line">    if (err) res.locals.message = &apos;&lt;div class=&quot;alert alert-danger&quot; style=&quot;margin-bottom: 20px;color:red;&quot;&gt;&apos; + err + &apos;&lt;/div&gt;&apos;;</div><div class="line">    next();</div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<p>这里注意中间件的安放位置，还有我们设置了变量message并为其简单添加了样式，这里我们在register视图里就用它来作为操作结果的信息提示，直接添加&lt;%- message %&gt;到视图第一个div内即可。</p>
<p>关于注册我们基本已经准备就绪，开始打开连接数据库并设置用户过期时间(注意执行顺序，应放置在首个中间件位置)，app.js条件内容如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">mongoose.connect(&quot;mongodb://127.0.0.1:27017/test&quot;);</div><div class="line"> </div><div class="line">app.use(session(&#123;</div><div class="line">    secret:&apos;secret&apos;,</div><div class="line">    cookie:&#123;</div><div class="line">        maxAge:1000*60*30</div><div class="line">    &#125;</div><div class="line">&#125;));</div></pre></td></tr></table></figure>
<p>到这里，注册功能已经完毕，在用户注册的信息录入中，我们没有进行相关的为空、两次密码的不匹配等等验证等等(可自行添加)，赶紧注册试试吧，本地的话可以通过MongoVUE(可视化客户端)来查看数据是否成功写入数据库。</p>
<h1 id="登陆和浏览">登陆和浏览</h1><h2 id="添加视图">添加视图</h2><p>前面我们已经实现了注册功能，用户可以成功注册，接着我们就开始让用户登录了，此节我们就实现用户的登录功能，并且登录成功后跳转商品页面查看商品。</p>
<p>首先，我们还是在views目录下添加登录视图页面 —— login.html，效果图如下：</p>
<p><img src="http://7xqtsx.com1.z0.glb.clouddn.com/Login.jpg" alt=""></p>
<h2 id="访问视图">访问视图</h2><p>有了登录页面，那么注册页面(register)的登录按钮添加指向登陆页面的链接，相应的登陆页的注册按钮也是如此。</p>
<p>这里我们还是添加一个相对应的文件用来处理login页面的请求，routes目录下新建名为login.js的文件，先来增加一个处理get请求的方法，代码参考如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">module.exports = function ( app ) &#123;</div><div class="line">    app.get(&apos;/login&apos;,function(req,res)&#123;</div><div class="line">        res.render(&apos;login&apos;);</div><div class="line">    &#125;);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>和register文件一样添加到index.js中，如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">require(&apos;./login&apos;)(app);</div></pre></td></tr></table></figure>
<p>register视图页的register()函数的回调中，当注册成功时我们就可以跳转到登陆页面了，如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">location.href=&apos;login&apos;;</div></pre></td></tr></table></figure>
<p>好，赶紧试试登陆、注册按钮能否成功跳转吧！</p>
<h2 id="实现登陆">实现登陆</h2><p>我们为登陆按钮增加单击事件和对应函数login()，参考如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line">function login()&#123;</div><div class="line">  //通过serialize()方法获取form表单内输入框用户名、密码的值</div><div class="line">  //如：&quot;username=张三&amp;password=12345&quot;</div><div class="line">  var data = $(&quot;form&quot;).serialize();</div><div class="line">  $.ajax(&#123;</div><div class="line">      url:&apos;/login&apos;,</div><div class="line">      type:&apos;POST&apos;,</div><div class="line">      data:data,</div><div class="line">      success:function(data,status)&#123;</div><div class="line">          if(status == &apos;success&apos;)&#123;</div><div class="line">              location.href=&apos;home&apos;;</div><div class="line">          &#125;</div><div class="line">      &#125;,</div><div class="line">      error:function(data,status)&#123;</div><div class="line">           if(status == &quot;error&quot;)&#123;</div><div class="line">              location.href=&apos;login&apos;</div><div class="line">           &#125;</div><div class="line">       &#125;</div><div class="line">   &#125;);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>在相应的login.js文件中，我们还得添加相对应的post请求处理方法，接着我们会讲述。</p>
<h2 id="登陆处理">登陆处理</h2><p>关于login视图页的post请求处理，我们需要判断用户所输入用户名是否存在，密码是否正确，并使用变量保存相应提示信息，当用户名和密码全部正确时，则返回成功并保存用户的个人信息，用作来判断用户的登陆状态，具体可参考register视图页的post请求。</p>
<p>login.js文件的post请求处理代码，参考如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">app.post(&apos;/login&apos;, function (req, res) &#123;</div><div class="line">  var User = global.dbHelper.getModel(&apos;user&apos;),uname = req.body.uname;</div><div class="line">  User.findOne(&#123;name: uname&#125;, function (error, doc) &#123;</div><div class="line">           if (用户不存在) &#123;</div><div class="line">                req.session.error = &apos;用户名不存在！&apos;;</div><div class="line">                res.send(404);</div><div class="line">            &#125; else if(用户存在，密码错误) &#123;</div><div class="line">                   req.session.error = &quot;密码错误!&quot;;</div><div class="line">                   res.send(404);</div><div class="line">               &#125;else&#123; //用户名、密码正确</div><div class="line">                   req.session.user=doc;</div><div class="line">                   res.send(200);</div><div class="line">               &#125;</div><div class="line">            &#125;);</div><div class="line">    &#125;);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>还记得我们登陆的本地变量message嘛，用来保存html标签并包含相应提示信息，这里在登陆页面我们也可以使用，用法：&lt;%- message %&gt;，指定到相应位置即可。</p>
<h2 id="商品页视图">商品页视图</h2><p>用户登录成功之后则跳转至home视图页面(商品主页)，就可以进行对商品的浏览和选择了。</p>
<p>还是views目录，添加home商品视图页，如下简单效果图：</p>
<p><img src="http://7xqtsx.com1.z0.glb.clouddn.com/Commodity.jpg" alt=""></p>
<p>用户成功登录之后跳转至home页，这里我们还是做分开处理，routes目录下新建home.js文件用来处理来之home也的get请求。</p>
<p>这里我们假设如果用户未登录将不能查看商品主页，所以，在请求处理中我们还需要判断用户的登陆状态，这个可以使用我们在登录处理时所保存的用户个人信息。</p>
<p>关于商品页的视图展示我们只需要有其名称、价格、图片，这里使用ejs模板循环展示，可参考如下方式：</p>
<p>注：Commodity：商品集合所有数据，内置图片路径为“/example/img”</p>
<p><img src="http://7xqtsx.com1.z0.glb.clouddn.com/home_refer.jpg" alt=""></p>
<h2 id="请求处理">请求处理</h2><p>在home的get请求处理中，我们需要首先判断用户的登陆状态，只有用户登录了方可跳转到商品页，如果为登陆呢则跳转到登录页，而且在进入商品页的时候并传入Commodity集合的所有数据数据在页面展示。</p>
<p>首先呢，在models.js文件中定义Commodity集合的Schema属性，共包括商品名称、商品价格、商品图片，这里简单定义如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">commodity: &#123;</div><div class="line">   name: String,</div><div class="line">   price: Number,</div><div class="line">   imgSrc: String</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>routes目录下添加home.js文件(index.js文件中引用)。</p>
<p>具体处理方式可参考如下代码：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">module.exports = function ( app ) &#123;</div><div class="line">    app.get(&apos;/home&apos;, function (req, res) &#123;</div><div class="line">        if(req.session.user)&#123;</div><div class="line">            var Commodity = global.dbHelper.getModel(&apos;commodity&apos;);</div><div class="line">            Commodity.find(&#123;&#125;, function (error, docs) &#123;</div><div class="line">               //将Commoditys变量传入home模板</div><div class="line">               res.render(&apos;home&apos;,&#123;Commoditys:docs&#125;);</div><div class="line">            &#125;);</div><div class="line">        &#125;else&#123;</div><div class="line">            req.session.error = &quot;请先登录&quot;</div><div class="line">            res.redirect(&apos;/login&apos;);</div><div class="line">        &#125;</div><div class="line">    &#125;);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="添加商品">添加商品</h2><p>添加商品，views目录下添加addcommodity视图页面用来对商品的添加，这里简单样式参考如下：<br><img src="http://7xqtsx.com1.z0.glb.clouddn.com/Addcommodity.jpg" alt=""></p>
<p>相对应的addcommodity函数参考代码如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">//imgSrc表示图片路径)，这里内置了5张图片，格式为：xmsz-X.jpg(X为1-5数字)。</div><div class="line">var data = $(&quot;form&quot;).serialize()+&quot;&amp;imgSrc=&quot; + &quot;xmsz-&quot;+Math.floor(Math.random()*5+1)+&quot;.jpg&quot;;</div><div class="line">$.ajax(&#123;</div><div class="line">     url:&apos;/addcommodity&apos;,</div><div class="line">     type:&apos;POST&apos;,</div><div class="line">     data:data,</div><div class="line">     success:function(data,status)&#123;</div><div class="line">         if(status == &apos;success&apos;)&#123;</div><div class="line">            alert(&apos;添加成功！&apos;)</div><div class="line">         &#125;</div><div class="line">     &#125;,</div><div class="line">     error:function(data,err)&#123;</div><div class="line">         alert(&apos;添加失败！&apos;)</div><div class="line">     &#125;</div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<h2 id="商品添加处理">商品添加处理</h2><p>这里我们就直接在home.js文件中添加保存商品的处理方法，如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line">app.get(&apos;/addcommodity&apos;, function(req, res) &#123;</div><div class="line">    res.render(&apos;addcommodity&apos;);</div><div class="line">&#125;);</div><div class="line">app.post(&apos;/addcommodity&apos;, function (req, res) &#123;</div><div class="line">    var Commodity = global.dbHelper.getModel(&apos;commodity&apos;);</div><div class="line">    Commodity.create(&#123;</div><div class="line">        name: req.body.name,</div><div class="line">        price: req.body.price,</div><div class="line">        imgSrc: req.body.imgSrc</div><div class="line">    &#125;, function (error, doc) &#123;</div><div class="line">        if (doc) &#123;</div><div class="line">            res.send(200);</div><div class="line">        &#125;else&#123;</div><div class="line">            res.send(404);</div><div class="line">        &#125;</div><div class="line">    &#125;);</div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<p>到这里关于商品页的展示和添加就完成了</p>
<h1 id="购物车结算">购物车结算</h1><h2 id="添加商品链接">添加商品链接</h2><p>上节课程里我们已经实现了商品的添加和展示，接下来我们开始进行对商品的操作——加入购物车。</p>
<p>首先，商品页的加入购物车按钮、购物车查看按钮添加链接，如下所示：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">&lt;a href=&quot;/addToCart/&lt;%=Commoditys[i]._id%&gt;&quot;&gt;加入购物车&lt;/a&gt;</div></pre></td></tr></table></figure>
<p>我们先定义购物车(cart)集合的Schema属性，包含：uId(用户ID)、cId(商品ID)、cName(商品名称)、cPrice(商品价格)、cImgSrc(商品展示图片路径)、cQuantity(商品数量)、cStatus(商品结算状态，默认为false)，参考如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">cart:&#123;</div><div class="line">       uId: &#123; type: String &#125;,</div><div class="line">       cId: &#123; type: String &#125;,</div><div class="line">       cName: &#123; type: String &#125;,</div><div class="line">       cPrice: &#123; type: String &#125;,</div><div class="line">       cImgSrc: &#123; type:String &#125; ,</div><div class="line">       cQuantity: &#123; type: Number &#125;,</div><div class="line">       cStatus : &#123; type: Boolean, default: false  &#125;</div><div class="line">   &#125;</div></pre></td></tr></table></figure>
<p>以上属性定义我们还是统一放到models.js文件中以方便管理和操作。<br>接着views目录下添加购物车(cart.html)视图页面，参考如下：<br><img src="http://7xqtsx.com1.z0.glb.clouddn.com/Cart.jpg" alt=""></p>
<p>购物车页面的展示实现可参考如下贴图：<br><img src="http://7xqtsx.com1.z0.glb.clouddn.com/cart_refer.jpg" alt=""></p>
<h2 id="访问视图-1">访问视图</h2><p>接着在routes目录添加cart.js文件(index.js文件中引用)，来定义路由处理规则。</p>
<ol>
<li>比如cart路径的处理，如下：</li>
</ol>
<p>1.1 检测登陆用户是否过期，已过期则跳转login页同时给出提示信息。<br>1.2 通过global.dbHelper.getModel方法获取cart模型。<br>1.3 通过find查询用户所有商品并传入模板，条件：用户ID，结算状态。<br>1.4 贴出部分代码：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">app.get(&apos;/cart&apos;, function(req, res) &#123;</div><div class="line">     ......</div><div class="line">   Cart.find(&#123;&quot;uId&quot;:用户ID,&quot;cStatus&quot;:false&#125;,function (error, docs) &#123;</div><div class="line">       res.render(&apos;cart&apos;,&#123;carts:docs&#125;);</div><div class="line">   &#125;);</div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<ol>
<li>加入购物车按钮链接所对应路径的处理，如：/addToCart/:商品id</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">app.get(&quot;/addToCart/:id&quot;, function(req, res) &#123;...&#125;);</div></pre></td></tr></table></figure>
<p>2.1 通过req.params.id获取商品ID号并检测登陆用户状态。<br>2.2 通过global.dbHelper.getModel方法获取购物车(cart)、商品(commodity)模型。<br>2.3 商品已存在则进行更新操作，贴出部分参考代码：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">Cart.update(&#123;&quot;uId&quot;:用户ID,&quot;cId&quot;:商品ID&#125;,&#123;$set:&#123;cQuantity:已有数量+1&#125;&#125;</div></pre></td></tr></table></figure></p>
<p>2.4商品未存在则进行添加操作，贴出部分代码：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">Commodity.findOne(&#123;&quot;_id&quot;: 商品ID&#125;, function (error, doc) &#123;</div><div class="line">        Cart.create(&#123;</div><div class="line">            uId: 用户ID,</div><div class="line">            cId: 商品ID,</div><div class="line">            cName: doc.name,</div><div class="line">            cPrice: doc.price,</div><div class="line">            cImgSrc: doc.imgSrc,</div><div class="line">            cQuantity : 1</div><div class="line">        &#125;,function(error,doc)&#123;</div><div class="line">            if(doc)&#123;</div><div class="line">                res.redirect(&apos;/home&apos;);</div><div class="line">            &#125;</div><div class="line">        &#125;);</div><div class="line">&#125;);</div></pre></td></tr></table></figure></p>
<h2 id="商品的单选和全选">商品的单选和全选</h2><p>在购物车页面展示还是使用ejs模板(具体实现可参考贴图)来实现用户购物车商品的展示，现期间我们用到了checkbox，这里我们就来简单的实现商品的全选和单选。</p>
<p>首先，简单介绍实现步骤：</p>
<ol>
<li>用户选中全选按钮时，列表内选框全部变为勾选状态。</li>
<li>用户取消全选按钮选中状态时，列表内选框全部取消勾选状态。</li>
<li>列表内选框为全部勾选状态时，全选按钮为选中状态，反之不勾选。</li>
<li>全选按钮未选中情况下，当列表内按钮全部选中则全选按钮也要被选中。<br>对于checkbox按钮如下图所示：<br><img src="http://7xqtsx.com1.z0.glb.clouddn.com/checkbox.jpg" alt=""></li>
</ol>
<p>注：data-index属性存储索引值用来获取商品数量，data=id存储商品ID，data-price存储商品价格。</p>
<p>实现全选：为全选框(如id为CheckAll)添加单击事件，这里我们使用prop方法设置checkbox状态、is方法判断checkbox状态，如下参考示例：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">$(&apos;#CheckAll&apos;).click(function()&#123;</div><div class="line">      var self = $(this);</div><div class="line">      $(&apos;input[name=&quot;chkItem&quot;]&apos;).each(function()&#123;</div><div class="line">         $(this).prop(&quot;checked&quot;,self.is(&apos;:checked&apos;));</div><div class="line">      &#125;);</div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<p>实现单选：单选框(如name为chkItem)添加单击事件，这里我们使用prop方法设置checkbox状态、not方法判断checkbox状态，如下参考示例：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">$(&apos;input[name=&quot;chkItem&quot;]:checkbox&apos;).click(function()&#123;</div><div class="line">   var isCheck = $(&apos;input[name=&quot;chkItem&quot;]:not(:checked)&apos;).length?false:true;</div><div class="line">   $(&apos;#CheckAll&apos;).prop(&quot;checked&quot;,isCheck);</div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<p>到这里我们就简单实现了按钮的全选和单选，以上方法可供参考也可以自行思路去实现。</p>
<h2 id="商品的增加和减少">商品的增加和减少</h2><p>前面我们实现了对于商品的单选和全选功能，下面我们就开始实现商品数量的加减。</p>
<p>对于+、-按钮如下图所示：<br><img src="http://7xqtsx.com1.z0.glb.clouddn.com/add-subtr.jpg" alt=""></p>
<p>简单实现步骤如下：</p>
<ol>
<li>定义data-type属性用于区分+、-按钮。</li>
<li>a标签添加单击事件。并同时改变显示框的值。</li>
<li>使用siblings()方法改变同级标签的数量值。<br>具体实现可参考如下方法：</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">$(&apos;.li-quantity a&apos;).click(function()&#123;</div><div class="line">    var self = $(this);</div><div class="line">    var type = self.attr(&apos;data-type&apos;),</div><div class="line">        num = parseFloat(self.siblings(&apos;input&apos;).val());</div><div class="line">    if(type == &apos;add&apos;)&#123;</div><div class="line">          num += 1;</div><div class="line">     &#125;else if(type == &apos;subtr&apos;)&#123;</div><div class="line">          if(num &gt; 1)&#123;</div><div class="line">             num -= 1;</div><div class="line">          &#125;else&#123;</div><div class="line">             return false;</div><div class="line">          &#125;</div><div class="line">     &#125;</div><div class="line">    self.siblings(&apos;input&apos;).val(num);</div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<p>到这里对于商品数量的加、减也实现了，接着我们开始实现用户选中商品的总价格计算功能。</p>
<h2 id="计算总金额">计算总金额</h2><p>商品的状态选择和数量的加减功能我们已经实现了，选择我们就开始实现当用户选择相关商品时总金额的计算功能。</p>
<p>实现步骤如下：</p>
<ol>
<li>定义公共方法，用于用户不同加、减、全选等操作时皆可调用。</li>
<li>循环列表内所有被选中的checkbox(假设name为chkItem)。</li>
<li>使用checkbox的相应属性值，来获取价格和数量。</li>
<li>定义全局变量(假设为sum)存储总金额并赋值显示。<br>具体方法实现可参考如下内容：</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">sum = 0;</div><div class="line">$(&apos;input[name=&quot;chkItem&quot;]:checked&apos;).each(function()&#123;</div><div class="line">    var self = $(this),</div><div class="line">     price = self.attr(&apos;data-price&apos;),</div><div class="line">     index = self.attr(&apos;data-index&apos;);</div><div class="line">     var quantity = $(&apos;#Q&apos;+index).val();</div><div class="line">     sum +=(parseFloat(price)*parseFloat(quantity));</div><div class="line"> &#125;);</div><div class="line"> $(&quot;金额标签&quot;).html(&apos;￥&apos;+ sum +&apos;.00&apos;);</div></pre></td></tr></table></figure>
<p>到这里，选中商品的价格总计功能也就简单实现了。</p>
<h2 id="商品结算">商品结算</h2><p>关于结算功能，这里就做简单介绍，当用户点击结算按钮时，计算出被选商品的总金额，给予alert出总金额，数据库则更新相应商品的结算状态和数量，当然你也可以在购物车集合中添加一个用户消费金额的属性来保存所消费的金额总数更好，这里就简单处理了。</p>
<p>具体功能实现这里简单介绍如下：</p>
<ol>
<li>定义公共方法，用于用户不同加、减、全选等操作时皆可调用。</li>
<li>循环列表内所有被选中的checkbox(假设name为chkItem)。</li>
<li>使用checkbox的相应属性值，来获取价格和数量。</li>
<li>定义全局变量(假设为sum)存储总金额并赋值显示。<br>这里贴出部分实现代码，如下：</li>
</ol>
<p>//结算方法内容</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">$(&apos;input[name=&quot;chkItem&quot;]:checked&apos;).each(function()&#123;</div><div class="line">     var self = $(this),</div><div class="line">         //通过data-index属性，获取索引值</div><div class="line">         index = self.attr(&apos;data-index&apos;),</div><div class="line">        //通过data-id属性，获取对应ID</div><div class="line">         ID= self.attr(&apos;data-id&apos;);</div><div class="line">     var 数量= $(&apos;#Q&apos;+index).val();</div><div class="line">     var data = &#123; &quot;cid&quot;: ID, &quot;cnum&quot;:数量&#125;;</div><div class="line">     //发送数据请求</div><div class="line">     ...   </div><div class="line">&#125;);</div><div class="line">alert(&apos;所付金额为：￥&apos;+sum);</div><div class="line">location.href = &quot;cart&quot;;</div></pre></td></tr></table></figure>
<p>cart.js文件添加对应路由处理如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">app.post(&quot;路径&quot;,function(req,res)&#123;</div><div class="line">   var Cart = global.dbHelper.getModel(&apos;cart&apos;);</div><div class="line">   Cart.update(&#123;&quot;_id&quot;:req.body.ID&#125;,&#123;$set : &#123; cQuantity : req.body.数量,cStatus:true &#125;&#125;,function(error,doc)&#123; </div><div class="line">...</div></pre></td></tr></table></figure>
<h2 id="商品删除">商品删除</h2><p>关于商品的删除功能就简单多了，我们只需获取其ID即可实现对于购物车内商品的删除操作</p>
<p>在购物车商品的展示功能实现时，我们就可以获取其ID，如下参考：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">&lt;a href=&quot;/delFromCart/&lt;%=carts[i]._id%&gt;&quot; &gt;删除&lt;/a&gt;</div><div class="line">cart.js文件，添加对应路径处理方法，这里简单实现参考如下：</div><div class="line"></div><div class="line">app.get(&quot;/delFromCart/:id&quot;, function(req, res) &#123;</div><div class="line">   //req.params.id 获取ID号</div><div class="line">   var Cart = global.dbHelper.getModel(&apos;cart&apos;);</div><div class="line">   Cart.remove(&#123;&quot;_id&quot;:req.params.id&#125;,function(error,doc)&#123;</div><div class="line">       //成功返回1  失败返回0</div><div class="line">       if(doc &gt; 0)&#123;</div><div class="line">           res.redirect(&apos;/cart&apos;);</div><div class="line">       &#125;</div><div class="line">   &#125;);</div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<p>好，到这里所有功能都已经实现了，赶快好好回味回味所学所悟吧！</p>
<p>附：项目源码下载地址：<a href="https://github.com/hubwiz/example-node" target="_blank" rel="external">https://github.com/hubwiz/example-node</a></p>

          
        
      
    </div>
    
    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/03/18/ConnectManager网络请求的三层封装（模块－转换－底层）/" itemprop="url">
                  ConnectManager网络请求的三层封装（模块－转换－底层）
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">Posted on</span>
            <time itemprop="dateCreated" datetime="2016-03-18T14:01:47+08:00" content="Mar 18 2016">
              Mar 18 2016
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">In</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/代码/" itemprop="url" rel="index">
                    <span itemprop="name">代码</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2016/03/18/ConnectManager网络请求的三层封装（模块－转换－底层）/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2016/03/18/ConnectManager网络请求的三层封装（模块－转换－底层）/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          
             <span id="/2016/03/18/ConnectManager网络请求的三层封装（模块－转换－底层）/" class="leancloud_visitors" data-flag-title="ConnectManager网络请求的三层封装（模块－转换－底层）">
               &nbsp; | &nbsp;
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               <span class="post-meta-item-text">visitors </span>
               <span class="leancloud-visitors-count"></span>
              </span>
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>调用层－数据解析层－底层</p>
<h2 id="调用层">调用层</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div></pre></td><td class="code"><pre><div class="line">private void getSystemToken() &#123;</div><div class="line">        GetSystemTokenParam param = new GetSystemTokenParam();</div><div class="line">        param.loginId=Constants.LOGINID;</div><div class="line">        String password=mPasswordView.getText().toString();</div><div class="line">        String encpwd=PasswordUtil.getEncPwd(Constants.LOGINID, password);</div><div class="line">        param.password= encpwd;</div><div class="line">//        param.password= password;</div><div class="line">        L.i(&quot;systemID&quot;,mUsernameView.getText().toString());</div><div class="line">        L.i(&quot;明文密码&quot;,mPasswordView.getText().toString());</div><div class="line">        L.i(&quot;loginID&quot;,Constants.LOGINID);</div><div class="line">        L.i(&quot;password 加密结果为&quot;,encpwd);</div><div class="line">        L.i(&quot;password 解密结果为&quot;,PasswordUtil.getDecPwd(Constants.LOGINID,encpwd));</div><div class="line">        ConnectManager.getInstance().getSystemToken(param,Tokencallback);</div><div class="line">    &#125;</div><div class="line"></div><div class="line"></div><div class="line">    private final AbstractRequestListener&lt;GetSystemTokenBean&gt; Tokencallback = new AbstractRequestListener&lt;GetSystemTokenBean&gt;() &#123;</div><div class="line"></div><div class="line">        @Override</div><div class="line">        public void onComplete(GetSystemTokenBean bean) &#123;</div><div class="line">            tokenBean = bean;</div><div class="line">            tHandler.sendEmptyMessage(ActivityForResultUtil.REQUEST_DATA_SUCCESS);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        @Override</div><div class="line">        public void onError(CustomError customError) &#123;</div><div class="line"></div><div class="line">            Message msg = tHandler.obtainMessage();</div><div class="line">            msg.obj = customError;</div><div class="line">            msg.what = ActivityForResultUtil.REQUEST_DATA_ERROR;</div><div class="line">            tHandler.sendMessage(msg);</div><div class="line"></div><div class="line">        &#125;</div><div class="line"></div><div class="line">        @Override</div><div class="line">        public void onFault(CustomError fault) &#123;</div><div class="line"></div><div class="line">            Message msg = tHandler.obtainMessage();</div><div class="line">            msg.obj = fault;</div><div class="line">            msg.what = ActivityForResultUtil.REQUEST_DATA_FAULT;</div><div class="line">            tHandler.sendMessage(msg);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">    &#125;;</div></pre></td></tr></table></figure>
<h2 id="数据转化层">数据转化层</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div></pre></td><td class="code"><pre><div class="line">/**</div><div class="line">    * 请求systemToken</div><div class="line">    *</div><div class="line">    * @param params</div><div class="line">    * @param callback</div><div class="line">    */</div><div class="line">   public void getSystemToken(final GetSystemTokenParam params,</div><div class="line">                            final AbstractRequestListener&lt;GetSystemTokenBean&gt; callback) &#123;</div><div class="line">       exector.execute(new Runnable() &#123;</div><div class="line"></div><div class="line">           @Override</div><div class="line">           public void run() &#123;</div><div class="line"></div><div class="line">               try &#123;</div><div class="line">                   String method = params.getParam().getString(&quot;method&quot;);</div><div class="line">                   String response = HttpConnectionUtil.openUrl(</div><div class="line">                           Constants.SERVER_URL + method, &quot;GET&quot;,</div><div class="line">                           params.getParam(),false);</div><div class="line">                   GetSystemTokenBean bean = GetSystemTokenBean.getSystemTokenBean(response);</div><div class="line">                   if (callback != null) &#123;</div><div class="line">                       callback.onComplete(bean);</div><div class="line">                   &#125;</div><div class="line">               &#125; catch (RuntimeException e) &#123;</div><div class="line">                   e.printStackTrace();</div><div class="line">                   if (callback != null) &#123;</div><div class="line">                       callback.onFault(new CustomError(network_error));</div><div class="line">                   &#125;</div><div class="line">               &#125; catch (JSONException e) &#123;</div><div class="line">                   e.printStackTrace();</div><div class="line">                   if (callback != null) &#123;</div><div class="line">                       callback.onError(new CustomError(json_error));</div><div class="line">                   &#125;</div><div class="line">               &#125;</div><div class="line">           &#125;</div><div class="line">       &#125;);</div><div class="line"></div><div class="line">   &#125;</div></pre></td></tr></table></figure>
<h2 id="网络底层">网络底层</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div></pre></td><td class="code"><pre><div class="line">/**</div><div class="line">    * 发送http请求</div><div class="line">    *</div><div class="line">    * @param url</div><div class="line">    * @param method</div><div class="line">    *            GET 或 POST</div><div class="line">    * @param params</div><div class="line">    * @return</div><div class="line">    */</div><div class="line">   public static String openUrl(String url, String method, Bundle params,boolean Token) &#123;</div><div class="line">       if (method.equals(&quot;GET&quot;)) &#123;</div><div class="line">           if (params != null) &#123;</div><div class="line">               url = url + &quot;?&quot; + encodeUrl(params);</div><div class="line">           &#125;</div><div class="line">       &#125;</div><div class="line">       String response = &quot;&quot;;</div><div class="line"></div><div class="line">       try &#123;</div><div class="line">           L.i(method + &quot; URL: &quot; + url);</div><div class="line">           HttpClient httpClient = HttpConnectionUtil.getNewHttpClient();</div><div class="line">           HttpGet httpGet = new HttpGet(url);</div><div class="line">           if(Token==false)&#123;</div><div class="line"></div><div class="line">           &#125;else&#123;</div><div class="line"></div><div class="line">               httpGet.setHeader(&quot;systemToken&quot;, Constants.SYSTEMTOKEN);</div><div class="line">           &#125;</div><div class="line">           //连接超时</div><div class="line">           httpClient.getParams().setParameter(CoreConnectionPNames.CONNECTION_TIMEOUT, 20000);</div><div class="line">           // 读取超时</div><div class="line">           httpClient.getParams().setParameter(CoreConnectionPNames.SO_TIMEOUT, 20000);</div><div class="line"></div><div class="line">           HttpResponse resp = httpClient.execute(httpGet);</div><div class="line"></div><div class="line">           if (resp.getStatusLine().getStatusCode() != HttpStatus.SC_OK) &#123;</div><div class="line">               L.i(LOG_TAG, &quot;httpGet fail, status code = &quot; + resp.getStatusLine().getStatusCode());</div><div class="line"></div><div class="line">           &#125;else&#123;</div><div class="line">               response = EntityUtils.toString(resp.getEntity());</div><div class="line"></div><div class="line">           &#125;</div><div class="line">       &#125; catch (Exception e) &#123;</div><div class="line">           throw new RuntimeException(e.getMessage(), e);</div><div class="line">       &#125;</div><div class="line"></div><div class="line">       L.i(&quot;LOG_TAG&quot;+response);</div><div class="line">       return response;</div><div class="line">   &#125;</div></pre></td></tr></table></figure>
<h1 id="具体封装">具体封装</h1><h2 id="AbstractRequestListener">AbstractRequestListener</h2><p>public abstract class AbstractRequestListener<t extends="" object="">{</t></p>
<pre><code>/<span class="keyword">*</span><span class="keyword">*</span>
 <span class="keyword">*</span> 将response请求解析为针对具体请求的bean
 <span class="keyword">*</span>
 <span class="keyword">*</span> <span class="comment">@param response</span>
 <span class="keyword">*</span>             请求完成后的响应字符串
 <span class="keyword">*</span> <span class="comment">@return</span>
 <span class="keyword">*</span>             若解析成功，返回解析后的对象，否则返回null
 <span class="keyword">*</span>/
<span class="comment">@SuppressWarnings("unchecked")</span>
public T parse(String response) {
    Class<span class="variable">&lt;?&gt;</span> c = this.getGenericType();
    try {
        Constructor<span class="variable">&lt;T&gt;</span> constructor = (Constructor<span class="variable">&lt;T&gt;</span>) c.getDeclaredConstructor(String.class);
        T result = constructor.newInstance(response);
        return result;
    } catch (Exception e) {
        e.printStackTrace();
    }
    return null;
}

/<span class="keyword">*</span><span class="keyword">*</span>
 <span class="keyword">*</span> 获取T的类型
 <span class="keyword">*</span> <span class="comment">@param</span>
 <span class="keyword">*</span> <span class="comment">@return</span>
 <span class="keyword">*</span>/
private Class<span class="variable">&lt;?&gt;</span> getGenericType() {
    Type genType = getClass().getGenericSuperclass();
    if (!(genType instanceof ParameterizedType)) {
        return Object.class;
    }
    Type[] params = ((ParameterizedType) genType).getActualTypeArguments();
    if (params.length <span class="variable">&lt; 1) {
        throw new RuntimeException("Index outof bounds");
    }
    if (!(params[0] instanceof Class)) {
        return Object.class;
    }
    return (Class&lt;?&gt;</span>) params[0];
}

 /<span class="keyword">*</span><span class="keyword">*</span>
 <span class="keyword">*</span> 请求完成后以对象形式返回服务器的响应的结果
 <span class="keyword">*</span>
 <span class="keyword">*</span> <span class="comment">@param bean</span>
 <span class="keyword">*</span>             服务器返回的响应字符串解析后得到的对象
 <span class="keyword">*</span>        
 <span class="keyword">*</span>/
public abstract void onComplete(T bean);

/<span class="keyword">*</span><span class="keyword">*</span>
 <span class="keyword">*</span> 服务器返回了错误结果，已经正确的链接上了服务器但有错误如：缺少参数.等
 <span class="keyword">*</span>
 <span class="keyword">*</span> <span class="comment">@param customError</span>
 <span class="keyword">*</span>/
public abstract void onError(CustomError customError);

/<span class="keyword">*</span><span class="keyword">*</span>
 <span class="keyword">*</span> 在请求期间发生了严重问题（如：网络故障、访问的地址不存在等）
 <span class="keyword">*</span>
 <span class="keyword">*</span> <span class="comment">@param fault</span>
 <span class="keyword">*</span>/
public abstract void onFault(CustomError fault);
</code></pre><p>}</p>
<h2 id="CustomError">CustomError</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div></pre></td><td class="code"><pre><div class="line">public class CustomError extends RuntimeException &#123;</div><div class="line"></div><div class="line">	private static final long serialVersionUID = 1L;</div><div class="line">    /**</div><div class="line">     * 错误码</div><div class="line">     */</div><div class="line">	private int mErrorCode;</div><div class="line"></div><div class="line">	/** 原始响应URL */</div><div class="line">	private String mResponse;</div><div class="line"></div><div class="line">	public CustomError() &#123;</div><div class="line">		super();</div><div class="line">	&#125;</div><div class="line">	public CustomError(String errorMessage) &#123;</div><div class="line">		super(errorMessage);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	public CustomError(int errorCode, String errorMessage, String orgResponse) &#123;</div><div class="line">		super(errorMessage);</div><div class="line">		this.mErrorCode = errorCode;</div><div class="line">		this.mResponse = orgResponse;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	public String getOrgResponse() &#123;</div><div class="line">		return mResponse;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	public int  getErrorCode() &#123;</div><div class="line">		return mErrorCode;</div><div class="line">	&#125;</div><div class="line">	@Override</div><div class="line">	public String toString() &#123;</div><div class="line">		return &quot;errorCode:&quot; + this.mErrorCode + &quot;\nerrorMessage:&quot;</div><div class="line">				+ this.getMessage() + &quot;\norgResponse:&quot; + this.mResponse;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	/**</div><div class="line">	 * 将服务器返回的errorMessage转换成定义的易于理解的字符串</div><div class="line">	 *</div><div class="line">	 * @param errorCode</div><div class="line">	 * 			服务器返回的错误代码</div><div class="line">	 * @param errorMessage</div><div class="line">	 * 			服务器返回的错误字符串，和错误代码一一对应</div><div class="line">	 * @return</div><div class="line">	 */</div><div class="line">	public static String interpretErrorMessage(int errorCode, String errorMessage) &#123;</div><div class="line">		switch (errorCode)</div><div class="line">		&#123;</div><div class="line">			/**</div><div class="line">			 * 错误处理</div><div class="line">			 */</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		return errorMessage;</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="RequestParam">RequestParam</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"> */</div><div class="line">public abstract class RequestParam &#123;</div><div class="line"></div><div class="line"></div><div class="line">	/**</div><div class="line">	 * 设置请求参数</div><div class="line">	 * @return</div><div class="line">	 */</div><div class="line">    public abstract Bundle getParam();</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="ResponseBean">ResponseBean</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div></pre></td><td class="code"><pre><div class="line">public abstract class ResponseBean implements Serializable &#123;</div><div class="line"></div><div class="line">	public String response;</div><div class="line">	//</div><div class="line"></div><div class="line">	public ResponseBean()</div><div class="line">	&#123;</div><div class="line"></div><div class="line">	&#125;</div><div class="line">	public ResponseBean(String response) throws JSONException &#123;</div><div class="line">		// TODO Auto-generated constructor stub</div><div class="line"></div><div class="line">		if(response == null || response.equals(&quot;&quot;) ||response.equals(&quot;null&quot;))</div><div class="line">			throw new JSONException(&quot;数据解析异常&quot;);</div><div class="line"></div><div class="line">		this.response = response;</div><div class="line"></div><div class="line">	&#125;</div><div class="line"></div><div class="line">	public void setResponse(String response)&#123;</div><div class="line">		this.response = response;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	public String getResponse() &#123;</div><div class="line">		return response;</div><div class="line">	&#125;</div><div class="line">	/**</div><div class="line">	 * 保存</div><div class="line">	 */</div><div class="line">	protected  void saveModel()</div><div class="line">	&#123;</div><div class="line">		   L.i(&quot;save_model&quot;);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	/**</div><div class="line">	 * 更新</div><div class="line">	 */</div><div class="line">	protected  void updateModel()</div><div class="line">	&#123;</div><div class="line">		 L.i(&quot;update_model&quot;);</div><div class="line">	&#125;</div><div class="line"></div><div class="line"></div><div class="line">	/**</div><div class="line">	 * 删除</div><div class="line">	 */</div><div class="line">	protected   void deleteModel()</div><div class="line">	&#123;</div><div class="line">		 L.i(&quot;delete_model&quot;);</div><div class="line">	&#125;</div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h1 id="用法">用法</h1><p>参见Demo，给别人做的毕业设计。</p>
<p>Demo地址<a href="https://github.com/mzeht/ZhiHuiYun" target="_blank" rel="external">https://github.com/mzeht/ZhiHuiYun</a></p>

          
        
      
    </div>
    
    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/03/17/express框架/" itemprop="url">
                  express框架
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">Posted on</span>
            <time itemprop="dateCreated" datetime="2016-03-17T12:08:02+08:00" content="Mar 17 2016">
              Mar 17 2016
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">In</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/文档/" itemprop="url" rel="index">
                    <span itemprop="name">文档</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2016/03/17/express框架/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2016/03/17/express框架/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          
             <span id="/2016/03/17/express框架/" class="leancloud_visitors" data-flag-title="express框架">
               &nbsp; | &nbsp;
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               <span class="post-meta-item-text">visitors </span>
               <span class="leancloud-visitors-count"></span>
              </span>
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="基础知识">基础知识</h1><h2 id="Express介绍">Express介绍</h2><p>　　npm提供了大量的第三方模块，其中不乏许多Web框架，比如我们本章节要讲述的一个轻量级的Web框架 ——— Express。</p>
<p>　　Express是一个简洁、灵活的node.js Web应用开发框架, 它提供一系列强大的功能，比如：模板解析、静态文件服务、中间件、路由控制等等,并且还可以使用插件或整合其他模块来帮助你创建各种 Web和移动设备应用,是目前最流行的基于Node.js的Web开发框架，并且支持Ejs、jade等多种模板，可以快速地搭建一个具有完整功能的网站。</p>
<p>　　好，下面我们就开始吧！</p>
<p>NPM安装</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">npm install express</div></pre></td></tr></table></figure>
<p>获取、引用</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">var express = require(&apos;express&apos;);</div><div class="line">var app = express();</div></pre></td></tr></table></figure>
<p>通过变量“app”我们就可以调用express的各种方法了，好戏刚刚开始，继续加油吧！</p>
<h2 id="创建应用">创建应用</h2><p>　　认识了Express框架，我们开始创建我们的第一个express应用。</p>
<p>　　在我们的默认项目主文件app.js添加如下内容：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">var express = require(&apos;express&apos;);</div><div class="line">var app = express();</div><div class="line">app.get(&apos;/&apos;, function (request, response) &#123;  </div><div class="line">   response.send(&apos;Hello World!&apos;);</div><div class="line">&#125;);</div><div class="line"> </div><div class="line">app.listen(80);</div></pre></td></tr></table></figure>
<p>　　说明：在后面课程学习中，我们会统一使用80端口用于监听请求。</p>
<p>　　添加完毕之后，通过右侧栏的“测试地址”来查看浏览器内容，当看到“Hello World!”内容就表明一个简单的express应用已经创建成功了。
　　</p>
<h2 id="get请求">get请求</h2><p>　前面我们实现了一个简单的express应用，下面我们就开始具体讲述它的具体实现，首先我们先来学习Express的常用方法。</p>
<p>　　get方法 —— 根据请求路径来处理客户端发出的GET请求。</p>
<p>　　格式：app.get(path,function(request, response));</p>
<p>　　path为请求的路径，第二个参数为处理请求的回调函数，有两个参数分别是request和response，代表请求信息和响应信息。</p>
<p>如下示例：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">var express = require(&apos;express&apos;);</div><div class="line">var app = express();</div><div class="line"> </div><div class="line">app.get(&apos;/&apos;, function(request, response) &#123;</div><div class="line">   response.send(&apos;Welcome to the homepage!&apos;);</div><div class="line">&#125;);</div><div class="line">app.get(&apos;/about&apos;, function(request, response) &#123;</div><div class="line">   response.send(&apos;Welcome to the about page!&apos;);</div><div class="line">&#125;);</div><div class="line">app.get(&quot;*&quot;, function(request, response) &#123;</div><div class="line">    response.send(&quot;404 error!&quot;);</div><div class="line">&#125;);</div><div class="line">app.listen(80);</div></pre></td></tr></table></figure>
<p>　　上面示例中，指定了about页面路径、根路径和所有路径的处理方法。并且在回调函数内部，使用HTTP回应的send方法，表示向浏览器发送一个字符串。</p>
<p>　　参照以上代码，试试自己设定一个get请求路径，然后浏览器访问该地址是否可以请求成功。
　　</p>
<h2 id="all函数的基本用法">all函数的基本用法</h2><p>　　和get函数不同app.all()函数可以匹配所有的HTTP动词，也就是说它可以过滤所有路径的请求，如果使用all函数定义中间件，那么就相当于所有请求都必须先通过此该中间件。</p>
<p>格式：app.all(path,function(request, response));</p>
<p>如下所示，我们使用all函数在请求之前设置响应头属性。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line">var express = require(&quot;express&quot;);</div><div class="line">var app = express();</div><div class="line"> </div><div class="line">app.all(&quot;*&quot;, function(request, response, next) &#123;</div><div class="line">    response.writeHead(200, &#123; &quot;Content-Type&quot;: &quot;text/html;charset=utf-8&quot; &#125;);      //设置响应头属性值</div><div class="line">    next();</div><div class="line">&#125;);</div><div class="line"> </div><div class="line">app.get(&quot;/&quot;, function(request, response) &#123;</div><div class="line">    response.end(&quot;欢迎来到首页!&quot;);</div><div class="line">&#125;);</div><div class="line"> </div><div class="line">app.get(&quot;/about&quot;, function(request, response) &#123;</div><div class="line">    response.end(&quot;欢迎来到about页面!&quot;);</div><div class="line">&#125;);</div><div class="line"> </div><div class="line">app.get(&quot;*&quot;, function(request, response) &#123;</div><div class="line">    response.end(&quot;404 - 未找到!&quot;);</div><div class="line">&#125;);</div><div class="line"> </div><div class="line">app.listen(80);</div></pre></td></tr></table></figure>
<p>　　上面代码参数中的“*”表示对所有路径有效，这个方法在给特定前缀路径或者任意路径上处理时会特别有用，不管我们请求任何路径都会事先经过all函数。
　　</p>
<h2 id="use基本用法1">use基本用法1</h2><p>use是express调用中间件的方法，它返回一个函数。</p>
<p>格式：app.use([path], function(request, response, next){});</p>
<p>可选参数path默认为”/“。</p>
<p>1.使用中间件</p>
<p>app.use(express.static(path.join(__dirname, ‘/‘)));<br>如上呢，我们就使用use函数调用express中间件设定了静态文件目录的访问路径(这里假设为根路径)。</p>
<p>2.如何连续调用两个中间件呢，如下示例：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">var express = require(&apos;express&apos;);</div><div class="line">var app = express();</div><div class="line"> </div><div class="line">app.use(function(request, response, next)&#123;</div><div class="line">    console.log(&quot;method：&quot;+request.method+&quot; ==== &quot;+&quot;url：&quot;+request.url);</div><div class="line">    next();</div><div class="line">&#125;);</div><div class="line"> </div><div class="line">app.use(function(request, response)&#123;</div><div class="line">    response.writeHead(200, &#123; &quot;Content-Type&quot;: &quot;text/html;charset=utf-8&quot; &#125;);</div><div class="line">    response.end(&apos;示例：连续调用两个中间件&apos;);</div><div class="line">&#125;);</div><div class="line"> </div><div class="line">app.listen(80);</div></pre></td></tr></table></figure>
<p>回调函数的next参数，表示接受其他中间件的调用，函数体中的next()，表示将请求数据传递给下一个中间件。</p>
<p>上面代码先调用第一个中间件，在控制台输出一行信息，然后通过next()，调用第二个中间件，输出HTTP回应。由于第二个中间件没有调用next方法，所以req对象就不再向后传递了。</p>
<h2 id="use基本用法2">use基本用法2</h2><p>use方法不仅可以调用中间件，还可以根据请求的网址，返回不同的网页内容，如下示例：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line">var express = require(&quot;express&quot;);</div><div class="line">var app = express();</div><div class="line"> </div><div class="line">app.use(function(request, response, next) &#123;</div><div class="line">   if(request.url == &quot;/&quot;) &#123;</div><div class="line">      response.send(&quot;Welcome to the homepage!&quot;);</div><div class="line">   &#125;else &#123;</div><div class="line">      next();</div><div class="line">   &#125;</div><div class="line">&#125;);</div><div class="line"> </div><div class="line">app.use(function(request, response, next) &#123;</div><div class="line">   if(request.url == &quot;/about&quot;) &#123;</div><div class="line">     response.send(&quot;Welcome to the about page!&quot;);</div><div class="line">   &#125;else &#123;</div><div class="line">     next();</div><div class="line">   &#125;</div><div class="line">&#125;);</div><div class="line"> </div><div class="line">app.use(function(request, response) &#123;</div><div class="line">  response.send(&quot;404 error!&quot;);</div><div class="line">&#125;);</div><div class="line">app.listen(80);</div></pre></td></tr></table></figure>
<p>上面代码通过request.url属性，判断请求的网址，从而返回不同的内容。</p>
<h2 id="回调函数">回调函数</h2><p>　　Express回调函数有两个参数，分别是request(简称req)和response(简称res)，request代表客户端发来的HTTP请求，response代表发向客户端的HTTP回应，这两个参数都是对象。示例如下:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">function(req, res) &#123;</div><div class="line"> </div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<h2 id="获取主机名、路径名">获取主机名、路径名</h2><p>　　今天我们就先来学习如何使用req对象来处理客户端发来的HTTP请求。</p>
<p>1.req.host返回请求头里取的主机名(不包含端口号)。</p>
<p>2.req.path返回请求的URL的路径名。</p>
<p>如下示例：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">var express = require(&apos;express&apos;);</div><div class="line">var app = express();</div><div class="line"> </div><div class="line">app.listen(8000);</div><div class="line"></div><div class="line">app.get(&quot;*&quot;, function(req, res) &#123;</div><div class="line">    console.log(req.path);</div><div class="line">    //console.log(req.host);</div><div class="line">    res.send(&quot;req.host获取主机名，req.path获取请求路径名!&quot;);</div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<p>试一试在浏览器中输入任意一个请求路径，通过req查看主机名或请求路径。</p>
<p><a href="http://localhost:8000/about" target="_blank" rel="external">http://localhost:8000/about</a></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">/about</div><div class="line">/favicon.ico</div></pre></td></tr></table></figure>
<h2 id="query基本用法">query基本用法</h2><p>　　query是一个可获取客户端get请求路径参数的对象属性，包含着被解析过的请求参数对象，默认为{}。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">var express = require(&apos;express&apos;);</div><div class="line">var app = express();</div><div class="line"> </div><div class="line">app.get(&quot;*&quot;, function(req, res) &#123;</div><div class="line">    console.log(req.query.参数名);</div><div class="line">    res.send(&quot;测试query属性!&quot;);</div><div class="line">&#125;);</div><div class="line"> </div><div class="line">app.listen(80);</div></pre></td></tr></table></figure>
<p>通过req.query获取get请求路径的对象参数值。</p>
<p>格式：req.query.参数名；请求路径如下示例：</p>
<blockquote>
<p>例1： /search?n=Lenka</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">req.query.n  // &quot;Lenka&quot;</div></pre></td></tr></table></figure>
<blockquote>
<p>例2： /shoes?order=desc&amp;shoe[color]=blue&amp;shoe[type]=converse</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">req.query.order  // &quot;desc&quot;</div><div class="line"> </div><div class="line">req.query.shoe.color  // &quot;blue&quot;</div><div class="line"> </div><div class="line">req.query.shoe.type  // &quot;converse&quot;</div></pre></td></tr></table></figure>
<p>试一试get请求一个带参数路径，使用“req.query.参数名”方法获取请求参数值。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">app.get(&apos;/about&apos;,function(req,res)&#123;</div><div class="line">    console.log(req.query.name);</div><div class="line">    res.send(&quot;name=&quot;+req.query.name);</div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<p><a href="http://localhost:8000/about?name=mzeht&amp;name=jj" target="_blank" rel="external">http://localhost:8000/about?name=mzeht&amp;name=jj</a></p>
<p>name=mzeht,jj</p>
<h2 id="param基本用法">param基本用法</h2><p>和属性query一样，通过req.param我们也可以获取被解析过的请求参数对象的值。</p>
<p>格式：req.param(“参数名”)；请求路径如下示例：</p>
<p>例1： 获取请求根路径的参数值，如/?n=Lenka，方法如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">var express = require(&apos;express&apos;);</div><div class="line">var app = express();</div><div class="line"> </div><div class="line">app.get(&quot;/&quot;, function(req, res) &#123;</div><div class="line">    console.log(req.param(&quot;n&quot;)); //Lenka</div><div class="line">    res.send(&quot;使用req.param属性获取请求根路径的参数对象值!&quot;);</div><div class="line">&#125;);</div><div class="line"> </div><div class="line">app.listen(80);</div></pre></td></tr></table></figure>
<p>例2：我们也可以获取具有相应路由规则的请求对象，假设路由规则为 /user/:name/，请求路径/user/mike,如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">app.get(&quot;/user/:name/&quot;, function(req, res) &#123;</div><div class="line">    console.log(req.param(&quot;name&quot;)); //mike</div><div class="line">    res.send(&quot;使用req.param属性获取具有路由规则的参数对象值!&quot;);</div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<p>PS：所谓“路由”，就是指为不同的访问路径，指定不同的处理方法。<br>如果没有相应参数的数据 req.param 返回值为undefined;</p>
<p>看了上面的示例，试一试使用req.param属性解析一个请求路径对象，并获取请求参数值。</p>
<h2 id="params基本用法">params基本用法</h2><p>和param相似，但params是一个可以解析包含着有复杂命名路由规则的请求对象的属性。</p>
<p>格式：req.params.参数名；</p>
<p>例1. 如上课时请求根路径的例子，我们就可以这样获取，如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">var express = require(&apos;express&apos;);</div><div class="line">var app = express();</div><div class="line"> </div><div class="line">app.get(&quot;/user/:name/&quot;, function(req, res) &#123;</div><div class="line">    console.log(req.params.name); //mike</div><div class="line">    res.send(&quot;使用req.params属性获取具有路由规则的参数对象值!&quot;);</div><div class="line">&#125;);</div><div class="line"> </div><div class="line">app.listen(80);</div></pre></td></tr></table></figure>
<p>查看运行结果，和param属性功能是一样的，同样获取name参数值。</p>
<p>例2：当然我们也可以请求复杂的路由规则，如/user/:name/:id，假设请求地址为：/user/mike/123，如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">app.get(&quot;/user/:name/:id&quot;, function(req, res) &#123;</div><div class="line">    console.log(req.params.id); //&quot;123&quot;</div><div class="line">    res.send(&quot;使用req.params属性复杂路由规则的参数对象值!&quot;);</div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<p>对于请求地址具有路由规则的路径来说，属性params比param属性是不是又强大了那么一点点呢！</p>
<h2 id="send基本用法">send基本用法</h2><p>send()方法向浏览器发送一个响应信息，并可以智能处理不同类型的数据。格式如下：</p>
<p>res.send([body|status], [body]);<br>1.当参数为一个String时，Content-Type默认设置为”text/html”。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">res.send(&apos;Hello World&apos;); //Hello World</div></pre></td></tr></table></figure>
<p>2.当参数为Array或Object时，Express会返回一个JSON。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">res.send(&#123; user: &apos;tobi&apos; &#125;); //&#123;&quot;user&quot;:&quot;tobi&quot;&#125;</div><div class="line">res.send([1,2,3]); //[1,2,3]</div></pre></td></tr></table></figure>
<p>3.当参数为一个Number时，并且没有上面提到的任何一条在响应体里，Express会帮你设置一个响应体，比如：200会返回字符”OK”。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">res.send(200); // OK</div><div class="line">res.send(404); // Not Found</div><div class="line">res.send(500); // Internal Server Error</div></pre></td></tr></table></figure>
<p>send方法在输出响应时会自动进行一些设置，比如HEAD信息、HTTP缓存支持等等。</p>
<p>ps:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">Fri, 18 Mar 2016 11:02:43 GMT express deprecated req.param(name): Use req.params, req.body, or req.query instead at app.js:37:21</div><div class="line">Fri, 18 Mar 2016 11:02:43 GMT express deprecated req.param(name): Use req.params, req.body, or req.query instead at app.js:38:21</div><div class="line">Fri, 18 Mar 2016 11:02:43 GMT express deprecated res.send(status): Use res.sendStatus(status) instead at app.js:42:9</div></pre></td></tr></table></figure>
<h1 id="准备登陆">准备登陆</h1><h2 id="模板引擎">模板引擎</h2><p>　　从本节课程开始我们要使用express框架实现一个简单的用户登陆功能，让我们先准备一下相关资源。</p>
<p>　　在nodejs中使用express框架，它默认的是ejs和jade渲染模板，今天我们就以ejs模板为例，讲述模板渲染网页模板的基础功能。</p>
<p>1.ejs模板安装方法</p>
<p>npm install ejs<br>2.目录下安装好了之后，如何调用呢，如下所示：</p>
<p>//指定渲染模板文件的后缀名为ejs<br>app.set(‘view engine’, ‘ejs’);<br>默认ejs模板只支持渲染以ejs为扩展名的文件，可能在使用的时候会觉得它的代码书写方式很不爽还是想用html的形式去书写，该怎么办呢，这时就得去修改模板引擎了，也就会用到express的engine函数。</p>
<p>engine注册模板引擎的函数，处理指定的后缀名文件。</p>
<p>// 修改模板文件的后缀名为html<br>app.set( ‘view engine’, ‘html’ );<br>// 运行ejs模块<br>app.engine( ‘.html’, require( ‘ejs’ ).<strong>express );<br>“</strong>express”，ejs模块的一个公共属性，表示要渲染的文件扩展名。</p>
<h2 id="静态资源">静态资源</h2><p>由于环境的限制，这里我们就不使用静态资源了，但是实际开发中我们肯定会用到，具体使用规则已在下面列出，可参考。</p>
<p>如果要在网页中加载静态文件（css、js、img），就需要另外指定一个存放静态文件的目录，当浏览器发出非HTML文件请求时，服务器端就会到这个目录下去寻找相关文件。</p>
<p>1.项目目录下添加一个存放静态文件的目录为public。</p>
<p>2.在public目录下在添加三个存放js、css、img的目录，相应取名为javascripts、stylesheets、images。</p>
<p>3.然后就可以把相关文件放到相应的目录下了。</p>
<p>4.比如，浏览器发出如下的样式表请求：</p>
<p> <link href="/stylesheets/bootstrap.min.css" rel="stylesheet" media="screen"><br>服务器端就到public/stylesheets/目录中寻找bootstrap.min.css文件。</p>
<p>有了静态目录文件，我们还得在启动文件里告诉它这个静态文件路径，需要指定一下，如下所示：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">app.use(express.static(require(&apos;path&apos;).join(__dirname, &apos;public&apos;)));</div></pre></td></tr></table></figure>
<p>PS：express.static —— 指定静态文件的查找目录。</p>
<p>使用use函数调用中间件指定express静态访问目录，’public’就是我们我们新建的用来存放静态文件的总目录。</p>
<h2 id="添加视图">添加视图</h2><p>好，下面我们就来添加网页模板了，项目中我们会新建一个目录用来单独存放模板文件，这里我们就统一放到根路径上了。</p>
<p>下面开始新建index.html、login.html、home.html三个页面。</p>
<p>index.html页面参考内容如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">&lt;div style=&quot;height:400px;width:550px;margin:50px auto;margin-left:auto;border:solid 1px;background: rgb(246, 246, 253);&quot;&gt;</div><div class="line">    &lt;div style=&quot;margin-left: 35px;&quot;&gt;</div><div class="line"># 首页</div><div class="line"></div><div class="line"></div><div class="line">        &lt;form action=&quot;#&quot;  role=&quot;form&quot; style=&quot;margin-top: 90px;margin-left: 60px;&quot;&gt;</div><div class="line"># 欢迎进入首页！</div><div class="line">            &lt;div style=&quot;margin-top: 145px;&quot;&gt;</div><div class="line">                &lt;input type=&quot;button&quot; value=&quot;登 陆&quot; /&gt;</div><div class="line">            &lt;/div&gt;</div><div class="line">        &lt;/form&gt;</div><div class="line">    &lt;/div&gt;</div><div class="line">&lt;/div&gt;</div></pre></td></tr></table></figure>
<p>login.html页面参考内容如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line">...</div><div class="line">    &lt;title&gt;用户登录&lt;/title&gt;</div><div class="line">    &lt;meta charset=&quot;utf-8&quot;&gt;</div><div class="line">    &lt;script src=&quot;http://code.jquery.com/jquery-2.1.1.min.js&quot;&gt;&lt;/script&gt;</div><div class="line">...</div><div class="line"> </div><div class="line">&lt;div style=&quot;height:300px;width:350px;margin:100px auto;margin-left:auto;border:solid 1px;background: rgb(246, 246, 253);&quot;&gt;</div><div class="line">    &lt;div style=&quot;width:200px;margin:auto;margin-top:50px;&quot;&gt;</div><div class="line"># 用户登录</div><div class="line">        &lt;form action=&quot;#&quot;  role=&quot;form&quot; method=&quot;post&quot; &gt;</div><div class="line">            &lt;input id=&quot;username&quot; type=&quot;text&quot; name=&quot;username&quot; style=&quot;margin: 20px 0px;&quot; /&gt;</div><div class="line">            &lt;input id=&quot;password&quot; type=&quot;password&quot; name=&quot;password&quot; /&gt;</div><div class="line">            &lt;div style=&quot;margin-top:30px;margin-left:125px;&quot;&gt;</div><div class="line">                &lt;input type=&quot;button&quot; value=&quot;登 陆&quot; /&gt;</div><div class="line">            &lt;/div&gt;</div><div class="line">        &lt;/form&gt;</div><div class="line">    &lt;/div&gt;</div><div class="line">&lt;/div&gt;</div></pre></td></tr></table></figure>
<p>home.html页面参考内容如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">&lt;div style=&quot;height:400px;width:550px;margin:50px auto;margin-left:auto;border:solid 1px;background: rgb(246, 246, 253);&quot;&gt;</div><div class="line">    &lt;div style=&quot;margin-left: 45px;&quot;&gt;</div><div class="line"># 主页</div><div class="line">        &lt;form action=&quot;#&quot;  role=&quot;form&quot; style=&quot;margin-top: 90px;&quot;&gt;</div><div class="line"># 登陆成功！</div><div class="line">            &lt;div style=&quot;margin-top: 145px;&quot;&gt;</div><div class="line">                &lt;input  type=&quot;button&quot; value=&quot;退 出&quot; /&gt;</div><div class="line">            &lt;/div&gt;</div><div class="line">        &lt;/form&gt;</div><div class="line">    &lt;/div&gt;</div><div class="line">&lt;/div&gt;</div></pre></td></tr></table></figure>
<p>和静态文件一样，我们也要设置views存放的目录，如下：<br>// 设定views变量，意为视图存放的目录</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">app.set(&apos;views&apos;, __dirname);</div></pre></td></tr></table></figure>
<p>有了网页模板和指定目录，下面就可以访问它们了。</p>
<h2 id="访问视图">访问视图</h2><p>我们要如何对网页模板进行访问呢，这就要用到res对象的render函数了。</p>
<p>1.render函数，对网页模板进行渲染。</p>
<p>2.格式：res.render(view, [locals], callback);</p>
<p>3.参数view就是模板的文件名callback用来处理返回的渲染后的字符串，options、callback可省略，在渲染模板时locals可为其模板传入变量值，在模板中就可以调用所传变量了，在后面我们会讲述具体使用方法，也可先自行使用看其效果。</p>
<p>4.比如渲染我们刚刚添加的index.html页面，我们就可以在app.js中写入如下内容：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">var express = require(&apos;express&apos;);</div><div class="line">var app = express();</div><div class="line">var path = require(&apos;path&apos;);</div><div class="line"> </div><div class="line">app.set(&apos;views&apos;, __dirname);</div><div class="line"> </div><div class="line">app.set( &apos;view engine&apos;, &apos;html&apos; );</div><div class="line">app.engine( &apos;.html&apos;, require( &apos;ejs&apos; ).__express );</div><div class="line"> </div><div class="line">app.get(&apos;/&apos;, function(req, res) &#123;</div><div class="line">    res.render(&apos;index&apos;);</div><div class="line">&#125;);</div><div class="line"> </div><div class="line">app.listen(8000);</div></pre></td></tr></table></figure>
<p>运行之后在测试地址我们就可以看到所渲染的index页面了，试一试其他页面是否也可渲染成功？</p>
<h2 id="redirect基本用法">redirect基本用法</h2><p>redirect方法允许网址的重定向，跳转到指定的url并且可以指定status，默认为302方式。</p>
<p>格式：res.redirect([status], url);</p>
<p>例1：使用一个完整的url跳转到一个完全不同的域名。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">res.redirect(&quot;http://www.hubwiz.com&quot;);</div></pre></td></tr></table></figure>
<p>例2：跳转指定页面，比如登陆页，如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">res.redirect(&quot;login&quot;);</div></pre></td></tr></table></figure>
<p>后面我们开始实现登陆功能，先试一下redirect重定向，跳转到我们网站如何？</p>
<h1 id="实现登陆">实现登陆</h1><h2 id="访问视图-1">访问视图</h2><p>前面我们已经添加了视图模板并学习了访问视图的方法，那我们就先回顾一下。</p>
<p>1.参考以下代码，地址栏访问这几个请求路径查看是否可以成功。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">app.get(&apos;/&apos;, function(req, res) &#123;</div><div class="line">    res.render(&apos;index&apos;);</div><div class="line">&#125;);</div><div class="line"> </div><div class="line">app.get(&apos;/login&apos;,function(req,res)&#123;</div><div class="line">    res.render(&apos;login&apos;);</div><div class="line">&#125;);</div><div class="line"> </div><div class="line">app.get(&apos;/home&apos;,function(req,res)&#123;</div><div class="line">    res.render(&apos;home&apos;);</div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<p>当浏览器看到了相应的视图页面就说明我们的代码是没有问题的，继续加油吧！</p>
<h2 id="用户登陆">用户登陆</h2><p>前面我们学习了express的get请求方法，今天我们就学习它的post请求方法。</p>
<p>1.post方法 —— 根据请求路径来处理客户端发出的Post请求。</p>
<p>2.格式：app.post(path,function(req, res));</p>
<p>3.和get方法一样，path为请求的路径，第二个参数为处理请求的回调函数，req和res分别代表请求信息和响应信息。</p>
<p>4.例如处理login的post请求，如下示例</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">app.post(&apos;/login&apos;,function(req,res)&#123;</div><div class="line"> </div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<p>了解了post方法，下面我们就开始使用post来实现简单的用户登陆功能。</p>
<h2 id="body基本用法">body基本用法</h2><p>实现登陆之前我们先来了解一个属性 —— body。</p>
<p>body属性解析客户端的post请求参数，通过它可获取请求路径的参数值。</p>
<p>格式：req.body.参数名；</p>
<p>下面我们就来测试body属性的功能，做一些准备工作。</p>
<p>修改login.html，为登陆按钮增加登陆事件。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">&lt;input type=&quot;button&quot; onclick=&quot;login();&quot; value=&quot;登 陆&quot;&gt;</div><div class="line">function login()&#123;</div><div class="line">   var username = $(&apos;#username&apos;).val();</div><div class="line">   var data = &#123; &quot;username&quot;: username &#125;;</div><div class="line">   $.ajax(&#123;</div><div class="line">           url:&apos;/login&apos;,</div><div class="line">           type:&apos;POST&apos;,</div><div class="line">           data:data</div><div class="line">          &#125;);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>要想使用body属性解析post请求参数值，我们需要先安装和引用express的两个中间件body-parser和multer，具体方法如下：。<br>2.1安装</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">npm install body-parser</div><div class="line">npm install multer</div></pre></td></tr></table></figure>
<p>2.2引用和调用</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">var bodyParser = require(&apos;body-parser&apos;);</div><div class="line">var multer = require(&apos;multer&apos;);</div><div class="line">   ......</div><div class="line">app.use(bodyParser.json());</div><div class="line">app.use(bodyParser.urlencoded(&#123; extended: true &#125;));</div><div class="line">app.use(multer());</div></pre></td></tr></table></figure>
<p>中间件body-parser和multer用于处理和解析post请求的数据。</p>
<h2 id="body基本用法(2)">body基本用法(2)</h2><p>到这里我们就可以测试post请求的body属性的简单用法了。</p>
<p>1.修改好之后的完整的文件app.js如下所示：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line">var express = require(&apos;express&apos;);</div><div class="line">var app = express();</div><div class="line">var bodyParser = require(&apos;body-parser&apos;);</div><div class="line">var multer = require(&apos;multer&apos;);</div><div class="line">app.set(&apos;views&apos;, __dirname);</div><div class="line">app.set( &apos;view engine&apos;, &apos;html&apos; );</div><div class="line">app.engine( &apos;.html&apos;, require( &apos;ejs&apos; ).__express );</div><div class="line">app.use(bodyParser.json());</div><div class="line">app.use(bodyParser.urlencoded(&#123; extended: true &#125;));</div><div class="line">app.use(multer());</div><div class="line">app.get(&apos;/&apos;,function(req,res)&#123;</div><div class="line">    res.render(&apos;login&apos;);</div><div class="line">&#125;);</div><div class="line">app.post(&quot;/login&quot;, function(req, res) &#123;</div><div class="line">    console.log(&quot;用户名称为：&quot; + req.body.username);</div><div class="line">&#125;);</div><div class="line">app.listen(8000);</div></pre></td></tr></table></figure>
<p>通过测试地址访问浏览器，试试录入任意一个用户名登录，查看通过body属性是否可以成功获取？</p>
<h2 id="准备登陆-1">准备登陆</h2><p>接下来我们就开始实现登陆功能，让我们要先做一些准备工作，为相关按钮添加点击事件、链接。</p>
<p>1.修改index.html，增加登陆链接。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">[登 录](login)</div></pre></td></tr></table></figure></p>
<p>2.强化login页面的login方法，实现一个简单的post请求：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line">function login()&#123;</div><div class="line">   var username = $(&apos;#username&apos;).val();</div><div class="line">   var password = $(&apos;#password&apos;).val();</div><div class="line">   var data = &#123; &quot;username&quot;: username, &quot;password&quot;:password&#125;;</div><div class="line">   $.ajax(&#123;</div><div class="line">            url:&apos;login&apos;,</div><div class="line">            type:&apos;POST&apos;,</div><div class="line">            data:data,</div><div class="line">            success:function(data,status)&#123;</div><div class="line">                 if(status == &apos;success&apos;)&#123;</div><div class="line">                     location.href=&apos;home&apos;;</div><div class="line">                   &#125;</div><div class="line">            &#125;,</div><div class="line">            error:function(data,status,e)&#123;</div><div class="line">                 if(status == &quot;error&quot;)&#123;</div><div class="line">                      location.href=&apos;login&apos;;</div><div class="line">                    &#125;</div><div class="line">                  &#125;</div><div class="line">              &#125;);</div><div class="line">      &#125;</div></pre></td></tr></table></figure>
<p>网页模板准备已经就绪，下面我们开始修改启动文件app.js的内容。</p>
<h2 id="准备登陆-2">准备登陆</h2><p>下面我们就开始修改app启动文件的内容。</p>
<p>1.修改post方法，这里假设数据库中用户名的名字为admin、密码为admin。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div></pre></td><td class="code"><pre><div class="line">app.post(&apos;/login&apos;,function(req,res)&#123;</div><div class="line">    var user=&#123;</div><div class="line">        username:&apos;admin&apos;,</div><div class="line">        password:&apos;admin&apos;</div><div class="line">    &#125;</div><div class="line">if(req.body.username==user.username&amp;&amp;req.body.password==user.password)</div><div class="line">    &#123; </div><div class="line">       res.send(200);</div><div class="line">    &#125;else&#123;</div><div class="line">       res.send( 404 );</div><div class="line">    &#125;</div><div class="line">&#125;);</div><div class="line">2.一个完整的启动文件app.js如下所示：</div><div class="line"></div><div class="line">var express = require(&apos;express&apos;);</div><div class="line">var app = express();</div><div class="line">var bodyParser = require(&apos;body-parser&apos;);</div><div class="line">var multer = require(&apos;multer&apos;);</div><div class="line"> </div><div class="line">app.set(&apos;views&apos;, __dirname);</div><div class="line">app.set( &apos;view engine&apos;, &apos;html&apos; );</div><div class="line">app.engine( &apos;.html&apos;, require( &apos;ejs&apos; ).__express );</div><div class="line"> </div><div class="line">app.use(bodyParser.json());</div><div class="line">app.use(bodyParser.urlencoded(&#123; extended: true &#125;));</div><div class="line">app.use(multer());</div><div class="line"> </div><div class="line">app.get(&apos;/&apos;, function(req, res) &#123;</div><div class="line">    res.render(&apos;index&apos;);</div><div class="line">&#125;);</div><div class="line">app.get(&apos;/home&apos;,function(req,res)&#123;</div><div class="line">    res.render(&apos;home&apos;);</div><div class="line">&#125;);</div><div class="line">app.get(&apos;/login&apos;,function(req,res)&#123;</div><div class="line">    res.render(&apos;login&apos;);</div><div class="line">&#125;);</div><div class="line">app.post(&apos;/login&apos;,function(req,res)&#123;</div><div class="line">    var user=&#123;</div><div class="line">        username:&apos;admin&apos;,</div><div class="line">        password:&apos;admin&apos;</div><div class="line">    &#125;</div><div class="line"> if(req.body.username==user.username&amp;&amp;req.body.password==user.password)      &#123;</div><div class="line">      res.send(200);</div><div class="line">   &#125;else&#123;</div><div class="line">      res.send( 404 );</div><div class="line">   &#125;</div><div class="line">&#125;);</div><div class="line"> </div><div class="line">app.listen(80);</div></pre></td></tr></table></figure>
<p>到这里，一个简单的Post登录就完成了，使用浏览器运行本地端口试试效果吧！</p>
<h2 id="访问控制">访问控制</h2><p>简单登陆部分按照我们的求已经完成了，但网站好些并不安全，反复测试我们发现，home.html页面本来是登陆以后才访问的，现在我们不需登陆，直接在浏览器输入也可访问，这样肯定是不能被允许的，那么我们还得再次对登陆功能进行强化。</p>
<p>1.login.html页面增加EJS模板变量&lt;%- message %&gt;保存登陆提示信息。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">...</div><div class="line">    &lt;%- message %&gt;</div><div class="line"># 用户登录</div><div class="line">...</div></pre></td></tr></table></figure>
<p>2.home.html页面，登陆成功后跳转并传入用户名：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"># 恭喜_&lt;%= user.username %&gt;_，登陆成功！</div></pre></td></tr></table></figure>
<p>PS：使用EJS模板变量值使用&lt;%= variable_name %&gt;输出方式，字符串输出时默认经过escape转义编码。 当我们想要输出一些动态生成的HTML标签时可使用&lt;%- variable_nam %&gt;输出方式，这种方式不会被escape转义编码。</p>
<p>3.home.html页面添加退出链接，如下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">[退 出](logout)</div></pre></td></tr></table></figure></p>
<h2 id="访问控制-1">访问控制</h2><p>修改好了模板页，下面开始修改启动文件app.js的内容。</p>
<p>1.安装模块express-session并引用，安装、引用不在讲述。</p>
<p>2.使用新模块进行访问时间限制，如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">var session = require(&apos;express-session&apos;);</div><div class="line">...</div><div class="line">app.use(session(&#123;</div><div class="line">    secret:&apos;secret&apos;,</div><div class="line">    resave:true,</div><div class="line">    saveUninitialized:false,</div><div class="line">    cookie:&#123;</div><div class="line">        maxAge:1000*60*10  //过期时间设置(单位毫秒)</div><div class="line">    &#125;</div><div class="line">&#125;));</div></pre></td></tr></table></figure>
<p>3.app.js文件新增中间件并设置模板变量值，如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">app.use(function(req, res, next)&#123;</div><div class="line">    res.locals.user = req.session.user;</div><div class="line">    var err = req.session.error;</div><div class="line">    res.locals.message = &apos;&apos;;</div><div class="line">    if (err) res.locals.message = &apos;&lt;div style=&quot;margin-bottom: 20px;color:red;&quot;&gt;&apos; + err + &apos;&lt;/div&gt;&apos;;</div><div class="line">    next();</div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<p>res.locals对象保存在一次请求范围内的响应体中的本地变量值。</p>
<p>PS：注意，中间件的放置顺序很重要，等同于执行顺序。而且，中间件必须放在HTTP动词方法之前，否则不会执行。</p>
<p>4.增加logout路径处理(用户登陆退出)和index路径请求处理，如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">app.get(&apos;/logout&apos;, function(req, res)&#123;</div><div class="line">    req.session.user = null;</div><div class="line">    req.session.error = null;</div><div class="line">    res.redirect(&apos;index&apos;);</div><div class="line">&#125;);</div><div class="line">app.get(&apos;/index&apos;, function(req, res) &#123;</div><div class="line">    res.render(&apos;index&apos;);</div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<p>5.修改home路径请求处理，如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">app.get(&apos;/home&apos;,function(req,res)&#123;</div><div class="line">    if(req.session.user)&#123;</div><div class="line">        res.render(&apos;home&apos;);</div><div class="line">    &#125;else&#123;</div><div class="line">        req.session.error = &quot;请先登录&quot;</div><div class="line">        res.redirect(&apos;login&apos;);</div><div class="line">    &#125;</div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<p>5.修改路径为login的Post请求</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">app.post(&apos;/login&apos;,function(req,res)&#123;</div><div class="line">    var user=&#123;</div><div class="line">        username:&apos;admin&apos;,</div><div class="line">        password:&apos;admin&apos;</div><div class="line">    &#125;</div><div class="line"> if(req.body.username==user.username&amp;&amp;req.body.password==user.password)&#123;</div><div class="line">        req.session.user = user;</div><div class="line">        res.send(200);</div><div class="line">    &#125;else&#123;</div><div class="line">        req.session.error = &quot;用户名或密码不正确&quot;;</div><div class="line">        res.send( 404 );</div><div class="line">    &#125;</div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<p>好，全部修改完毕，再次访问测试地址试试效果吧！</p>
<h1 id="路由登陆">路由登陆</h1><h2 id="路由介绍">路由介绍</h2><p>路由 ————为不同的访问路径，指定不同的处理方法。 在app.js中我们指定了app.get、app.post的不同路径的多个路由规则，在实际开发应用中，也会碰到具有多个路由记录的情况，针对这个问题，我们就要对这些路由记录做分开处理，以便于管理。</p>
<p>我们还是在登陆例子的基础上做如下修改。</p>
<p>1.添加三个js文件，名称分别为login、home、logout。</p>
<p>2.login.js文件，添加如下内容：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line">module.exports = function ( app ) &#123;</div><div class="line">    app.get(&apos;/login&apos;,function(req,res)&#123;</div><div class="line">        res.render(&apos;login&apos;);</div><div class="line">    &#125;);</div><div class="line"> </div><div class="line">    app.post(&apos;/login&apos;,function(req,res)&#123;</div><div class="line">        var user=&#123;</div><div class="line">            username:&apos;admin&apos;,</div><div class="line">            password:&apos;admin&apos;</div><div class="line">        &#125;</div><div class="line">        if(req.body.username==user.username&amp;&amp;req.body.password==user.password)&#123;</div><div class="line">            req.session.user = user;</div><div class="line">            res.send(200);</div><div class="line">        &#125;else&#123;</div><div class="line">            req.session.error = &quot;用户名或密码不正确&quot;</div><div class="line">            res.send( 404 );</div><div class="line">        &#125;</div><div class="line">    &#125;);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>3.home.js文件，添加如下内容：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">module.exports = function ( app ) &#123;</div><div class="line">    app.get(&apos;/home&apos;,function(req,res)&#123;</div><div class="line">        if(req.session.user)&#123;</div><div class="line">            res.render(&apos;home&apos;);</div><div class="line">        &#125;else&#123;</div><div class="line">            req.session.error = &quot;请先登录&quot;</div><div class="line">            res.redirect(&apos;login&apos;);</div><div class="line">        &#125;</div><div class="line">    &#125;);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="使用路由2">使用路由2</h2><p>4.logout.js文件，添加如下内容：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">module.exports = function ( app ) &#123;</div><div class="line">    app.get(&apos;/logout&apos;, function(req, res)&#123;</div><div class="line">        req.session.user = null;</div><div class="line">        req.session.error = null;</div><div class="line">        res.redirect(&apos;index&apos;);</div><div class="line">    &#125;);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>5.app.js文件中请求路径为logout、home、login的代码就可以删除了</p>
<p>6.新增的三个文件我们改如何使用呢，很简单，如下所示：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">require(&apos;./login&apos;)(app);</div><div class="line">require(&apos;./home&apos;)(app);</div><div class="line">require(&apos;./logout&apos;)(app);</div></pre></td></tr></table></figure>
<p>对，就是这么简单，我们只需引用路由的目录即可。</p>
<p>到这里我们的用户登陆功能就安全了，现学现用赶快试试效果吧！</p>

          
        
      
    </div>
    
    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
  </section>

  
  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><a class="page-number" href="/page/3/">3</a><a class="extend next" rel="next" href="/page/2/"><i class="fa fa-angle-right"></i></a>
  </nav>



          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      

      <section class="site-overview sidebar-panel  sidebar-panel-active ">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="http://mzeht.com/uploads/avatar.jpg"
               alt="mzeht" />
          <p class="site-author-name" itemprop="name">mzeht</p>
          <p class="site-description motion-element" itemprop="description">学习总结 思考感悟 知识管理</p>
        </div>
        <nav class="site-state motion-element">
          <div class="site-state-item site-state-posts">
            <a href="/archives">
              <span class="site-state-item-count">21</span>
              <span class="site-state-item-name">posts</span>
            </a>
          </div>

          
            <div class="site-state-item site-state-categories">
              <a href="/categories">
                <span class="site-state-item-count">3</span>
                <span class="site-state-item-name">categories</span>
              </a>
            </div>
          

          
            <div class="site-state-item site-state-tags">
              <a href="/tags">
                <span class="site-state-item-count">26</span>
                <span class="site-state-item-name">tags</span>
              </a>
            </div>
          

        </nav>

        
          <div class="feed-link motion-element">
            <a href="/atom.xml" rel="alternate">
              <i class="fa fa-rss"></i>
              RSS
            </a>
          </div>
        

        <div class="links-of-author motion-element">
          
        </div>

        
        

        
        

      </section>

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy; 
  <span itemprop="copyrightYear">2016</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">mzeht</span>
</div>

<div class="powered-by">
  Powered by <a class="theme-link" href="http://hexo.io">Hexo</a>
</div>

<div class="theme-info">
  Theme -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Pisces
  </a>
</div>

        

        
      </div>
    </footer>

    <div class="back-to-top">
      <i class="fa fa-arrow-up"></i>
    </div>
  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  



  
  <script type="text/javascript" src="/vendors/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/vendors/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/vendors/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/vendors/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/vendors/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/vendors/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.0.1"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.0.1"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.0.1"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.0.1"></script>



  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.0.1"></script>



  

  
    
  

  <script type="text/javascript">
    var duoshuoQuery = {short_name:"mzeht"};
    (function() {
      var ds = document.createElement('script');
      ds.type = 'text/javascript';ds.async = true;
      ds.id = 'duoshuo-script';
      ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
      ds.charset = 'UTF-8';
      (document.getElementsByTagName('head')[0]
      || document.getElementsByTagName('body')[0]).appendChild(ds);
    })();
  </script>

  
    
  





  
  
  

  

  
  <script src="https://cdn1.lncld.net/static/js/av-core-mini-0.6.1.js"></script>
  <script>AV.initialize("Xs5aiTlfu7f3IpPWImJpnwgp-gzGzoHsz", "rNSn9trau7MT2M4fUCC0rdva");</script>
  <script>
    function showTime(Counter) {
      var query = new AV.Query(Counter);
      var entries = [];
      var $visitors = $(".leancloud_visitors");

      $visitors.each(function () {
        entries.push( $(this).attr("id").trim() );
      });

      query.containedIn('url', entries);
      query.find()
        .done(function (results) {
          var COUNT_CONTAINER_REF = '.leancloud-visitors-count';

          if (results.length === 0) {
            $visitors.find(COUNT_CONTAINER_REF).text(0);
            return;
          }

          for (var i = 0; i < results.length; i++) {
            var item = results[i];
            var url = item.get('url');
            var time = item.get('time');
            var element = document.getElementById(url);

            $(element).find(COUNT_CONTAINER_REF).text(time);
          }
        })
        .fail(function (object, error) {
          console.log("Error: " + error.code + " " + error.message);
        });
    }

    function addCount(Counter) {
      var $visitors = $(".leancloud_visitors");
      var url = $visitors.attr('id').trim();
      var title = $visitors.attr('data-flag-title').trim();
      var query = new AV.Query(Counter);

      query.equalTo("url", url);
      query.find({
        success: function(results) {
          if (results.length > 0) {
            var counter = results[0];
            counter.fetchWhenSave(true);
            counter.increment("time");
            counter.save(null, {
              success: function(counter) {
                var $element = $(document.getElementById(url));
                $element.find('.leancloud-visitors-count').text(counter.get('time'));
              },
              error: function(counter, error) {
                console.log('Failed to save Visitor num, with error message: ' + error.message);
              }
            });
          } else {
            var newcounter = new Counter();
            newcounter.set("title", title);
            newcounter.set("url", url);
            newcounter.set("time", 1);
            newcounter.save(null, {
              success: function(newcounter) {
                var $element = $(document.getElementById(url));
                $element.find('.leancloud-visitors-count').text(newcounter.get('time'));
              },
              error: function(newcounter, error) {
                console.log('Failed to create');
              }
            });
          }
        },
        error: function(error) {
          console.log('Error:' + error.code + " " + error.message);
        }
      });
    }

    $(function() {
      var Counter = AV.Object.extend("Counter");
      if ($('.leancloud_visitors').length == 1) {
        addCount(Counter);
      } else if ($('.post-title-link').length > 1) {
        showTime(Counter);
      }
    });
  </script>



  

</body>
</html>
